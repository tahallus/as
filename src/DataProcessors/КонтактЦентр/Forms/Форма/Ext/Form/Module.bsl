
#Область ОписаниеПеременных

&НаКлиенте
Перем ТекущийЭлементЦвета; // текущий цвет картинки календаря

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
		
	ВосстановитьНастройки();
	ПрочитатьДоступныеКалендари();
	НастроитьВидимостьГруппыСинхронизировать();
	
	ОбновитьЭлементыДосок();
	ОбновитьЭлементыТекущейДоски();
	ОбновитьДанныеПланировщикаИЗадачиНаВесьДень();
	
	УстановитьОтборПоРазрешеннымИсточникам();
	УстановитьОтборПоЗавершенным();
	УстановитьОтборПоКалендарю();
	УстановитьОтборПоТекущейДате();
	
	УправлениеФормой();
	
	УстановитьЗаголовокГруппыОтборов();
	УстановитьУсловноеОформлениеНаВесьДень();
	УстановитьУсловноеОформлениеПоСостояниямСобытий();
	
	УстановитьОтборВходящегоПоОтветственнымИИсточнику();
	НастроитьФормуМобильныйКлиент();

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	КонтактЦентрКлиент.ПодключитьУдалениеОбсужденийИзВходящего();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	Если ИсточникВыбора.ИмяФормы = "Обработка.КонтактЦентр.Форма.НастройкаВходящего" Тогда
		
		Если ВыбранноеЗначение <> Неопределено Тогда
			ЗаполнитьЗначенияСвойств(НастройкиОтображения, ВыбранноеЗначение);
			СохранитьНастройкиИОбновитьДанныеПланировщикаСервер();
		КонецЕсли;
		
	ИначеЕсли ИсточникВыбора.ИмяФормы = "ОбщаяФорма.ВыборЦвета" Тогда
		
		Если ТекущийЭлементЦвета <> Неопределено Тогда
			
			ТекущийЭлементЦвета.Картинка = РаботаСЦветомКлиентСервер.КартинкаЦветаПоНомеруКартинки(ВыбранноеЗначение);
			
			Индекс = ИндексЭлемента(ТекущийЭлементЦвета.Имя);
			ТекКалендарь = ДоступныеКалендари[Индекс];
			ТекКалендарь.ВариантЦвета = ВыбранноеЗначение;		
			
			Если ТекКалендарь.Выбран Тогда
				СохранитьНастройкиИОбновитьДанныеПланировщикаСервер();
			КонецЕсли;
			
		КонецЕсли;
	ИначеЕсли ИсточникВыбора.ИмяФормы = "Справочник.КалендариСотрудников.Форма.ФормаЭлемента" Тогда
		
		ТекущаяДоска = ВыбранноеЗначение;
		НайденнаяДоска = ДоступныеКалендари.НайтиСтроки(Новый Структура("Календарь", ТекущаяДоска));
		НайденнаяДоска[0].Выбран = Истина;
		
		ОбновитьЭлементыДосокПослеВыбора();
		
	ИначеЕсли ИсточникВыбора.ИмяФормы = "Документ.ЗадачаСотрудника.Форма.ФормаДокумента"
		ИЛИ ИсточникВыбора.ИмяФормы = "Документ.Событие.Форма.ФормаСобытия"
		ИЛИ ИсточникВыбора.ИмяФормы = "Документ.ЗаданиеНаРаботу.Форма.ФормаДокумента" Тогда
		
		ОбновитьТекущийЭлементСписка(ВыбранноеЗначение);
		
	Иначе
		Возврат;
	КонецЕсли;
	
	ОчиститьВыделенныеСтроки();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если (ИмяСобытия = "Запись_ИсточникЗаписейКалендаряСотрудника"
		Или ИмяСобытия = "Запись_ЗаписиКалендаряПодготовкиОтчетности") Тогда
		
		УстановитьОтборПоРазрешеннымИОбновитьДанныеТекущегоВидаКонтактЦентр();
		
	ИначеЕсли ИмяСобытия = "Запись_КалендарьСотрудника" Тогда
		
		ОбработатьЗаписьКалендаряСервер();
		
	ИначеЕсли ИмяСобытия = "ОчиститьСеансовыеДанные" Тогда
		
		СеансовыеДанные = Новый Структура;
		
	ИначеЕсли ИмяСобытия = "Запись_ЗадачаСотрудника" Тогда
		
		ОбновитьДанныеВсехВидовКонтактЦентра();
	ИначеЕсли ИмяСобытия = "Запись_ЗаказПокупателя" 
		ИЛИ ИмяСобытия = "Запись_ЗаказПокупателя" Тогда
		
		ОбновитьВходящее();
		
	ИначеЕсли ИмяСобытия = "Запись_КолонкиКалендаряСотрудника"
		ИЛИ  ИмяСобытия = "ИзменениеПорядка_КолонкиКалендаряСотрудника" Тогда
		
		ОбновитьЭлементыТекущейДоски();
		
	ИначеЕсли ИмяСобытия = "Запись_КонтактЦентрВходящее" Тогда
		
		ОбновитьДанныеТекущегоВидаКонтактЦентра();
	Иначе
		
		Возврат;
		
	КонецЕсли;
	
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	Если ЗавершениеРаботы Тогда
		Возврат;
	КонецЕсли;
	// УНФ.ОтборыСписка
	СохранитьНастройкиОтборов();
	// Конец УНФ.ОтборыСписка
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ДекорацияЗакрытьПодсказкуДоскиНажатие(Элемент)
	ОтображатьПодсказкуДоски = Ложь;
	Элементы.ГруппаПодсказкаЦели.Видимость = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияГиперссылкаНетКаналовНажатие(Элемент)
	
	Настройки = Новый Структура;
	Настройки.Вставить("ТекущаяДоска", ТекущаяДоска);
	Настройки.Вставить("НастройкиОтображенияКалендаря", НастройкиОтображения);
	Настройки.Вставить("ВидКонтактЦентра", ВидыКонтактЦентра);
	
	ОткрытьФорму("Обработка.КонтактЦентр.Форма.НастройкаВходящего", Настройки, ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияНетПодключенныхКаналовНажатие(Элемент)
	
	Настройки = Новый Структура;
	Настройки.Вставить("ТекущаяДоска", ТекущаяДоска);
	Настройки.Вставить("НастройкиОтображенияКалендаря", НастройкиОтображения);
	Настройки.Вставить("ВидКонтактЦентра", ВидыКонтактЦентра);
	
	ОткрытьФорму("Обработка.КонтактЦентр.Форма.НастройкаВходящего", Настройки, ЭтотОбъект);

КонецПроцедуры

&НаКлиенте
Процедура ПредставлениеПериодаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	РаботаСОтборамиКлиент.ПредставлениеПериодаВыбратьПериод(ЭтотОбъект, "ВРаботе", "Начало");
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборТегиОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если Не ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		Возврат;
	КонецЕсли;
	УстановитьМеткуИОтборСписка("Теги.Тег", Элемент.Родитель.Имя, ВыбранноеЗначение);
	ВыбранноеЗначение = Неопределено;
	ОчиститьВыделенныеСтроки();
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборОтветственныйОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Если НЕ ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		Возврат;
	КонецЕсли;
	УстановитьМеткуИОтборСписка("Ответственный", Элемент.Родитель.Имя, ВыбранноеЗначение);
	ВыбранноеЗначение = Неопределено;
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ОтборЗавершенныеПриИзменении(Элемент)
	УстановитьОтборПоЗавершеннымИУправлениеФормой();
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ВариантПериодаПриИзменении(Элемент)
	
	ВыделитьДатыОтображения(ЭтотОбъект);
	УстановитьПредставлениеПериода(ЭтотОбъект);
	Элементы.ДатаОтображения.Обновить();
	
	СохранитьНастройкиИОбновитьДанныеПланировщикаСервер();
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ДатаОтображенияПриИзменении(Элемент)
	
	ПодключитьОбработчикОжидания("ОбновитьДанныеПланировщикаКлиент", 0.2, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаОтображенияПриАктивизацииДаты(Элемент)
	
	ВыделитьДатыОтображения(ЭтотОбъект);
	УстановитьПредставлениеПериода(ЭтотОбъект);
	Элементы.ДатаОтображения.Обновить();
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаВесьДеньКалендарьВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ВыбраннаяЗадача = Новый Структура("Ссылка", Элемент.ТекущиеДанные.Задача);
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяЗадача);
	
КонецПроцедуры

&НаКлиенте
Процедура ФильтрБезСрокаПриИзменении(Элемент)
	ЗаполнитьЗадачиНаВесьДеньКалендарь();
КонецПроцедуры

&НаКлиенте
Процедура ФильтрПросроченоПриИзменении(Элемент)
	ЗаполнитьЗадачиНаВесьДеньКалендарь();
КонецПроцедуры

#Область Планировщик

&НаСервере
Процедура ЗаполнитьЗадачиНаВесьДеньКалендарь()
	
	ЗадачиНаВесьДеньКалендарь.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗаписиКалендаряСотрудника.Источник КАК Источник,
	|	ЗаписиКалендаряСотрудника.Календарь КАК Календарь,
	|	ЗаписиКалендаряСотрудника.Начало КАК ДатаНачала,
	|	ЗаписиКалендаряСотрудника.Окончание КАК ДатаОкончания,
	|	ЗаписиКалендаряСотрудника.Наименование КАК Наименование,
	|	ЗаписиКалендаряСотрудника.Описание КАК Содержание,
	|	ЗаписиКалендаряСотрудника.ОтветственныйИсточника КАК Ответственный,
	|	ЗаписиКалендаряСотрудника.Завершено КАК Состояние
	|ПОМЕСТИТЬ ВТ_Источники
	|ИЗ
	|	Справочник.ЗаписиКалендаряСотрудника КАК ЗаписиКалендаряСотрудника
	|ГДЕ
	|	ЗаписиКалендаряСотрудника.ПометкаУдаления = ЛОЖЬ
	|	И ЗаписиКалендаряСотрудника.Календарь В(&ВыбранныеКалендари)
	|	И ЗаписиКалендаряСотрудника.Источник <> НЕОПРЕДЕЛЕНО
	|	И ЗаписиКалендаряСотрудника.Источник В(&РазрешенныеИсточники)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Источники.Источник КАК Ссылка,
	|	"""" КАК СостояниеИсточника,
	|	ВТ_Источники.Состояние КАК Состояние,
	|	0 КАК Картинка,
	|	ВТ_Источники.Содержание КАК Содержание,
	|	"""" КАК Основание,
	|	ВТ_Источники.Ответственный КАК Ответственный,
	|	ВТ_Источники.Наименование КАК Наименование,
	|	ВТ_Источники.ДатаНачала КАК Начало,
	|	ВТ_Источники.ДатаНачала КАК ДатаСоздания,
	|	ВТ_Источники.ДатаОкончания КАК Окончание,
	|	ВТ_Источники.Календарь КАК Календарь,
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(15)) КАК Отступ,
	|	0 КАК КартинкаКалендаря,
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(30)) КАК ДатаОбъединенная,
	|	Задачи.Теги.(
	|		"""" КАК Тег
	|	) КАК Теги
	|ИЗ
	|	ВТ_Источники КАК ВТ_Источники
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗадачаСотрудника КАК Задачи
	|		ПО (Задачи.Ссылка = ВТ_Источники.Источник)
	|ГДЕ
	|	(НЕ ВТ_Источники.Состояние
	|			И &ОтборПоЗавершенным
	|		ИЛИ ИСТИНА
	|			И НЕ &ОтборПоЗавершенным)
	|	И ((ВТ_Источники.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|	И ВТ_Источники.ДатаНачала <= &ДатаОкончания
	|	И ВТ_Источники.ДатаНачала >= &ДатаНачала) 
	|	ИЛИ (&ФильтрПросрочено И ВТ_Источники.ДатаОкончания <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 
	|	И ВТ_Источники.ДатаОкончания < &ТекущаяДатаСеанса))"
	+ СтрокаФильтровКалендарь("ВТ_Источники.Ответственный", "Состояние", Ложь) +
	"ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Задачи.Ссылка,
	|	ВЫБОР
	|		КОГДА Задачи.Выполнена
	|			ТОГДА ""Выполнена""
	|		ИНАЧЕ ""Завершена""
	|	КОНЕЦ,
	|	Задачи.Выполнена,
	|	6,
	|	"""",
	|	Задачи.Основание,
	|	Задачи.Ответственный,
	|	ВЫРАЗИТЬ(Задачи.Описание КАК СТРОКА(1000)),
	|	Задачи.ДатаНачала,
	|	Задачи.Дата,
	|	Задачи.ДатаОкончания,
	|	Задачи.Календарь,
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(15)),
	|	0,
	|	ВЫРАЗИТЬ("""" КАК СТРОКА(50)),
	|	Задачи.Теги.(
	|		Тег
	|	)
	|ИЗ
	|	Документ.ЗадачаСотрудника КАК Задачи
	|ГДЕ
	|	Задачи.ПометкаУдаления = ЛОЖЬ
	|	И Задачи.Календарь В(&ВыбранныеКалендари)
	|	И (НЕ Задачи.Выполнена
	|			И &ОтборПоЗавершенным
	|		ИЛИ ИСТИНА
	|			И НЕ &ОтборПоЗавершенным)
	|	И ((Задачи.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|	И Задачи.ДатаНачала <= &ДатаОкончания
	|	И Задачи.ДатаНачала >= &ДатаНачала 
	|	ИЛИ (&ФильтрБезСрока И Задачи.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 
	|	И Задачи.ДатаНачала = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)))
	|	ИЛИ (&ФильтрПросрочено И Задачи.ДатаОкончания <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) 
	|	И Задачи.ДатаОкончания < &ТекущаяДатаСеанса))" 
	+ СтрокаФильтровКалендарь("Ответственный", "Выполнена", Истина) +
	" УПОРЯДОЧИТЬ ПО
	|	Начало, ДатаСоздания УБЫВ";
	
	ВыбранныеКалендари = Новый Массив;
	Для Каждого Календарь Из ДоступныеКалендари Цикл
		Если НЕ Календарь.Выбран Тогда 
			Продолжить;
		КонецЕсли;
		ВыбранныеКалендари.Добавить(Календарь.Календарь);
	КонецЦикла;

	РазрешенныеИсточники = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточникиКалендаря, "Источник");
	Запрос.УстановитьПараметр("ТекущаяДатаСеанса", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ВыбранныеКалендари", ВыбранныеКалендари);
	ПериодДанных = ПолучитьПериодДанных(ВариантПериода, ДатаОтображения);
	Запрос.УстановитьПараметр("ДатаНачала", ПериодДанных.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", ПериодДанных.ДатаОкончания);
	Запрос.УстановитьПараметр("ФильтрБезСрока", ФильтрБезСрока);
	Запрос.УстановитьПараметр("ФильтрПросрочено", ФильтрПросрочено);
	Запрос.УстановитьПараметр("ТекущаяДатаСеанса", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ОтборПоЗавершенным", НЕ ОтборЗавершенные);
	Запрос.УстановитьПараметр("РазрешенныеИсточники", РазрешенныеИсточники);
	
	УстановитьПараметрыФильтров(Запрос);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		НоваяСтрока = ЗадачиНаВесьДеньКалендарь.Добавить();
		НоваяСтрока.Задача = Выборка.Ссылка;

		Если ЗначениеЗаполнено(Выборка.Окончание) И Выборка.Окончание < ТекущаяДатаСеанса() Тогда
			НоваяСтрока.Просрочено = 1;
		КонецЕсли;
		
		Если ВариантПериода = "День" ИЛИ НЕ ЗначениеЗаполнено(Выборка.Начало) Тогда
			Если ЗначениеЗаполнено(Выборка.Окончание) Тогда
				НоваяСтрока.ДатаСтрокой = Формат(Выборка.Начало, НСтр("ru = ' ДФ =''ддд, д ММММ'''"));
			КонецЕсли;
			НоваяСтрока.Представление = Выборка.Наименование;
		ИначеЕсли (ВариантПериода = "Неделя" ИЛИ ВариантПериода = "Месяц") И ЗначениеЗаполнено(Выборка.Начало) Тогда
			НоваяСтрока.ДатаСтрокой = Формат(Выборка.Начало, НСтр("ru = ' ДФ =''ддд, д ММММ'''"));
			НоваяСтрока.Представление = Выборка.Наименование;
		Иначе
			НоваяСтрока.Представление = Выборка.Наименование;
		КонецЕсли;
		
		НайденныеСтроки = ДоступныеКалендари.НайтиСтроки(Новый Структура("Календарь", Выборка.Календарь));
		
		Если НайденныеСтроки.Количество() > 0 Тогда
			НоваяСтрока.ВариантЦвета = НайденныеСтроки[0].ВариантЦвета;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПередСозданием(Элемент, Начало, Конец, Значения, Текст, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗначенияЗаполнения = Новый Структура;
	ЗначенияЗаполнения.Вставить("Начало", Начало);
	ЗначенияЗаполнения.Вставить("Окончание", Конец);
	ВыбранныеКалендари = ДоступныеКалендари.НайтиСтроки(Новый Структура("Выбран", Истина));
	Если ВыбранныеКалендари.Количество() = 1 Тогда
		ЗначенияЗаполнения.Вставить("Календарь", ВыбранныеКалендари[0].Календарь);
	КонецЕсли;
	
	СоздатьДело(ЗначенияЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПриОкончанииРедактирования(Элемент, НовыйЭлемент, ОтменаРедактирования)
	
	ОбрабатываемыеЭлементы = Новый Массив;
	
	Для Каждого ВыделенныйЭлемент Из Элемент.ВыделенныеЭлементы Цикл
		
		Если ВыделенныйЭлемент.Значение.РедактированиеЗапрещено Тогда
			ОтменаРедактирования = Истина;
			Возврат;
		КонецЕсли;
		
		ОбрабатываемыйЭлемент = Новый Структура;
		
		Если ТипЗнч(ВыделенныйЭлемент.Значение.ЗаписьКалендаря) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			ОбрабатываемыйЭлемент.Вставить("Источник", ВыделенныйЭлемент.Значение.ЗаписьКалендаря);
		Иначе
			ОбрабатываемыйЭлемент.Вставить("Источник", ВыделенныйЭлемент.Значение.Источник);
		КонецЕсли;
		
		ОбрабатываемыйЭлемент.Вставить("ЗаписьКалендаря", 		ВыделенныйЭлемент.Значение.ЗаписьКалендаря);
		ОбрабатываемыйЭлемент.Вставить("НомерСтрокиИсточника",	ВыделенныйЭлемент.Значение.НомерСтрокиИсточника);
		ОбрабатываемыйЭлемент.Вставить("Начало",				ВыделенныйЭлемент.Начало);
		ОбрабатываемыйЭлемент.Вставить("Конец",					ВыделенныйЭлемент.Конец);
		
		ОбрабатываемыеЭлементы.Добавить(ОбрабатываемыйЭлемент);
		
	КонецЦикла;
	
	ОтменаРедактирования = Не СохранитьИзмененияВБазу(ОбрабатываемыеЭлементы);
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПередНачаломРедактирования(Элемент, НовыйЭлемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ОткрытьФормуТекущегоЭлементаПланировщика();
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПередУдалением(Элемент, Отказ)
	
	ОбрабатываемыеЭлементы = Новый Массив;
	
	Для Каждого ВыделенныйЭлемент Из Элемент.ВыделенныеЭлементы Цикл
		
		Если ВыделенныйЭлемент.Значение.РедактированиеЗапрещено Тогда
			Отказ = Истина;
			Возврат;
		КонецЕсли;
		
		ОбрабатываемыйЭлемент = Новый Структура;
		ОбрабатываемыйЭлемент.Вставить("ЗаписьКалендаря",		ВыделенныйЭлемент.Значение.ЗаписьКалендаря);
		Если ТипЗнч(ВыделенныйЭлемент.Значение.ЗаписьКалендаря) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			ОбрабатываемыйЭлемент.Вставить("Источник", ВыделенныйЭлемент.Значение.ЗаписьКалендаря);
		Иначе
			ОбрабатываемыйЭлемент.Вставить("Источник", ВыделенныйЭлемент.Значение.Источник);
		КонецЕсли;
		ОбрабатываемыйЭлемент.Вставить("НомерСтрокиИсточника",	ВыделенныйЭлемент.Значение.НомерСтрокиИсточника);
		ОбрабатываемыйЭлемент.Вставить("ПометкаУдаления",		Истина);
		
		ОбрабатываемыеЭлементы.Добавить(ОбрабатываемыйЭлемент);
		
	КонецЦикла;
	
	Если НЕ СохранитьИзмененияВБазу(ОбрабатываемыеЭлементы) Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПриСменеТекущегоПериодаОтображения(Элемент, ТекущиеПериодыОтображения, СтандартнаяОбработка)
	
	Если ВариантПериода = "Месяц" Тогда
		
		СтандартнаяОбработка = Ложь;
		ТекущаяДатаСеанса = ОбщегоНазначенияКлиент.ДатаСеанса();
		
		Если ТекущиеПериодыОтображения[0].Начало = НачалоДня(ТекущаяДатаСеанса) Тогда
			ДатаОтображения = ТекущаяДатаСеанса;
		ИначеЕсли ТекущиеПериодыОтображения[0].Начало < Планировщик.ТекущиеПериодыОтображения[0].Начало Тогда
			ДатаОтображения = ДобавитьМесяц(ДатаОтображения, -1);
		ИначеЕсли ТекущиеПериодыОтображения[0].Начало > Планировщик.ТекущиеПериодыОтображения[0].Начало Тогда
			ДатаОтображения = ДобавитьМесяц(ДатаОтображения, 1);
		КонецЕсли;
		
		ПериодДанных = ПолучитьПериодДанных(ВариантПериода, ДатаОтображения);
		Планировщик.ТекущиеПериодыОтображения.Очистить();
		Планировщик.ТекущиеПериодыОтображения.Добавить(ПериодДанных.ДатаНачала, ПериодДанных.ДатаОкончания);
		
		Планировщик.ИнтервалыФона.Очистить();
		Интервал = Планировщик.ИнтервалыФона.Добавить(НачалоМесяца(ДатаОтображения), КонецМесяца(ДатаОтображения));
		Интервал.Цвет = Новый Цвет(250, 250, 250);
		Если НастройкиОтображения.ОтображатьТекущуюДату Тогда
			Интервал = Планировщик.ИнтервалыФона.Добавить(НачалоДня(ТекущаяДатаСеанса), КонецДня(ТекущаяДатаСеанса));
			Интервал.Цвет = Новый Цвет(223, 255, 223);
		КонецЕсли;
		
	Иначе
		
		ДатаОтображения = ТекущиеПериодыОтображения[0].Начало;
		
	КонецЕсли;
	
	ВыделитьДатыОтображения(ЭтотОбъект);
	УстановитьПредставлениеПериода(ЭтотОбъект);
	Элементы.ДатаОтображения.Обновить();
	ПодключитьОбработчикОжидания("ОбновитьДанныеПланировщикаКлиент", 0.2, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПередНачаломБыстрогоРедактирования(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ОткрытьФормуТекущегоЭлементаПланировщика();
	
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Дата, Значения)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Дата, Значения)
	
	Если ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗначенияЗаполнения = Новый Структура;
	ЗначенияЗаполнения.Вставить("Основание", ПараметрыПеретаскивания.Значение.Источник);
	
	ДанныеКалендаря = Новый Структура;
	ДанныеКалендаря.Вставить("Начало", НачалоЧаса(Дата));
	ДанныеКалендаря.Вставить("Окончание", КонецЧаса(Дата) + 1);
	ДанныеКалендаря.Вставить("Описание", "");
	
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("ЗначенияЗаполнения", ЗначенияЗаполнения);
	ПараметрыЗадачи.ЗначенияЗаполнения.Вставить("ДанныеЗаписиКалендаря", ДанныеКалендаря);
	ПараметрыЗадачи.Вставить("СозданиеЗадачиКонтактЦентр", Истина);
	
	ОткрытьФорму("Документ.ЗадачаСотрудника.Форма.ФормаДокумента", ПараметрыЗадачи);
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура Подключаемый_ВыбранКалендарьПриИзменении(Элемент)
	
	ВидКалендарь = 2;
	
	Если ВидыКонтактЦентра = ВидКалендарь Тогда
		СохранитьНастройкиИОбновитьДанныеПланировщикаСервер();
		Возврат;
	КонецЕсли;
	
	УстановитьОтборПоКалендарюИПоРазрешеннымИсточникам();
	ОчиститьВыделенныеСтроки();
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ЦветКалендарьНажатие(Элемент)
	
	ТекущийЭлементЦвета = Элемент;
	ОткрытьФорму("ОбщаяФорма.ВыборЦвета", , ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидыКонтактЦентраПриИзменении(Элемент)
	УправлениеФормой();
	НастроитьФормуМобильныйКлиент();
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыВходящее

&НаСервереБезКонтекста
Процедура ВходящееПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	Для Каждого КлючИЗначение Из Строки Цикл
		
		Если ТипЗнч(КлючИЗначение.Ключ.Источник) = Тип("ДокументСсылка.Событие") Тогда
			
			Реквизиты = "ТипСобытия,Участники,Тема,Содержание,УчетнаяЗапись";
			РеквизитыСобытия = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(КлючИЗначение.Ключ.Источник, Реквизиты);
			ЗаполнитьДанныеВходящегоСобытия(КлючИЗначение, РеквизитыСобытия);
			
		КонецЕсли;
		
		Если ТипЗнч(КлючИЗначение.Ключ.Источник) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
			Реквизиты = "Контрагент,Комментарий";
			РеквизитыЗаказа = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(КлючИЗначение.Ключ.Источник, Реквизиты);
			ЗаполнитьДанныеЗаказа(КлючИЗначение, РеквизитыЗаказа);
		КонецЕсли;
		
		Если ТипЗнч(КлючИЗначение.Ключ.Источник) = Тип("Строка") Тогда
			КлючИЗначение.Значение.Данные.ПерваяСтрока = СтрШаблон(НСтр("ru ='Новое сообщение %1'"), 
				КлючИЗначение.Значение.Данные.ТипВнешнейСистемы);
			КлючИЗначение.Значение.Данные.ТретьяСтрока = СтрШаблон(НСтр("ru = 'от: %1'"), 
				КлючИЗначение.Значение.Данные.ОтКого);
			КлючИЗначение.Значение.Данные.ПятаяСтрока = КлючИЗначение.Значение.Данные.Ответственный;
			КлючИЗначение.Значение.Данные.ЧетвертаяСтрока = КлючИЗначение.Значение.Данные.Описание;
			КлючИЗначение.Значение.Данные.ТипПоля = ?(КлючИЗначение.Значение.Данные.ТипВнешнейСистемы = "Telegram", 0, 1);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьДанныеВходящегоСобытия(КлючИЗначение, РеквизитыСобытия)
	
	МассивУчастники = Новый Массив;
	Участники = РеквизитыСобытия.Участники.Выгрузить();
	Для Каждого Участник Из Участники Цикл
		МассивУчастники.Добавить(Строка(Участник.Контакт));
	КонецЦикла;
	
	Если РеквизитыСобытия.ТипСобытия = Перечисления.ТипыСобытий.ЭлектронноеПисьмо Тогда
		КлючИЗначение.Значение.Данные.ПерваяСтрока = СтрШаблон(НСтр("ru = 'от : %1'"), 
			СтрСоединить(МассивУчастники, ";"));
		КлючИЗначение.Значение.Данные.ВтораяСтрока = Строка(РеквизитыСобытия.УчетнаяЗапись);
		КлючИЗначение.Значение.Данные.ТретьяСтрока = РеквизитыСобытия.Тема;
		КлючИЗначение.Значение.Данные.ЧетвертаяСтрока = РеквизитыСобытия.Содержание;
		КлючИЗначение.Значение.Данные.ПятаяСтрока = КлючИЗначение.Ключ.Ответственный;
		КлючИЗначение.Значение.Данные.ТипПоля = 2;
		Возврат;
	КонецЕсли;
	
	Если РеквизитыСобытия.ТипСобытия = Перечисления.ТипыСобытий.ТелефонныйЗвонок Тогда
		КлючИЗначение.Значение.Данные.ПерваяСтрока = НСтр("ru='Пропущенный звонок'");
		КлючИЗначение.Значение.Данные.ВтораяСтрока = СтрШаблон(НСтр("ru = 'от : %1'"), 
			СтрСоединить(МассивУчастники, ";"));
		КлючИЗначение.Значение.Данные.ПятаяСтрока = КлючИЗначение.Ключ.Ответственный;
		КлючИЗначение.Значение.Данные.ТипПоля = 3;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьДанныеЗаказа(КлючИЗначение, РеквизитыЗаказа)
	КлючИЗначение.Значение.Данные.ПерваяСтрока = Строка(КлючИЗначение.Значение.Данные.Источник);
	КлючИЗначение.Значение.Данные.ВтораяСтрока = Строка(РеквизитыЗаказа.Контрагент);
	КлючИЗначение.Значение.Данные.ТретьяСтрока = Строка(РеквизитыЗаказа.Комментарий);
	КлючИЗначение.Значение.Данные.ПятаяСтрока = КлючИЗначение.Значение.Данные.Ответственный;
	КлючИЗначение.Значение.Данные.ТипПоля = 4;
КонецПроцедуры

&НаКлиенте
Процедура ВходящееПриАктивизацииЯчейки(Элемент)
	
	Если Элемент.ТекущийЭлемент.Имя = "ВходящееКартинкаПеренаправить" Тогда
		
		ДополнительныеПараметры = Новый Структура();
		ДополнительныеПараметры.Вставить("Источник", Элемент.ТекущаяСтрока.Источник);
		ДополнительныеПараметры.Вставить("Список", "Входящее");
		ОповещениеОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного", ЭтотОбъект, ДополнительныеПараметры);
			
		ПараметрыВыбора = Новый Структура("РежимВыбора", Истина);
		ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора", ПараметрыВыбора, , , , , ОповещениеОЗакрытии);
		Элемент.ТекущийЭлемент = Элементы.ВходящееПерваяСтрока;
		
	ИначеЕсли Элемент.ТекущийЭлемент.Имя = "ВходящееКартинкаКоманды" Тогда
		
		Элемент.ТекущийЭлемент = Элементы.ВходящееПерваяСтрока;
		УдалитьСтрокуВходящегоИзРегистра(Элемент.ТекущаяСтрока.Источник, Элемент.ТекущаяСтрока.Ответственный);
		Элемент.ТекущаяСтрока = Неопределено;
		
	Иначе
		Элемент.ТекущийЭлемент = Элементы.ВходящееПерваяСтрока;
	КонецЕсли;
	
	Элементы.Входящее.ВыделенныеСтроки.Очистить();
	
КонецПроцедуры

&НаКлиенте
Процедура ВходящееВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ПараметрыВходящего = Новый Структура;
	ПараметрыВходящего.Вставить("Ключ", Элемент.ТекущиеДанные.Источник);
	
	Если ТипЗнч(Элемент.ТекущиеДанные.Источник) = Тип("Строка") Тогда
		
		СсылкаОбсуждения = Новый ИдентификаторОбсужденияСистемыВзаимодействия(Элемент.ТекущиеДанные.Источник);
		ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку(ПолучитьНавигационнуюСсылку(СсылкаОбсуждения));
		
	ИначеЕсли ТипЗнч(Элемент.ТекущиеДанные.Источник) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		
		ОткрытьФорму("Документ.ЗаказПокупателя.ФормаОбъекта", ПараметрыВходящего);
		
	ИначеЕсли ТипЗнч(Элемент.ТекущиеДанные.Источник) = Тип("ДокументСсылка.Событие") Тогда
		
		ОткрытьФорму("Документ.Событие.ФормаОбъекта", ПараметрыВходящего);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВходящееНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВидКалендарь = 2;
	
	Если ВидыКонтактЦентра <> ВидКалендарь Тогда
		СтруктураПеретаскивания = Новый Структура;
		СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Источник);
		СтруктураПеретаскивания.Вставить("Список", "Входящее");
		СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
		Если Элемент.ТекущиеДанные <> Неопределено И Элемент.ТекущиеДанные.Свойство("Описание") Тогда
			СтруктураПеретаскивания.Вставить("Описание", Элемент.ТекущиеДанные.Описание);
		КонецЕсли;
		ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыВРаботе

&НаКлиенте
Процедура ВРаботеВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ВРаботеПриАктивизацииЯчейки(Элемент)
	
	Элементы.ВРаботеКонтекстноеМенюЗавершитьЗадачу.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ВРаботеКонтекстноеМенюИзменить.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ВРаботеКонтекстноеМенюПеренаправить.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ВРаботеКонтекстноеУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
	
	Элементы.ВРаботе.ТекущийЭлемент = Элементы.ВРаботеНаименование;
	Элементы.ВРаботеКонтекстноеУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ВРаботеКонтекстноеМенюЗавершитьЗадачу.Видимость = ЭтоЗадача;
	Элементы.ВРаботеКонтекстноеМенюПеренаправить.Видимость = НЕ ЭтоЗаказ;
	
	Элементы.ВРаботе.ВыделенныеСтроки.Очистить(); 
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ВРаботеПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
		"ДоступныеКалендари",
		Новый ТаблицаЗначений);
		
	УстановитьПривилегированныйРежим(Истина);
	
	Для Каждого КлючИЗначение Из Строки Цикл
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало,
			КлючИЗначение.Значение.Данные.Окончание,
			"ВРаботе");
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.ЗадачаПросрочена = ЗадачаПросрочена(КлючИЗначение.Значение.Данные.Начало,
			КлючИЗначение.Значение.Данные.Окончание);
		Если НайденнаяСтрока = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ВРаботеНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("Список", "ВРаботе");
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
КонецПроцедуры

&НаКлиенте
Процедура ВРаботеПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	СтандартнаяОбработка = Ложь;
	Если ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ОткрытьФормуЗадачи(ПараметрыПеретаскивания.Значение);
	
КонецПроцедуры

&НаКлиенте
Процедура ВРаботеПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

#КонецОбласти 

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиНаСегодня

&НаКлиенте
Процедура ЗадачиНаСегодняПриАктивизацииЯчейки(Элемент)
	
	ЕстьТекущаяСтрока = Элемент.ТекущаяСтрока <> Неопределено;
	
	Элементы.ЗадачиНаСегодняКонтекстноеМенюЗавершитьЗадачуСегодня.Доступность = ЕстьТекущаяСтрока;
	Элементы.ЗадачиНаСегодняКонтекстноеМенюИзменитьСегодня.Доступность = ЕстьТекущаяСтрока;
	Элементы.ЗадачиНаСегодняКонтекстноеМенюПеренаправитьЗадачуНаСегодня.Доступность = ЕстьТекущаяСтрока;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиНаСегодняКонтекстноеМенюГруппаУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;

	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
		
	Элементы.ЗадачиНаСегодняКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиНаСегодняКонтекстноеМенюЗавершитьЗадачуСегодня.Видимость = ЭтоЗадача;
	Элементы.ЗадачиНаСегодняКонтекстноеМенюПеренаправитьЗадачуНаСегодня.Видимость = НЕ ЭтоЗаказ;
	Элементы.ЗадачиНаСегодня.ВыделенныеСтроки.Очистить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗадачиНаСегодняПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание,
			"ЗадачиНаСегодня");
		КлючИЗначение.Значение.Данные.ЗадачаПросрочена = ЗадачаПросрочена(КлючИЗначение.Значение.Данные.Начало,
			КлючИЗначение.Значение.Данные.Окончание);
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаСегодняПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаСегодняНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаСегодняВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаСегодняПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	СтандартнаяОбработка = Ложь;
	ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания, "Сегодня", Элемент.Имя);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиНаЗавтра

&НаКлиенте
Процедура ЗадачиНаЗавтраВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаЗавтраПриАктивизацииЯчейки(Элемент)
	
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюЗавершитьЗадачуЗавтра.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюИзменитьЗавтра.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюПеренаправитьЗадачуНаЗавтра.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиНаЗавтраКонтекстноеМенюГруппаУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;

	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
		
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюЗавершитьЗадачуЗавтра.Видимость = ЭтоЗадача;
	Элементы.ЗадачиНаЗавтраКонтекстноеМенюПеренаправитьЗадачуНаЗавтра.Видимость = НЕ ЭтоЗаказ;
	
	Элементы.ЗадачиНаЗавтра.ВыделенныеСтроки.Очистить();
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗадачиНаЗавтраПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание,
			"ЗадачиНаЗавтра");
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаЗавтраНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаЗавтраПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаЗавтраПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
	ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания, "Завтра", Элемент.Имя);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиБезСрока

&НаКлиенте
Процедура ЗадачиНаНеделеВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиБезСрокаПриАктивизацииЯчейки(Элемент)
	
	Элементы.ЗадачиБезСрокаКонтекстноеМенюЗавершитьЗадачуБезСрока.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиБезСрокаКонтекстноеМенюИзменитьБезСрока.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиБезСрокаКонтекстноеМенюПеренаправитьЗадачуБезСрока.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиБезСрокаКонтекстноеМенюГруппаУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
		
	Элементы.ЗадачиБезСрокаКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиБезСрокаКонтекстноеМенюЗавершитьЗадачуБезСрока.Видимость = ЭтоЗадача;
	Элементы.ЗадачиБезСрокаКонтекстноеМенюПеренаправитьЗадачуБезСрока.Видимость = НЕ ЭтоЗаказ;
	
	Элементы.ЗадачиБезСрока.ВыделенныеСтроки.Очистить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗадачиБезСрокаПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиБезСрокаВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиБезСрокаНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиБезСрокаПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
	ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания, "БезСрока", Элемент.Имя);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиБезСрокаПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиНаНеделе

&НаСервереБезКонтекста
Процедура ЗадачиНаНеделеПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание, "ЗадачиНаНеделе");
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаНеделеПриАктивизацииЯчейки(Элемент)
	
	Элементы.ЗадачиНаНеделеКонтекстноеМенюЗавершитьЗадачуНаНеделе.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиНаНеделеКонтекстноеМенюИзменитьНаНеделе.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиНаНеделеКонтекстноеМенюПеренаправитьЗадачуНаНеделе.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиНаНеделеКонтекстноеМенюГруппаУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
		
	Элементы.ЗадачиНаНеделеКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиНаНеделеКонтекстноеМенюЗавершитьЗадачуНаНеделе.Видимость = ЭтоЗадача;
	Элементы.ЗадачиНаНеделеКонтекстноеМенюПеренаправитьЗадачуНаНеделе.Видимость = НЕ ЭтоЗаказ;
	Элементы.ЗадачиНаНеделе.ВыделенныеСтроки.Очистить(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаНеделеНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаНеделеПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиНаНеделеПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
	ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания, "НаНеделе", Элемент.Имя);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиПозже

&НаКлиенте
Процедура ЗадачиПозжеВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПозжеНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПозжеПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
	ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания, "Позже", Элемент.Имя);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПозжеПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПозжеПриАктивизацииЯчейки(Элемент)
	
	Элементы.ЗадачиПозжеКонтекстноеМенюЗавершитьЗадачуПозже.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ИзменитьПозже.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиПозжеКонтекстноеМенюПеренаправитьЗадачуПозже.Доступность = Элемент.ТекущаяСтрока <> Неопределено;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиПозжеКонтекстноеМенюГруппаУстановитьСостояние.Видимость = Ложь;
		Возврат;
	КонецЕсли;
	
	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
	
	Элементы.ЗадачиПозжеКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиПозжеКонтекстноеМенюЗавершитьЗадачуПозже.Видимость = ЭтоЗадача;
	Элементы.ЗадачиПозжеКонтекстноеМенюПеренаправитьЗадачуПозже.Видимость = НЕ ЭтоЗаказ;
	
	Элементы.ЗадачиПозже.ВыделенныеСтроки.Очистить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗадачиПозжеПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание, "ЗадачиПозже");
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиПросрочены

&НаСервереБезКонтекста
Процедура ЗадачиПросроченыПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);
	
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание, "ЗадачиНаНеделе");
		КлючИЗначение.Значение.Данные.ЗадачаПросрочена = ЗадачаПросрочена(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание);
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		Если НайденнаяСтрока <> Неопределено Тогда
			КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
		КонецЕсли;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);

КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПросроченыПриАктивизацииЯчейки(Элемент)
	
	ЕстьТекущаяСтрока = Элемент.ТекущаяСтрока <> Неопределено;
	Элементы.ЗадачиПросроченыКонтекстноеМенюЗавершитьЗадачуПросрочено.Доступность = ЕстьТекущаяСтрока;
	Элементы.ЗадачиПросроченыКонтекстноеМенюИзменитьЗадачиПросрочены.Доступность = ЕстьТекущаяСтрока;
	Элементы.ЗадачиПросроченыКонтекстноеМенюПеренаправитьЗадачуПросрочена.Доступность = ЕстьТекущаяСтрока;
	
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Элементы.ЗадачиПросроченыКонтекстноеМенюГруппаУстановитьСостояние.Доступность = Ложь;
		Возврат;
	КонецЕсли;
	
	ЭтоЗаказ = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗаказПокупателя");
	ЭтоЗадача = ТипЗнч(Элемент.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника");
	
	Элементы.ЗадачиПросроченыКонтекстноеМенюГруппаУстановитьСостояние.Видимость = НЕ (ЭтоЗаказ ИЛИ ЭтоЗадача);
	Элементы.ЗадачиПросроченыКонтекстноеМенюЗавершитьЗадачуПросрочено.Видимость = ЭтоЗадача;
	Элементы.ЗадачиПросроченыКонтекстноеМенюПеренаправитьЗадачуПросрочена.Видимость = НЕ ЭтоЗаказ;

	Элементы.ЗадачиПросрочены.ВыделенныеСтроки.Очистить(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПросроченыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПросроченыНачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НомерСтрокиИсточника = Элемент.ТекущиеДанные.НомерСтрокиИсточника;
	
	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("НомерСтрокиИсточника", НомерСтрокиИсточника);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЗадачиЗавершены

&НаКлиенте
Процедура ЗадачиЗавершеныПриАктивизацииЯчейки(Элемент)
	Элементы.ЗадачиЗавершены.ВыделенныеСтроки.Очистить();
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиЗавершеныВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока);
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗадачиЗавершеныПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
	"ДоступныеКалендари",
	Новый ТаблицаЗначений);

	Для Каждого КлючИЗначение Из Строки Цикл
		
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, 
			КлючИЗначение.Значение.Данные.Окончание, "ЗадачиЗавершены");
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(КлючИЗначение.Значение.Данные.Календарь);
		Если НайденнаяСтрока <> Неопределено Тогда
			КлючИЗначение.Значение.Данные.КартинкаКалендаря = НайденнаяСтрока.ВариантЦвета;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СоздатьДелоНаЗаданнуюДату(Команда)
	
	СтрокаДаты = Прав(Команда.Имя, СтрДлина(Команда.Имя) - СтрНайти(Команда.Имя, "_"));
	ДатаНачала = ДатаПоСтроке(СтрокаДаты);
	
	ЗначенияЗаполнения = Новый Структура;
	ЗначенияЗаполнения.Вставить("Начало", ДатаНачала);
	
	Если ЗначениеЗаполнено(ДатаНачала) Тогда
		ЗначенияЗаполнения.Вставить("Окончание", ДатаНачала + 1800);
	Иначе
		ЗначенияЗаполнения.Вставить("Окончание", ДатаНачала);
	КонецЕсли;
	
	ЗначенияЗаполнения.Вставить("Календарь", ОсновнойКалендарьСотрудника);
	
	СоздатьДело(ЗначенияЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапланироватьЗадачу(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение", Элементы.Входящее.ТекущиеДанные.Источник);
	ПараметрыЗадачи.Вставить("Список", "Входящее");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура УбратьИзВходящего(Команда)
	УдалитьСтрокуВходящегоИзРегистра(Элементы.Входящее.ТекущаяСтрока.Источник, Элементы.Входящее.ТекущаяСтрока.Ответственный);	
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьВходящее(Команда)
	ПараметрыВходящего = Новый Структура;
	ПараметрыВходящего.Вставить("Ключ", Элементы.Входящее.ТекущиеДанные.Источник);
	Если ТипЗнч(Элементы.Входящее.ТекущиеДанные.Источник) = Тип("Строка") Тогда
		СсылкаОбсуждения = Новый ИдентификаторОбсужденияСистемыВзаимодействия(Элементы.Входящее.ТекущиеДанные.Источник);
		ПерейтиПоНавигационнойСсылке(ПолучитьНавигационнуюСсылку(СсылкаОбсуждения));
	ИначеЕсли ТипЗнч(Элементы.Входящее.ТекущиеДанные.Источник) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		ОткрытьФорму("Документ.ЗаказПокупателя.ФормаОбъекта",ПараметрыВходящего);
	ИначеЕсли ТипЗнч(Элементы.Входящее.ТекущиеДанные.Источник) = Тип("ДокументСсылка.Событие") Тогда
		ОткрытьФорму("Документ.Событие.ФормаОбъекта",ПараметрыВходящего);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьВходящее(Команда)
	
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.Входящее.ТекущаяСтрока.Источник);
	ДополнительныеПараметры.Вставить("Список", "Входящее");
	
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
	Элементы.Входящее.ТекущийЭлемент = Элементы.ВходящееПерваяСтрока;
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачуСегодня(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Список", "ЗадачиНаСегодня");
	ОткрытьФормуЗадачи(ПараметрыЗадачи, "ЗадачиНаСегодня", Истина);
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачуЗавтра(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Список", "ЗадачиНаЗавтра");
	ОткрытьФормуЗадачи(ПараметрыЗадачи, "ЗадачиНаЗавтра", Истина);
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачуБезСрока(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Список", "ЗадачиБезСрока");
	ОткрытьФормуЗадачи(ПараметрыЗадачи, "ЗадачиБезСрока", Истина);
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачуНаНеделе(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Список", "ЗадачиНаНеделе");
	ОткрытьФормуЗадачи(ПараметрыЗадачи, "ЗадачиНаНеделе", Истина);
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачуПозже(Команда)
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Список", "ЗадачиПозже");
	ОткрытьФормуЗадачи(ПараметрыЗадачи, "ЗадачиПозже", Истина);
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьДанныеВсехВидовКонтактЦентра();
	ОчиститьВыделенныеСтроки();
КонецПроцедуры

&НаКлиенте
Процедура Настроить(Команда)
	
	Настройки = Новый Структура;
	Настройки.Вставить("ТекущаяДоска", ТекущаяДоска);
	Настройки.Вставить("НастройкиОтображенияКалендаря", НастройкиОтображения);
	Настройки.Вставить("ВидКонтактЦентра", ВидыКонтактЦентра);
	
	ОткрытьФорму("Обработка.КонтактЦентр.Форма.НастройкаВходящего", Настройки, ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьКалендарь(Команда)
	
	ОткрытьФорму("Справочник.КалендариСотрудников.ФормаОбъекта", , ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура Синхронизировать(Команда)
	
	СинхронизироватьНаКлиенте();
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗадачу(Команда)
	ПараметрыФормы = Новый Структура("СозданиеЗадачиКонтактЦентр", Истина);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);

	ОткрытьФорму("Документ.ЗадачаСотрудника.Форма.ФормаДокумента",ПараметрыФормы,ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьВРаботе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ВРаботе.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ВРаботе.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ВРаботе.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список", "ВРаботе");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьСегодня(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаСегодня.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиНаСегодня.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиНаСегодня");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьЗавтра(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиНаЗавтра");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьБезСрока(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиБезСрока.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиБезСрока.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиНаЗавтра");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьПозже(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПозже.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиПозже.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиПозже");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьЗадачиПросрочены(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПросрочены.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиПросрочены.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиПросрочены");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьНаНеделе(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаНеделе.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("ЗаписьКалендаря", Элементы.ЗадачиНаНеделе.ТекущаяСтрока.ЗаписьКалендаря);
	ПараметрыЗадачи.Вставить("Список","ЗадачиНаНеделе");
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуВРаботе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ВРаботе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ВРаботе.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Задача = Элементы.ВРаботе.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ВРаботе");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуСегодня(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаСегодня.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	
	Задача = Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиНаСегодня");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуПросрочено(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПросрочены.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Задача = Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиПросрочены");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуЗавтра(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Задача = Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиНаЗавтра");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуБезСрока(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиБезСрока.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Задача = Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиБезСрока");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуПозже(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПозже.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Задача = Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиПозже");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуНаНеделе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаНеделе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Задача = Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка;
	ЗавершитьЗадачуСервер(Задача,"ЗадачиНаНеделе");
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Задача),СтрШаблон(НСтр("ru='%1'"),Задача),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуВРаботе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ВРаботе.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ВРаботе.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ВРаботе");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуНаСегодня(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаСегодня.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиНаСегодня");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуНаЗавтра(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиНаЗавтра");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуБезСрока(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиБезСрока.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиБезСрока");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуНаНеделе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаНеделе.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиНаНеделе");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуПозже(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПозже.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиПозже");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура ПеренаправитьЗадачуПросрочена(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПросрочены.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура();
	ДополнительныеПараметры.Вставить("Источник", Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка);
	ДополнительныеПараметры.Вставить("Список", "ЗадачиПросрочены");
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборОтветственного",ЭтотОбъект,ДополнительныеПараметры);
	ПараметрыВыбора = Новый Структура("РежимВыбора",Истина);
	ОткрытьФорму("Справочник.Сотрудники.ФормаВыбора",ПараметрыВыбора,,,,,ОписаниеОповещенияОЗакрытии);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноВРаботе(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ВРаботе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ВРаботе.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ВРаботе.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ВРаботе");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиПросрочены(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПросрочены.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиПросрочены");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоВРаботе(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ВРаботе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ВРаботе.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ВРаботе.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ВРаботе");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиПросрочены(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПросрочены.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиПросрочены.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиПросрочены");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиНаСегодня(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаСегодня.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	
	Источник = Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаСегодня");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиНаСегодня(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаСегодня.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Источник = Элементы.ЗадачиНаСегодня.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаСегодня");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиНаЗавтра(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Источник = Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаЗавтра");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиНаЗавтра(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиНаЗавтра.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаЗавтра");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиБезСрока(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиБезСрока.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;

	Источник = Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиБезСрока");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиБезСрока(Команда)
	
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиБезСрока.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиБезСрока.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиБезСрока");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиНаНеделе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаНеделе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаНеделе");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиНаНеделе(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиНаНеделе.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиНаНеделе.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиНаНеделе");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеЗавершеноЗадачиПозже(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПозже.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиПозже");
	ПараметрыСписка.Вставить("Состояние", "Завершено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСостояниеОтмененоЗадачиПозже(Команда)
	Если НЕ ЗначениеЗаполнено(Элементы.ЗадачиПозже.ТекущаяСтрока)
		ИЛИ ТипЗнч(Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат;
	КонецЕсли;
	Источник = Элементы.ЗадачиПозже.ТекущаяСтрока.Ссылка;
	ПараметрыСписка = Новый Структура();
	ПараметрыСписка.Вставить("Источник", Источник);
	ПараметрыСписка.Вставить("Список", "ЗадачиПозже");
	ПараметрыСписка.Вставить("Состояние", "Отменено");
	
	УстановитьСостояние(ПараметрыСписка);
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура ТелефонныйЗвонок(Команда)
	ЗаполняемоеЗначение = Новый Структура;
	ЗаполняемоеЗначение.Вставить("ТипСобытия", ПредопределенноеЗначение("Перечисление.ТипыСобытий." + Команда.Имя));
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗаполняемоеЗначение);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Документ.Событие.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ЛичнаяВстреча(Команда)
	ЗаполняемоеЗначение = Новый Структура;
	ЗаполняемоеЗначение.Вставить("ТипСобытия", ПредопределенноеЗначение("Перечисление.ТипыСобытий." + Команда.Имя));
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗаполняемоеЗначение);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Документ.Событие.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура Прочее(Команда)
	ЗаполняемоеЗначение = Новый Структура;
	ЗаполняемоеЗначение.Вставить("ТипСобытия", ПредопределенноеЗначение("Перечисление.ТипыСобытий." + Команда.Имя));
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗаполняемоеЗначение);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Документ.Событие.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ЗаданиеНаРаботуВнутреннее(Команда)
	ЗаполняемоеЗначение = Новый Структура;
	ЗаполняемоеЗначение.Вставить("ВидОперации", ПредопределенноеЗначение("Перечисление.ВидыОперацийЗаданиеНаРаботу.Внутреннее"));
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗаполняемоеЗначение);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Документ.ЗаданиеНаРаботу.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура ЗаданиеНаРаботуВнешнее(Команда)
	ЗаполняемоеЗначение = Новый Структура;
	ЗаполняемоеЗначение.Вставить("ВидОперации", ПредопределенноеЗначение("Перечисление.ВидыОперацийЗаданиеНаРаботу.Внешнее"));
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗаполняемоеЗначение);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Документ.ЗаданиеНаРаботу.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ВыполнитьПеретаскиваниеКанбан(ПараметрыПеретаскивания,СтрокаДаты, ИмяЭлемента)
	
	Если ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ПараметрыПеретаскивания.Значение.Значение) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'Изменение доступно только из карточки заказа'"));
		Возврат;
	КонецЕсли;
	
	Если ПараметрыПеретаскивания.Значение.СписокДляОбновления <> "Входящее" Тогда
		
		ИзменитьДатуВОбъекте(ПараметрыПеретаскивания.Значение, ИмяЭлемента, СтрокаДаты);
		ОчиститьВыделенныеСтроки();
		
		ТекущийЭлемент = Элементы[ИмяЭлемента];
		Элементы[ИмяЭлемента].ТекущаяСтрока = Новый КлючСтрокиДинамическогоСписка("ЗаписьКалендаря, Ссылка",
		ПараметрыПеретаскивания.Значение.ЗаписьКалендаря,
		ПараметрыПеретаскивания.Значение.Значение);
		
		ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),
				ПолучитьНавигационнуюСсылку(ПараметрыПеретаскивания.Значение.Значение),
				СтрШаблон(НСтр("ru='%1'"),ПараметрыПеретаскивания.Значение.Значение),
				БиблиотекаКартинок.Информация32);
	Иначе
		ОткрытьФормуЗадачи(ПараметрыПеретаскивания.Значение, ПараметрыПеретаскивания.Значение.СписокДляОбновления);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоЗавершеннымИУправлениеФормой()
	
	УстановитьОтборПоЗавершенным();
	ОбновитьДанныеПланировщикаИЗадачиНаВесьДень();
	УправлениеФормой();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВсехВидовКонтактЦентра()
	
	ОбновитьВходящее();
	ОбновитьДанныеВидСписок();
	ОбновитьДанныеВидКанбан();
	ОбновитьДанныеВидКалендарь();
	ОбновитьДанныеВидДоски();
	ОбновитьДанныеВидТекущаяДоска();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеТекущегоВидаКонтактЦентра()
		
	Если ВидыКонтактЦентра = 0 Тогда
		ОбновитьДанныеВидСписок();
	КонецЕсли;
	
	Если ВидыКонтактЦентра = 1 Тогда
		ОбновитьДанныеВидКанбан();
	КонецЕсли;
	
	Если ВидыКонтактЦентра = 2 Тогда
		ОбновитьДанныеВидКалендарь();
	КонецЕсли;
	
	Если ВидыКонтактЦентра = 3 Тогда
		ОбновитьДанныеВидДоски();
	КонецЕсли;
	
	Если ВидыКонтактЦентра = 4 Тогда
		ОбновитьДанныеВидТекущаяДоска();
	КонецЕсли;
	
	Если ВидыКонтактЦентра <> 4 Тогда
		ОбновитьВходящее();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВидСписок()
	Элементы.ВРаботе.Обновить();
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВидКанбан()
	Для Каждого Список Из ИмяСписковФормыСервер() Цикл
		Элементы[Список].Обновить();
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВидКалендарь()
	ЗаполнитьЗадачиНаВесьДеньКалендарь();
	ОбновитьДанныеПланировщикаСервер();
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВидДоски()
	ОбновитьЭлементыДосок();
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеВидТекущаяДоска()
	
	РазрешенныеИсточники = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточники(Истина),"Источник");

	Для Каждого Колонка ИЗ КолонкиТекущейДоски Цикл
		
		Индекс           = КолонкиТекущейДоски.Индекс(Колонка);
		ТекущийСписокДел = "СписокДел_" + Строка(Индекс);
		
		ЭтотОбъект[ТекущийСписокДел].Параметры.УстановитьЗначениеПараметра("РазрешенныеИсточники",РазрешенныеИсточники);
		Элементы[ТекущийСписокДел].Обновить();
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоРазрешеннымИОбновитьДанныеТекущегоВидаКонтактЦентр()
	УстановитьОтборПоРазрешеннымИсточникам();
	ОбновитьДанныеВсехВидовКонтактЦентра();
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьВыделенныеСтроки()
	
	Элементы["Входящее"].ВыделенныеСтроки.Очистить();
	
	Для Каждого Список Из ИмяСписковФормы() Цикл
		Элементы[Список].ВыделенныеСтроки.Очистить();
	КонецЦикла;	
	
	Для Каждого Колонка Из КолонкиТекущейДоски Цикл
		Индекс = КолонкиТекущейДоски.Индекс(Колонка);
		Элементы["СписокДел_"+Строка(Индекс)].ВыделенныеСтроки.Очистить();
	КонецЦикла;	
	
КонецПроцедуры

&НаСервере
Функция ДатаПоСтроке(СтрокаДаты)
	
	СекундВДне = 3600*24;
	Сегодня    = ТекущаяДатаСеанса();
	Завтра     = ТекущаяДатаСеанса() + СекундВДне;
	НаНеделе   = Завтра + СекундВДне;
	Позже      = КонецНедели(Сегодня) + 1;

	СоответствиеДатыСтроке = Новый Соответствие;
	
	СоответствиеДатыСтроке.Вставить("Сегодня", Сегодня);
	СоответствиеДатыСтроке.Вставить("Завтра", Завтра);
	СоответствиеДатыСтроке.Вставить("БезСрока", Неопределено);
	СоответствиеДатыСтроке.Вставить("НаНеделе", НаНеделе);
	СоответствиеДатыСтроке.Вставить("Позже", Позже);
	
	Возврат СоответствиеДатыСтроке[СтрокаДаты];
	
КонецФункции

&НаСервере
Процедура УстановитьОтборВходящегоПоОтветственнымИИсточнику()
	
	Если Пользователи.ЭтоПолноправныйПользователь() Тогда
		РазрешенныеИсточникиВходящего = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточникиВходящего(),"Источник");
		Входящее.Параметры.УстановитьЗначениеПараметра("РазрешенныеИсточникиВходящего", РазрешенныеИсточникиВходящего);
		Возврат;
	КонецЕсли;
	
	МассивСотрудников = Новый Массив;
	МассивСотрудников.Добавить(СотрудникТекущегоПользователя);
	МассивСотрудников.Добавить(Справочники.Сотрудники.ПустаяСсылка());
	ОбщегоНазначенияКлиентСервер.УстановитьЭлементОтбораДинамическогоСписка(Входящее, "Ответственный",
	МассивСотрудников, ВидСравненияКомпоновкиДанных.ВСписке);
	
	РазрешенныеИсточникиВходящего = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточникиВходящего(),"Источник");
	Входящее.Параметры.УстановитьЗначениеПараметра("РазрешенныеИсточникиВходящего", РазрешенныеИсточникиВходящего);
	
КонецПроцедуры
	
&НаКлиенте
Процедура СоздатьДело(ЗначенияЗаполнения)
	
	ОписаниеОповещенияОЗакрытии = Новый ОписаниеОповещения("ВыборТипаДелаЗавершение",ЭтотОбъект);
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗначенияЗаполнения);
	ОткрытьФорму("Обработка.КонтактЦентр.Форма.СозданиеИзКалендаря", ПараметрыФормы,,,,,ОписаниеОповещенияОЗакрытии);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоРазрешеннымИсточникам()
	
	РазрешенныеИсточники = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточники(),"Источник");
	
	Для Каждого Список Из СпискиФормы() Цикл
		Список.Параметры.УстановитьЗначениеПараметра("РазрешенныеИсточники",РазрешенныеИсточники);
	КонецЦикла;
		
КонецПроцедуры

&НаСервере
Функция РазрешенныеИсточники(ОтборПоТекущейДоске = Ложь)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЗаписиКалендаряСотрудника.Источник КАК Источник
	|ИЗ
	|	Справочник.ЗаписиКалендаряСотрудника КАК ЗаписиКалендаряСотрудника
	|ГДЕ
	|	&ОтборЗавершенные
	|	И НЕ ЗаписиКалендаряСотрудника.ПометкаУдаления
	|	И ЗаписиКалендаряСотрудника.Календарь В(&ВыбранныеКалендари)
	|	И ЗаписиКалендаряСотрудника.Источник <> НЕОПРЕДЕЛЕНО";
	
	ВыбранныеКалендари = ДоступныеКалендари.НайтиСтроки(Новый Структура("Выбран", Истина));
	
	ВыбранныеКалендариМассив = Новый Массив;
	Для Каждого Календарь Из ВыбранныеКалендари Цикл
		Если ОтборПоТекущейДоске И Календарь.Календарь <> ТекущаяДоска Тогда
			Продолжить;
		КонецЕсли;
		ВыбранныеКалендариМассив.Добавить(Календарь.Календарь);
	КонецЦикла;
	
	Если ВыбранныеКалендариМассив.Количество() = 0 И ОтборПоТекущейДоске Тогда
		ВыбранныеКалендариМассив.Добавить(ТекущаяДоска);
	КонецЕсли;
	
	Если НЕ ОтборЗавершенные И НЕ ОтборПоТекущейДоске Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборЗавершенные", "НЕ ЗаписиКалендаряСотрудника.Завершено");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборЗавершенные", "ИСТИНА");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ВыбранныеКалендари",ВыбранныеКалендариМассив);
	ВТ_Источники = Запрос.Выполнить().Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	Событие.Ссылка КАК Источник
	|ИЗ
	|	Документ.Событие КАК Событие
	|ГДЕ
	|	Событие.Ссылка В(&Источники)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаданиеНаРаботу.Ссылка
	|ИЗ
	|	Документ.ЗаданиеНаРаботу КАК ЗаданиеНаРаботу
	|ГДЕ
	|	ЗаданиеНаРаботу.Ссылка В(&Источники)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка В(&Источники)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаказПокупателя.Ссылка
	|ИЗ
	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	|ГДЕ
	|	ЗаказПокупателя.Ссылка В(&Источники)";
	
	Запрос.УстановитьПараметр("Источники", ВТ_Источники.ВыгрузитьКолонку("Источник"));
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

&НаСервере
Функция РазрешенныеИсточникиВходящего()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КонтактЦентрВходящее.Источник КАК Источник
	|ИЗ
	|	РегистрСведений.КонтактЦентрВходящее КАК КонтактЦентрВходящее
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(КонтактЦентрВходящее.Источник) <> ТИП(СТРОКА)
	|	И &ОтборПоОтветственному";
	
	Запрос.УстановитьПараметр("ТекущийСотрудник",СотрудникТекущегоПользователя);
	
	Если НЕ Пользователи.ЭтоПолноправныйПользователь() Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоОтветственному", "(КонтактЦентрВходящее.Ответственный = &ТекущийСотрудник
		|ИЛИ КонтактЦентрВходящее.Ответственный = &Ответственный)");
		
		Запрос.УстановитьПараметр("ТекущийСотрудник", СотрудникТекущегоПользователя);
		Запрос.УстановитьПараметр("Ответственный",    Справочники.Сотрудники.ПустаяСсылка());
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоОтветственному", "ИСТИНА");
	КонецЕсли;
	
	ВТ_Источники = Запрос.Выполнить().Выгрузить();
	
	Если ВТ_Источники.Количество() = 0 Тогда
		Возврат ВТ_Источники;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	Событие.Ссылка КАК Источник
	|ИЗ
	|	Документ.Событие КАК Событие
	|ГДЕ
	|	Событие.Ссылка В(&Источники)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаказПокупателя.Ссылка
	|ИЗ
	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	|ГДЕ
	|	ЗаказПокупателя.Ссылка В(&Источники)";
	
	Запрос.УстановитьПараметр("Источники", ВТ_Источники.ВыгрузитьКолонку("Источник"));
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

&НаКлиенте
Процедура ВыборТипаДелаЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	Результат.Вставить("РежимВыбора", Истина);
	ОткрытьФорму(Результат.ЗначенияЗаполнения.ДанныеЗаписиКалендаря.ИмяФормы, Результат, ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоТекущейДате()
	ЗадачиНаСегодня.Параметры.УстановитьЗначениеПараметра("ТекущаяДатаСеанса",ТекущаяДатаСеанса());
	ЗадачиНаЗавтра.Параметры.УстановитьЗначениеПараметра("ТекущаяДатаСеанса",ТекущаяДатаСеанса());
	ЗадачиНаНеделе.Параметры.УстановитьЗначениеПараметра("ТекущаяДатаСеанса",ТекущаяДатаСеанса());
	ЗадачиПозже.Параметры.УстановитьЗначениеПараметра("ТекущаяДатаСеанса",ТекущаяДатаСеанса());
	ЗадачиПросрочены.Параметры.УстановитьЗначениеПараметра("ТекущаяДатаСеанса",ТекущаяДатаСеанса());
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеПоСостояниямСобытий()
	
	УстановитьПривилегированныйРежим(Истина);
	СпискиФормы = СпискиФормы();
	ВыборкаСостоянияСобытия = Справочники.СостоянияСобытий.Выбрать();
	
	СпискиТекущейДоски = Новый Массив;
	Для Каждого КолонкаДоски Из КолонкиТекущейДоски Цикл
		ИндексСписка = КолонкиТекущейДоски.Индекс(КолонкаДоски);
		ТекущийСписокДел = ЭтотОбъект["СписокДел_"+ИндексСписка];
		СпискиТекущейДоски.Добавить(ТекущийСписокДел);
	КонецЦикла;
	
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(СпискиФормы, СпискиТекущейДоски);

	Для Каждого Список ИЗ СпискиФормы Цикл
		УсловноеОформлениеКД = Список.КомпоновщикНастроек.Настройки.УсловноеОформление;
		// Раскраска списка
		УдаляемыеЭлементы = Новый Массив;
		
		Для Каждого ЭлементУсловногоОформления Из УсловноеОформлениеКД.Элементы Цикл
			Если ЭлементУсловногоОформления.ИдентификаторПользовательскойНастройки = "ЦветСостояния" Тогда
				УдаляемыеЭлементы.Добавить(ЭлементУсловногоОформления);
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого ЭлементУсловногоОформления Из УдаляемыеЭлементы Цикл
			УсловноеОформлениеКД.Элементы.Удалить(ЭлементУсловногоОформления);
		КонецЦикла;
		
		Пока ВыборкаСостоянияСобытия.Следующий() Цикл
			
			ЦветФона = ВыборкаСостоянияСобытия.Цвет.Получить();
			Если ТипЗнч(ЦветФона) <> Тип("Цвет") Тогда
				Продолжить;
			КонецЕсли; 
			
			ЭлементУсловногоОформления = УсловноеОформлениеКД.Элементы.Добавить();
			
			ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветФона);
			ЭлементУсловногоОформления.ИдентификаторПользовательскойНастройки = "ЦветСостояния";
			ЭлементУсловногоОформления.РежимОтображения	= РежимОтображенияЭлементаНастройкиКомпоновкиДанных.БыстрыйДоступ;
			ЭлементУсловногоОформления.Представление	= НСтр("ru='Оформление в цвет состояния'");
			
			ЭлементОтбора = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ЭлементОтбора.ЛевоеЗначение		= Новый ПолеКомпоновкиДанных("СостояниеИсточника");
			ЭлементОтбора.ВидСравнения		= ВидСравненияКомпоновкиДанных.Равно;
			ЭлементОтбора.ПравоеЗначение	= ВыборкаСостоянияСобытия.Ссылка;
			
		КонецЦикла;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

&НаСервере
Функция СпискиФормы()
	
	Списки = Новый Массив;
	Списки.Добавить(ЭтотОбъект["ВРаботе"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиПросрочены"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиБезСрока"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиЗавершены"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиНаЗавтра"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиНаНеделе"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиПозже"]);
	Списки.Добавить(ЭтотОбъект["ЗадачиНаСегодня"]);
	
	Возврат Списки;
	
КонецФункции

&НаКлиенте
Функция ИмяСписковФормы()
	
	Списки = Новый Массив;
	Списки.Добавить("ВРаботе");
	Списки.Добавить("ЗадачиПросрочены");
	Списки.Добавить("ЗадачиБезСрока");
	Списки.Добавить("ЗадачиЗавершены");
	Списки.Добавить("ЗадачиНаЗавтра");
	Списки.Добавить("ЗадачиНаНеделе");
	Списки.Добавить("ЗадачиПозже");
	Списки.Добавить("ЗадачиНаСегодня");
	
	Возврат Списки;
	
КонецФункции

&НаСервере
Функция ИмяСписковФормыСервер()
	
	Списки = Новый Массив;
	Списки.Добавить("ВРаботе");
	Списки.Добавить("ЗадачиПросрочены");
	Списки.Добавить("ЗадачиБезСрока");
	Списки.Добавить("ЗадачиЗавершены");
	Списки.Добавить("ЗадачиНаЗавтра");
	Списки.Добавить("ЗадачиНаНеделе");
	Списки.Добавить("ЗадачиПозже");
	Списки.Добавить("ЗадачиНаСегодня");
	
	Возврат Списки;
	
КонецФункции

&НаСервере
Процедура УстановитьУсловноеОформлениеНаВесьДень()
	
	Для каждого ДанныеЦвета Из ЦветаПоНомеруКартинки() Цикл
		НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
		РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, "ЗадачиНаВесьДеньКалендарь.ВариантЦвета", ДанныеЦвета.Ключ, ВидСравненияКомпоновкиДанных.Равно);
		РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы.ЗадачиНаВесьДеньКалендарьПредставление.Имя);
		РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы.ЗадачиНаВесьДеньКалендарьДатаСтрокой.Имя);
		РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветФона", ДанныеЦвета.Значение);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ЦветаПоНомеруКартинки() 
	
	Соответствие = Новый Соответствие;
	
	Соответствие.Вставить(1,  Новый Цвет(172,114,94));
	Соответствие.Вставить(2,  Новый Цвет(208,107,100));
	Соответствие.Вставить(3,  Новый Цвет(248,58,34));
	Соответствие.Вставить(4,  Новый Цвет(250,87,60));
	Соответствие.Вставить(5,  Новый Цвет(255,117,55));
	Соответствие.Вставить(6,  Новый Цвет(255,173,70));
	Соответствие.Вставить(7,  Новый Цвет(66,214,146));
	Соответствие.Вставить(8,  Новый Цвет(22,167,101));
	Соответствие.Вставить(9,  Новый Цвет(123,209,72));
	Соответствие.Вставить(10, Новый Цвет(179,220,108));
	Соответствие.Вставить(11, Новый Цвет(251,233,131));
	Соответствие.Вставить(12, Новый Цвет(250,209,101));
	Соответствие.Вставить(13, Новый Цвет(146,225,192));
	Соответствие.Вставить(14, Новый Цвет(159,225,231));
	Соответствие.Вставить(15, Новый Цвет(159,198,231));
	Соответствие.Вставить(16, Новый Цвет(73,134,231));
	Соответствие.Вставить(17, Новый Цвет(154,156,255));
	Соответствие.Вставить(18, Новый Цвет(185,154,255));
	Соответствие.Вставить(19, Новый Цвет(194,194,194));
	Соответствие.Вставить(20, Новый Цвет(202,189,191));
	Соответствие.Вставить(21, Новый Цвет(204,166,172));
	Соответствие.Вставить(22, Новый Цвет(246,145,178));
	Соответствие.Вставить(23, Новый Цвет(205,116,230));
	Соответствие.Вставить(24, Новый Цвет(164,122,226));
	
	Возврат Соответствие;
	
КонецФункции

&НаСервере
Процедура УправлениеФормой()
	
	Элементы.ГруппаВходящее.Видимость = ВидыКонтактЦентра <> 3 И ВидыКонтактЦентра <> 4;
	Элементы.РазделительнаяЛиния.Видимость = ВидыКонтактЦентра <> 3 И ВидыКонтактЦентра <> 4;
	Элементы.ГруппаФильтрыНастройкиИДопИнфо.Видимость = ВидыКонтактЦентра <> 3;
	Элементы.ДоступныеКалендари.Видимость = ВидыКонтактЦентра <> 4;
	Элементы.ДобавитьКалендарь.Видимость = ВидыКонтактЦентра <> 4;
	Элементы.ОтборЗавершенные.Видимость = ВидыКонтактЦентра <> 4;
	
	//вид отображения "Список"
	Элементы.ГруппаВРаботе.Видимость = ВидыКонтактЦентра = 0;
	Элементы.ПредставлениеПериодаЗадачи.Видимость = ВидыКонтактЦентра = 0;
	
	//вид отображения "Канбан"
	Элементы.СтраницыКанбан.Видимость =  ВидыКонтактЦентра = 1;
	Элементы.ЗадачиЗавершены.Видимость = ОтборЗавершенные;
	Элементы.ЗаголовокЗадачиЗавершены.Видимость = ОтборЗавершенные;
	
	//Вид отображения "Календарь"
	Элементы.Календарь.Видимость = ВидыКонтактЦентра = 2;
	Элементы.ГруппаСинхронизировать.Видимость = ВидыКонтактЦентра = 2;
	Элементы.ГруппаПечать.Видимость = ВидыКонтактЦентра = 2;
	
	//Вид отображения "Доски"
	Элементы.Доски.Видимость = ВидыКонтактЦентра = 3;
	Элементы.ФормаПоказыватьНедействительные.Видимость = ВидыКонтактЦентра = 3;
	
	//Вид отображения "Текущая доска"
	Элементы.СтраницыДоска.Видимость = ВидыКонтактЦентра = 4;
	Элементы.СтраницыДоска.Видимость = ВидыКонтактЦентра = 4;
	ЭлементДоски = Элементы.Переключатель.СписокВыбора.НайтиПоЗначению(4);
	Если ЭлементДоски <> Неопределено Тогда
		ЭлементДоски.Представление = Строка(ТекущаяДоска);
	КонецЕсли;
	
	//Отображение пустого списка "Входящее"	
	ОбработаноВсеВходящее  = КонтактЦентр.ОбработаноВсеВходящее(СотрудникТекущегоПользователя);
	
	Элементы.ГруппаНетПодключенныхКаналов.Видимость = Ложь;
	Элементы.ГруппаОбработаноВсеВходящее.Видимость = ОбработаноВсеВходящее;
	Элементы.ДекорацияРастяжение.Видимость = ОбработаноВсеВходящее;
	Элементы.Входящее.Видимость = НЕ Элементы.ДекорацияРастяжение.Видимость;
	
	Элементы.ГруппаПодсказкаЦели.Видимость = ОтображатьПодсказкуДоски;
	Если ВидыКонтактЦентра = 4 Тогда
		Элементы.ДобавитьКолонкуКалендаря.Видимость = ВидимостьПодсказкиДобавленияКолонки();
	КонецЕсли;
	
	СистемнаяИнформация = Новый СистемнаяИнформация;
	ТекущаяВерсияПлатформы = СистемнаяИнформация.ВерсияПриложения;
	
	Если ОбщегоНазначенияКлиентСервер.СравнитьВерсии(ТекущаяВерсияПлатформы, "8.3.19.0") >= 0 Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СтраницыДоска", "Ширина", 0);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СтраницыКанбан", "Ширина", 0);
	Иначе
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СтраницыДоска", "Ширина", 1);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "СтраницыКанбан", "Ширина", 1);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеПланировщикаИЗадачиНаВесьДень()
	ПрочитатьДоступныеКалендари();
	ОбновитьДанныеПланировщикаСервер();
	ЗаполнитьЗадачиНаВесьДеньКалендарь();
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуТекущегоЭлементаСписка(ВыбраннаяСтрока)
	
	ПараметрыФормы = Новый Структура();
	ПараметрыФормы.Вставить("СозданиеЗадачиКонтактЦентр", Истина);
	ПараметрыФормы.Вставить("Ключ", ВыбраннаяСтрока.Ссылка);
	
	Если ЗначениеЗаполнено(ВыбраннаяСтрока.Ссылка)
		И ТипЗнч(ВыбраннаяСтрока.Ссылка) = Тип("СправочникСсылка.ЗаписиКалендаряПодготовкиОтчетности") Тогда
		
		ДанныеФормыЗадачи = ПолучитьДанныеФормыЗадачи(ВыбраннаяСтрока.Ссылка);
		Если Не ПустаяСтрока(ДанныеФормыЗадачи.ИмяФормы) Тогда
			ОткрытьФорму(ДанныеФормыЗадачи.ИмяФормы, ДанныеФормыЗадачи.ПараметрыФормы);
		КонецЕсли;
	Иначе
		ОткрытьФорму(ИмяФормыЗадачиПоТипу(ВыбраннаяСтрока.Ссылка),ПараметрыФормы);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ВидимостьПодсказкиДобавленияКолонки()
	КалендариМассив = ОбщегоНазначения.ВыгрузитьКолонку(ДоступныеКалендари,"Календарь");
	Возврат НЕ Справочники.КалендариСотрудников.ЕстьНастроенныеКалендари(КалендариМассив);
КонецФункции

&НаСервере
Процедура НастроитьФормуМобильныйКлиент()
	
	Если НЕ ОбщегоНазначения.ЭтоМобильныйКлиент() Тогда
		Возврат;
	КонецЕсли;
	
	Элементы.ГруппаВходящее.Видимость = Ложь;
	Элементы.РазделительнаяЛиния.Видимость = Ложь;
	Элементы.ФормаНастроить.Видимость = Ложь;
	Элементы.ГруппаКоманднаяПанель.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
	Элементы.ЗаголовокПросроченоВРаботе.Видимость = Ложь;
	Элементы.ГруппаЗадачиНаВесьДень.Видимость = Ложь;
	Элементы.ГруппаПредставлениеПериода.Видимость = Ложь;
	Элементы.ПредставлениеПериода.Видимость = Истина;
	Элементы.ГруппаСдвигПоКалендарю.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	Элементы.ГруппаКомандаСинхронизировать.Видимость = Ложь;
	Элементы.ГруппаПрогрессСинхронизации.Видимость = Ложь;
	
	Элементы.Переместить(Элементы.ФормаСегодня,Элементы.ГруппаВариантПериода);
	Элементы.Переместить(Элементы.ФильтрыНастройкиИДопИнфо,Элементы.ГруппаКонтактЦентрОбщая);
	Элементы.Переместить(Элементы.ДатаОтображения,Элементы.ГруппаКалендарьМобильныйКлиент);
	
	Если Элементы.Переключатель.СписокВыбора.НайтиПоЗначению(4) <> Неопределено Тогда
		Элементы.Переключатель.СписокВыбора.Удалить(4);
	КонецЕсли;
	
	Если Элементы.Переключатель.СписокВыбора.НайтиПоЗначению(3) <> Неопределено Тогда
		Элементы.Переключатель.СписокВыбора.Удалить(3);
	КонецЕсли;
	
	Если Элементы.Переключатель.СписокВыбора.НайтиПоЗначению(1) <> Неопределено Тогда
		Элементы.Переключатель.СписокВыбора.Удалить(1);
	КонецЕсли;

	РаботаСОтборами.НастроитьПанельОтборовМобильныйКлиент(ЭтотОбъект,"ФильтрыНастройкиИДопИнфо","ОтборТеги,ОтборОтветственный,ОтборЗавершенные",,,Истина);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьВходящее()
	
	ОбсужденияУНФИнтеграцияСМессенджерами.ДобавитьНеотвеченныеСообщенияВКонтактЦентр();
	Элементы.Входящее.Обновить();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция СтрокаТегов(Теги)
	МассивТегов = Новый Массив;
	Для Каждого Тег Из Теги Цикл
		МассивТегов.Добавить(Тег.Тег);
	КонецЦикла;
	СтрокаТегов = СтрСоединить(МассивТегов, ", ");
	Если СтрокаТегов = "" Тогда
		Возврат "";
	Иначе
		Возврат СтрШаблон("# %1", СтрокаТегов);
	КонецЕсли;
КонецФункции

&НаСервере
Процедура УстановитьОтборПоЗавершенным()
	
	ВРаботе.Параметры.УстановитьЗначениеПараметра("ОтборПоЗавершенным", ОтборЗавершенные);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЗаголовокГруппыОтборов()
	Если ПроверитьОтборУстановлен(ЭтотОбъект, "ГруппаФильтры", "ДанныеМеток") Тогда
		Элементы.ГруппаФильтрыНастройкиИДопИнфо.Заголовок = НСтр("ru = 'Фильтры (установлены)'");
	Иначе
		Элементы.ГруппаФильтрыНастройкиИДопИнфо.Заголовок = НСтр("ru = 'Фильтры'");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПроверитьОтборУстановлен(Форма, ИмяЭлементаПраваяПанель, ИмяТЧДанныеМеток)
	
	РеквизитыОтбораПравойПанели = "ОтборТеги,ОтборОтветственный";
	ОтборУстановлен = Ложь;
	
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(Форма, "ОтборПериод") 
		И ЗначениеЗаполнено(Форма.ОтборПериод) Тогда
		
		Возврат Истина;
	КонецЕсли;
	
	// ... реквизит "ДанныеМеток".
	Попытка
		Если Форма[ИмяТЧДанныеМеток].Количество() > 0 Тогда
			Возврат Истина;
		КонецЕсли;
	Исключение КонецПопытки;
	
	Если РеквизитыОтбораПравойПанели <> "" Тогда
		СтруктураРеквизитыОтбора = ОбщегоНазначенияПереопределяемый.СтрокаВСтруктуру(РеквизитыОтбораПравойПанели, ",");
		
		Для Каждого КлючЗначение Из СтруктураРеквизитыОтбора Цикл
			Если ЗначениеЗаполнено(Форма[КлючЗначение.Ключ]) Тогда
				Если ТипЗнч(Форма[КлючЗначение.Ключ]) = Тип("Булево") Тогда
					ОтборУстановлен = Форма[КлючЗначение.Ключ];
				Иначе
					Возврат Истина;
				КонецЕсли;
				
				Если ОтборУстановлен Тогда
					Возврат Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Если НЕ ОтборУстановлен Тогда
		ОтборУстановлен = ОтборЗавершенные;
	КонецЕсли;
	
	Возврат ОтборУстановлен;
	
КонецФункции

&НаСервере
Процедура ОбновитьТекущийЭлементСписка(ВыбранноеЗначение)
	
	ЗаписьКалендаря = Справочники.ЗаписиКалендаряСотрудника.ПустаяСсылка();
	Если ТипЗнч(ВыбранноеЗначение) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		КлючТекущейСтроки = Новый КлючСтрокиДинамическогоСписка("ЗаписьКалендаря, Ссылка",
			ЗаписьКалендаря, ВыбранноеЗначение);
	Иначе
		ЗаписьКалендаря = ЗаписьКалендаряПоИсточнику(ВыбранноеЗначение);
		КлючТекущейСтроки = Новый КлючСтрокиДинамическогоСписка("ЗаписьКалендаря, Ссылка",
			ЗаписьКалендаря, ВыбранноеЗначение);	
	КонецЕсли;
	
	ОбновляемыйСписок = ИмяСпискаДляОбновления(ВыбранноеЗначение, ЗаписьКалендаря);
	ТекущийЭлемент = Элементы[ОбновляемыйСписок];
	Элементы[ОбновляемыйСписок].ТекущаяСтрока = КлючТекущейСтроки;
	ТекущийЭлемент = Элементы[ОбновляемыйСписок];
	
КонецПроцедуры

&НаСервере
Функция ИмяСпискаДляОбновления(ВыбранноеЗначение, ЗаписьКалендаря)
	
	Если ВидыКонтактЦентра = 0 Тогда
		Возврат "ВРаботе";
	ИначеЕсли ВидыКонтактЦентра = 1 Тогда
		Возврат ИмяСпискаПоДатеЗначения(ВыбранноеЗначение, ЗаписьКалендаря);
	ИначеЕсли ВидыКонтактЦентра = 4 Тогда
		Возврат ИмяСпискаПоКолонкеЗначения(ВыбранноеЗначение, ЗаписьКалендаря);
	Иначе
		Возврат "ВРаботе";
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ИмяСпискаПоДатеЗначения(ВыбранноеЗначение, ЗаписьКалендаря)
	
	Если ТипЗнч(ВыбранноеЗначение) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		ДатаНачала = ВыбранноеЗначение.ДатаНачала;
		ДатаОкончания = ВыбранноеЗначение.ДатаОкончания;
	Иначе
		ДатаНачала = ЗаписьКалендаря.Начало;
		ДатаОкончания = ЗаписьКалендаря.Окончание;
	КонецЕсли;
	
	СекундВОдномДне = 3600*24;
	ДатаСегодня = НачалоДня(ТекущаяДатаСеанса());
	ДатаЗавтра = ДатаСегодня + СекундВОдномДне;
	НачалоТекущейНедели = НачалоНедели(ТекущаяДатаСеанса());
	КонецТекущейНедели = КонецНедели(ТекущаяДатаСеанса());
	
	ЗадачаБезСрока = НЕ ЗначениеЗаполнено(ДатаНачала) И НЕ ЗначениеЗаполнено(ДатаОкончания);
	ЗадачаНаСегодня = ЗначениеЗаполнено(ДатаНачала) И НачалоДня(ДатаНачала) = ДатаСегодня
		ИЛИ ЗначениеЗаполнено(ДатаОкончания) И НачалоДня(ДатаОкончания) = ДатаСегодня;
	ЗадачаНаЗавтра = ЗначениеЗаполнено(ДатаНачала) И НачалоДня(ДатаНачала) = ДатаЗавтра
		ИЛИ ЗначениеЗаполнено(ДатаОкончания) И НачалоДня(ДатаОкончания) = ДатаЗавтра;
		
	ЗадачаНаНеделе = (ЗначениеЗаполнено(ДатаНачала) И НачалоДня(ДатаНачала) > НачалоТекущейНедели
		 И НачалоДня(ДатаНачала) < КонецТекущейНедели) ИЛИ (ЗначениеЗаполнено(ДатаОкончания) 
		 И НачалоДня(ДатаОкончания) > НачалоТекущейНедели
		 И НачалоДня(ДатаОкончания) < КонецТекущейНедели);
		 
	ЗадачаПозже = ЗначениеЗаполнено(ДатаНачала) И НачалоДня(ДатаНачала) > КонецТекущейНедели 
		 ИЛИ ЗначениеЗаполнено(ДатаОкончания) И НачалоДня(ДатаОкончания) > КонецТекущейНедели;
		
	Если ЗадачаБезСрока Тогда
		Возврат "ЗадачиБезСрока";
	ИначеЕсли ЗадачаНаСегодня Тогда
		Возврат "ЗадачиНаСегодня";
	ИначеЕсли ЗадачаНаЗавтра Тогда
		Возврат "ЗадачиНаЗавтра";
	ИначеЕсли ЗадачаНаНеделе  Тогда
		Возврат "ЗадачиНаНеделе";
	ИначеЕсли ЗадачаПозже Тогда
		Возврат "ЗадачиПозже";
	Иначе
		Возврат "ЗадачиПросрочены";
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ЗаписьКалендаряПоИсточнику(ВыбранноеЗначение)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаписиКалендаряСотрудника.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ЗаписиКалендаряСотрудника КАК ЗаписиКалендаряСотрудника
	|ГДЕ
	|	ЗаписиКалендаряСотрудника.Источник = &ВыбранноеЗначение";
	
	Запрос.УстановитьПараметр("ВыбранноеЗначение", ВыбранноеЗначение);
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Справочники.ЗаписиКалендаряСотрудника.ПустаяСсылка();
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Ссылка;
	КонецЦикла;
	
КонецФункции

&НаСервере
Функция ИмяСпискаПоКолонкеЗначения(ВыбранноеЗначение, ЗаписьКалендаря)
	
	Если ТипЗнч(ВыбранноеЗначение) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Источник = ВыбранноеЗначение;
	Иначе
		Источник = ЗаписьКалендаря;
	КонецЕсли;
	
	Колонка = Источник.КолонкаКалендаря;
	НайденнаяКолонка = КолонкиТекущейДоски.НайтиСтроки(Новый Структура("Ссылка",Колонка));
	Если НайденнаяКолонка.Количество() = 0 Тогда
		Возврат "СписокДел_0";
	КонецЕсли;
	
	Индекс = КолонкиТекущейДоски.Индекс(НайденнаяКолонка[0]);
	СтрокаСписка = "СписокДел_"+Строка(Индекс);
	Возврат СтрокаСписка;
	
КонецФункции

&НаКлиенте
Процедура ОткрытьФормуТекущегоЭлементаПланировщика()
	
	Если Элементы.Планировщик.ВыделенныеЭлементы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЗначениеЭлемента = Элементы.Планировщик.ВыделенныеЭлементы[0].Значение;
	
	Если ЗначениеЗаполнено(ЗначениеЭлемента.Источник)
		И ТипЗнч(ЗначениеЭлемента.Источник) = Тип("СправочникСсылка.ЗаписиКалендаряПодготовкиОтчетности")
		И ЗначениеЭлемента.Календарь = ПредопределенноеЗначение("Справочник.КалендариСотрудников.КалендарьНалогов") Тогда
		
		ДанныеФормыЗадачи = ПолучитьДанныеФормыЗадачи(ЗначениеЭлемента.Источник);
		Если Не ПустаяСтрока(ДанныеФормыЗадачи.ИмяФормы) Тогда
			ОткрытьФорму(ДанныеФормыЗадачи.ИмяФормы, ДанныеФормыЗадачи.ПараметрыФормы);
		КонецЕсли;
		
	ИначеЕсли ЗначениеЗаполнено(ЗначениеЭлемента.Источник) И ТипЗнч(ЗначениеЭлемента.ЗаписьКалендаря) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		
		ПоказатьЗначение(,ЗначениеЭлемента.Источник);
		
	ИначеЕсли ТипЗнч(ЗначениеЭлемента.ЗаписьКалендаря) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		ПоказатьЗначение(,ЗначениеЭлемента.ЗаписьКалендаря);
	ИначеЕсли Не ЗначениеЗаполнено(ЗначениеЭлемента.Источник) Тогда
		
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("Ключ", ЗначениеЭлемента.ЗаписьКалендаря);
		ОткрытьФорму("Справочник.ЗаписиКалендаряСотрудника.Форма.ФормаЭлемента", ПараметрыФормы, ЭтотОбъект);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьДанныеФормыЗадачи(ЗаписьКалендаряНалоговойОтчетности)
	
	Результат = Новый Структура("ИмяФормы, ПараметрыФормы", "", Новый Структура);
	
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗаписьКалендаряНалоговойОтчетности, "Состояние,Организация,СобытиеКалендаря");
	
	Если Не ЗначениеЗаполнено(ЗначенияРеквизитов.СобытиеКалендаря) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Результат.ПараметрыФормы.Вставить("Состояние", ЗначенияРеквизитов.Состояние);
	Результат.ПараметрыФормы.Вставить("Организация", ЗначенияРеквизитов.Организация);
	Результат.ПараметрыФормы.Вставить("СобытиеКалендаря", ЗначенияРеквизитов.СобытиеКалендаря);
	
	Задача = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЗначенияРеквизитов.СобытиеКалендаря, "Задача");
	Если Не ЗначениеЗаполнено(Задача) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Результат.ИмяФормы = Справочники.ЗаписиКалендаряПодготовкиОтчетности.ПолучитьИмяФормыПоЗадачеИСостоянию(Задача, ЗначенияРеквизитов.Состояние);
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура ВосстановитьНастройки()
	
	//Восстановление настроек календаря
	ВариантПериода = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
		"ВариантПериода",
		Элементы.ВариантПериода.СписокВыбора[0].Значение
	);
	
	НастройкиОтображения = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
		"Отображение",
		Неопределено
	);
	
	Если НастройкиОтображения = Неопределено Тогда
		
		НастройкиОтображения = Новый Структура;
		НастройкиОтображения.Вставить("НачалоРабочегоДня",		0);
		НастройкиОтображения.Вставить("ОкончаниеРабочегоДня",	23);
		НастройкиОтображения.Вставить("ОтображатьТекущуюДату",	Истина);
		
	КонецЕсли;
	
	Планировщик.ШкалаВремени.Элементы[0].ФорматДня = ФорматДняШкалыВремени.ДеньМесяцаДеньНедели;
	
	ДатаОтображения = ТекущаяДатаСеанса();
	ВыделитьДатыОтображения(ЭтотОбъект);
	УстановитьПредставлениеПериода(ЭтотОбъект);
	
	//Настройки пользователя
	СотрудникТекущегоПользователя = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеПоУмолчаниюПользователя(
		Пользователи.ТекущийПользователь(), "ОсновнойОтветственный"
		);
	ОсновнойКалендарьСотрудника   = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеПоУмолчаниюПользователя(
		Пользователи.ТекущийПользователь(), "ОсновнойКалендарь"
		);
		
	СохраненноеЗначение = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКонтактЦентра", "КонтактЦентра_ОтображатьПодсказкуДоски");
	Если СохраненноеЗначение  <> Неопределено Тогда
		ОтображатьПодсказкуДоски = СохраненноеЗначение;
	КонецЕсли;

	// Восстановление настроек отборов
	Для Каждого Список Из СпискиФормы() Цикл
		РаботаСОтборами.ВосстановитьНастройкиОтборов(ЭтотОбъект, Список,,,Новый Структура("ОтборПериод", "ДатаНачала"));
	КонецЦикла;
	ВидыКонтактЦентра = ХранилищеСистемныхНастроек.Загрузить("ВариантПредставления", "ВариантПредставления_КонтактЦентр");
	ТекущаяДоска = ХранилищеСистемныхНастроек.Загрузить("ТекущаяДоска", "ТекущаяДоска_КонтактЦентр");
	
	Если НЕ ЗначениеЗаполнено(ТекущаяДоска) Тогда
		ТекущаяДоска = ОсновнойКалендарьСотрудника;
	КонецЕсли;
	
	Если ОбщегоНазначения.ЭтоМобильныйКлиент() И ВидыКонтактЦентра = 1 
		ИЛИ ВидыКонтактЦентра = 3 ИЛИ  ВидыКонтактЦентра = 4 Тогда
		ВидыКонтактЦентра = 0;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиИОбновитьДанныеПланировщикаСервер()
	
	СохранитьНастройки();
	ОбновитьДанныеВсехВидовКонтактЦентра();	
	
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройки()
	
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиКалендаряСотрудника",
		"ВариантПериода",
		ВариантПериода
	);
	
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиКалендаряСотрудника",
		"Отображение",
		НастройкиОтображения
	);
	
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиКонтактЦентра", "КонтактЦентр_ОтображатьПодсказкуДоски", ОтображатьПодсказкуДоски);

	СохранитьНастройкиДоступныхКалендарей();
	
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиДоступныхКалендарей()
	
	НастройкиДоступныхКалендарей = РеквизитФормыВЗначение("ДоступныеКалендари");
	НастройкиДоступныхКалендарей.Колонки.Удалить("Наименование");
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить("НастройкиКалендаряСотрудника",
		"ДоступныеКалендари",
		НастройкиДоступныхКалендарей
	);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеПланировщикаСервер()
	
	Планировщик.Элементы.Очистить();
	Планировщик.ИнтервалыФона.Очистить();
	
	УстановитьОтображениеПланировщика();
	
	ПериодДанных = ПолучитьПериодДанных(ВариантПериода, ДатаОтображения);
	
	Планировщик.ТекущиеПериодыОтображения.Очистить();
	Планировщик.ТекущиеПериодыОтображения.Добавить(ПериодДанных.ДатаНачала, ПериодДанных.ДатаОкончания);
	
	ВыбранныеКалендари = Новый Массив;
	Для Каждого СтрокаКалендаря Из ДоступныеКалендари Цикл
		Если СтрокаКалендаря.Выбран Тогда
			ВыбранныеКалендари.Добавить(СтрокаКалендаря.Календарь);
		КонецЕсли;
	КонецЦикла;
	
	ТекстПоЗаказуНаПроизводство = "";
	Если ПравоДоступа("Чтение", Метаданные.Документы.ЗаказНаПроизводство, Пользователи.АвторизованныйПользователь()) Тогда
		ТекстПоЗаказуНаПроизводство = 
		"ВЫБРАТЬ
		|	ЗаказНаПроизводство.Ссылка
		|ИЗ
		|	Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
		|ГДЕ
		|	ЗаказНаПроизводство.Ссылка В
		|			(ВЫБРАТЬ
		|				втИсточники.Источник
		|			ИЗ
		|				втИсточники)
		|
		|ОБЪЕДИНИТЬ ВСЕ";
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ЗаписиКалендаря.Источник КАК Источник
		|ПОМЕСТИТЬ втИсточники
		|ИЗ
		|	Справочник.ЗаписиКалендаряСотрудника КАК ЗаписиКалендаря
		|ГДЕ
		|	ЗаписиКалендаря.ПометкаУдаления = ЛОЖЬ
		|	И ЗаписиКалендаря.Начало < &ДатаОкончания
		|	И ЗаписиКалендаря.Окончание > &ДатаНачала
		|	И ЗаписиКалендаря.Календарь В(&ВыбранныеКалендари)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Событие.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ втРазрешенныеИсточники
		|ИЗ
		|	Документ.Событие КАК Событие
		|ГДЕ
		|	Событие.Ссылка В
		|			(ВЫБРАТЬ
		|				втИсточники.Источник
		|			ИЗ
		|				втИсточники)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаданиеНаРаботу.Ссылка
		|ИЗ
		|	Документ.ЗаданиеНаРаботу КАК ЗаданиеНаРаботу
		|ГДЕ
		|	ЗаданиеНаРаботу.Ссылка В
		|			(ВЫБРАТЬ
		|				втИсточники.Источник
		|			ИЗ
		|				втИсточники)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка
		|ИЗ
		|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
		|ГДЕ
		|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка В
		|			(ВЫБРАТЬ
		|				втИсточники.Источник
		|			ИЗ
		|				втИсточники)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО
		|
		|ОБЪЕДИНИТЬ ВСЕ 
		|
		|"
		+ ТекстПоЗаказуНаПроизводство+
		" ВЫБРАТЬ
		|	ЗаказПокупателя.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
		|ГДЕ
		|	ЗаказПокупателя.Ссылка В
		|			(ВЫБРАТЬ
		|				втИсточники.Источник
		|			ИЗ
		|				втИсточники)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗаписиКалендаряСотрудника.Ссылка КАК ЗаписьКалендаря,
		|	ЗаписиКалендаряСотрудника.Наименование КАК Наименование,
		|	ЗаписиКалендаряСотрудника.Начало КАК Начало,
		|	ЗаписиКалендаряСотрудника.Начало КАК Дата,
		|	ЗаписиКалендаряСотрудника.Окончание КАК Конец,
		|	ЗаписиКалендаряСотрудника.Описание КАК Описание,
		|	ЗаписиКалендаряСотрудника.Источник КАК Источник,
		|	ЗаписиКалендаряСотрудника.НомерСтрокиИсточника КАК НомерСтрокиИсточника,
		|	ЗаписиКалендаряСотрудника.Календарь КАК Календарь,
		|	ЗаписиКалендаряСотрудника.РедактированиеЗапрещено КАК РедактированиеЗапрещено
		|ИЗ
		|	Справочник.ЗаписиКалендаряСотрудника КАК ЗаписиКалендаряСотрудника
		|ГДЕ
		|	ЗаписиКалендаряСотрудника.Источник В
		|			(ВЫБРАТЬ
		|				втРазрешенныеИсточники.Ссылка
		|			ИЗ
		|				втРазрешенныеИсточники)
		|	И ЗаписиКалендаряСотрудника.ПометкаУдаления = ЛОЖЬ
		|	И ЗаписиКалендаряСотрудника.Начало < &ДатаОкончания
		|	И ЗаписиКалендаряСотрудника.Окончание > &ДатаНачала
		|	И ЗаписиКалендаряСотрудника.Календарь В(&ВыбранныеКалендари) 
		|	И &ФильтрПоТегам "
		+СтрокаФильтровКалендарь("ОтветственныйИсточника","Завершено", Ложь)+
		" ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Задачи.Ссылка,
		|	ВЫРАЗИТЬ(Задачи.Описание КАК Строка(1000)),
		|	Задачи.ДатаНачала,
		|	Задачи.Дата,
		|	Задачи.ДатаОкончания,
		|	Задачи.Описание,
		|	Задачи.Основание,
		|	0,
		|	Задачи.Календарь,
		|	ЛОЖЬ
		|ИЗ
		|	Документ.ЗадачаСотрудника КАК Задачи
		|ГДЕ
		|	Задачи.ПометкаУдаления = ЛОЖЬ
		|	И Задачи.ДатаНачала < &ДатаОкончания
		|	И Задачи.ДатаОкончания > &ДатаНачала
		|	И Задачи.Календарь В (&ВыбранныеКалендари) "
		+ СтрокаФильтровКалендарь("Ответственный","Выполнена", Истина) +
		" УПОРЯДОЧИТЬ ПО
		|	Начало";
	
	Запрос.УстановитьПараметр("ДатаНачала", ПериодДанных.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", ПериодДанных.ДатаОкончания);
	Запрос.УстановитьПараметр("ВыбранныеКалендари", ВыбранныеКалендари);
	Запрос.УстановитьПараметр("ФильтрПоТегам", Истина);
	УстановитьПараметрыФильтров(Запрос);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Отбор = Новый Структура("Календарь");
	
	Пока Выборка.Следующий() Цикл
		
		ЭлементПланировщика = Планировщик.Элементы.Добавить(Выборка.Начало, Выборка.Конец);
		ЭлементПланировщика.Значение = Новый Структура;
		ЭлементПланировщика.Значение.Вставить("Календарь", Выборка.Календарь);
		ЭлементПланировщика.Значение.Вставить("ЗаписьКалендаря", Выборка.ЗаписьКалендаря);
		ЭлементПланировщика.Значение.Вставить("Источник", Выборка.Источник);
		ЭлементПланировщика.Значение.Вставить("РедактированиеЗапрещено", Выборка.РедактированиеЗапрещено);
		ЭлементПланировщика.Значение.Вставить("НомерСтрокиИсточника", Выборка.НомерСтрокиИсточника);
		ЭлементПланировщика.Текст		= Выборка.Наименование;
		ЭлементПланировщика.Подсказка	= Выборка.Описание;
		
		Если ЗначениеЗаполнено(Выборка.Источник) И ТипЗнч(Выборка.ЗаписьКалендаря) <> Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			МенеджерИсточника = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Выборка.Источник);
			ЭлементПланировщика.Картинка = МенеджерИсточника.КартинкаЗаписиКалендаря(Выборка.Источник);
			ЭлементПланировщика.ЦветТекста = МенеджерИсточника.ЦветТекстаЗаписиКалендаря(Выборка.Источник);
		КонецЕсли;
		
		Если ТипЗнч(Выборка.ЗаписьКалендаря) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			ЭлементПланировщика.Картинка = БиблиотекаКартинок.ЗадачаСотрудника;
		КонецЕсли;
		
		Отбор.Календарь = Выборка.Календарь;
		НайденныеСтроки = ДоступныеКалендари.НайтиСтроки(Отбор);
		Если НайденныеСтроки.Количество() > 0 Тогда
			ЭлементПланировщика.ЦветФона = РаботаСЦветомКлиентСервер.ЦветПоНомеруКартинки(НайденныеСтроки[0].ВариантЦвета);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ВидыКонтактЦентра = 2 Тогда
		ТекущийЭлемент = Элементы.Планировщик;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция СтрокаФильтровКалендарь(ИмяПоляОтветственный, ИмяПоляЗавершено, ЕстьПолеТег)
	
	МассивСтрок = Новый Массив;
	
	Для Каждого ЭлементОтбора Из ВРаботе.КомпоновщикНастроек.Настройки.Отбор.Элементы Цикл
		Если ЭлементОтбора.Представление = "Период" Тогда
			Продолжить;
		КонецЕсли;
		Если (ТипЗнч(ЭлементОтбора.ПравоеЗначение) = Тип("Массив") ИЛИ ТипЗнч(ЭлементОтбора.ПравоеЗначение) = Тип("СписокЗначений"))
			И ЭлементОтбора.ПравоеЗначение.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		Если НЕ ЭлементОтбора.Использование Тогда
			Продолжить;
		КонецЕсли;
		Если Строка(ЭлементОтбора.ЛевоеЗначение) = "Теги.Тег" И ЕстьПолеТег Тогда
			МассивСтрок.Добавить(" И Теги.Тег В (&Теги) ");
		ИначеЕсли Строка(ЭлементОтбора.ЛевоеЗначение) = "Ответственный" Тогда
			МассивСтрок.Добавить(СтрШаблон(" И %1 В (&Ответственный) ", ИмяПоляОтветственный));
		КонецЕсли;
	КонецЦикла;
	
	Если ОтборЗавершенные Тогда
		МассивСтрок.Добавить(" И ИСТИНА ");
	Иначе
		МассивСтрок.Добавить(СтрШаблон(" И НЕ %1 ", ИмяПоляЗавершено));
	КонецЕсли;
	
	СтрокаФильтров = СтрСоединить(МассивСтрок, Символы.ПС);
	
	Возврат СтрокаФильтров;
	
КонецФункции

&НаСервере
Процедура УстановитьОтображениеПланировщика()
	
	Если ВариантПериода = "День" Тогда
		
		Планировщик.ОтображатьТекущуюДату = НастройкиОтображения.ОтображатьТекущуюДату;
		Планировщик.ЕдиницаПериодическогоВарианта = ТипЕдиницыШкалыВремени.Час;
		Планировщик.КратностьПериодическогоВарианта = 24;
		Планировщик.ОтступСНачалаПереносаШкалыВремени = НастройкиОтображения.НачалоРабочегоДня;
		Планировщик.ОтступСКонцаПереносаШкалыВремени = ?(НастройкиОтображения.ОкончаниеРабочегоДня = 0, 0, 24 - НастройкиОтображения.ОкончаниеРабочегоДня);
		Планировщик.ОтображатьПеренесенныеЗаголовкиШкалыВремени = Ложь;
		Планировщик.ОтображениеВремениЭлементов = ОтображениеВремениЭлементовПланировщика.ВремяНачалаИКонца;
		Планировщик.ФорматПеренесенныхЗаголовковШкалыВремени = "ДФ='dddd, d MMMM yyyy'";
		Планировщик.ШкалаВремени.Положение = ПоложениеШкалыВремени.Лево;
		Планировщик.ШкалаВремени.Элементы[0].Формат = "ДФ=ЧЧ:мм";
		Планировщик.ШкалаВремени.Элементы[0].Кратность = 1;
		Планировщик.ШкалаВремени.Элементы[0].Единица = ТипЕдиницыШкалыВремени.Час;
		
	ИначеЕсли ВариантПериода = "Неделя" Тогда
		
		Планировщик.ОтображатьТекущуюДату = НастройкиОтображения.ОтображатьТекущуюДату;
		Планировщик.ЕдиницаПериодическогоВарианта = ТипЕдиницыШкалыВремени.Час;
		Планировщик.КратностьПериодическогоВарианта = 24;
		Планировщик.ОтступСНачалаПереносаШкалыВремени = НастройкиОтображения.НачалоРабочегоДня;
		Планировщик.ОтступСКонцаПереносаШкалыВремени = ?(НастройкиОтображения.ОкончаниеРабочегоДня = 0, 0, 24 - НастройкиОтображения.ОкончаниеРабочегоДня);
		Планировщик.ОтображатьПеренесенныеЗаголовки = Истина;
		Планировщик.ОтображатьПеренесенныеЗаголовкиШкалыВремени = Ложь;
		Планировщик.ОтображениеВремениЭлементов = ОтображениеВремениЭлементовПланировщика.НеОтображать;
		Планировщик.ФорматПеренесенныхЗаголовковШкалыВремени = "ДФ='ddd, d MMMM'";
		Планировщик.ШкалаВремени.Положение = ПоложениеШкалыВремени.Лево;
		Планировщик.ШкалаВремени.Элементы[0].Формат = "ДФ=ЧЧ:мм";
		Планировщик.ШкалаВремени.Элементы[0].Кратность = 1;
		Планировщик.ШкалаВремени.Элементы[0].Единица = ТипЕдиницыШкалыВремени.Час;
		
	ИначеЕсли ВариантПериода = "Месяц" Тогда
		
		Планировщик.ОтображатьТекущуюДату = Ложь;
		Планировщик.ЕдиницаПериодическогоВарианта = ТипЕдиницыШкалыВремени.День;
		Планировщик.КратностьПериодическогоВарианта = 7;
		Планировщик.ОтступСНачалаПереносаШкалыВремени = 0;
		Планировщик.ОтступСКонцаПереносаШкалыВремени = 0;
		Планировщик.ОтображатьПеренесенныеЗаголовки = Ложь;
		Планировщик.ОтображатьПеренесенныеЗаголовкиШкалыВремени = Истина;
		Планировщик.ОтображениеВремениЭлементов = ОтображениеВремениЭлементовПланировщика.НеОтображать;
		Планировщик.ФорматПеренесенныхЗаголовковШкалыВремени = "ДФ='ddd, d MMM yyyy'";
		Планировщик.ШкалаВремени.Положение = ПоложениеШкалыВремени.Верх;
		Планировщик.ШкалаВремени.Элементы[0].Формат = "ДФ='ddd, d MMM yyyy'";
		Планировщик.ШкалаВремени.Элементы[0].Кратность = 1;
		Планировщик.ШкалаВремени.Элементы[0].Единица = ТипЕдиницыШкалыВремени.День;
		
		Интервал = Планировщик.ИнтервалыФона.Добавить(НачалоМесяца(ДатаОтображения), КонецМесяца(ДатаОтображения));
		Интервал.Цвет = Новый Цвет(250, 250, 250);
		Если НастройкиОтображения.ОтображатьТекущуюДату Тогда
			ТекущаяДатаСеанса = ТекущаяДатаСеанса();
			Интервал = Планировщик.ИнтервалыФона.Добавить(НачалоДня(ТекущаяДатаСеанса), КонецДня(ТекущаяДатаСеанса));
			Интервал.Цвет = Новый Цвет(223, 255, 223);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПолучитьПериодДанных(ВариантПериода, ДатаОтображения)
	
	Результат = Новый Структура("ДатаНачала, ДатаОкончания");
	
	Если ВариантПериода = "День" Тогда
		Результат.ДатаНачала	= НачалоДня(ДатаОтображения);
		Результат.ДатаОкончания	= КонецДня(ДатаОтображения);
	ИначеЕсли ВариантПериода = "Неделя" Тогда
		Результат.ДатаНачала	= НачалоНедели(ДатаОтображения);
		Результат.ДатаОкончания	= КонецНедели(ДатаОтображения);
	ИначеЕсли ВариантПериода = "Месяц" Тогда
		Результат.ДатаНачала	= НачалоНедели(НачалоМесяца(ДатаОтображения));
		Результат.ДатаОкончания	= КонецНедели(КонецМесяца(ДатаОтображения));
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция СохранитьИзмененияВБазу(ОбрабатываемыеЭлементы)
	
	Возврат Справочники.ЗаписиКалендаряСотрудника.СохранитьИзмененияЗаписейКалендарей(ОбрабатываемыеЭлементы);
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура ВыделитьДатыОтображения(Форма)
	
	ПолеКалендаря = Форма.Элементы.ДатаОтображения;
	
	ПолеКалендаря.ВыделенныеДаты.Очистить();
	
	Если Форма.ВариантПериода = "Месяц" Тогда
		// Для варианта "Месяц" выделенные даты календаря отличаются от фактического периода.
		// Фактический период должен быть кратен 7 дням (недели).
		// Но в поле календаря выделяются даты только в пределах месяца.
		ПериодДанных = Новый Структура("ДатаНачала, ДатаОкончания");
		ПериодДанных.ДатаНачала		= НачалоМесяца(Форма.ДатаОтображения);
		ПериодДанных.ДатаОкончания	= КонецМесяца(Форма.ДатаОтображения);
	Иначе
		ПериодДанных = ПолучитьПериодДанных(Форма.ВариантПериода, Форма.ДатаОтображения);
	КонецЕсли;
	
	ТекДата = ПериодДанных.ДатаНачала;
	
	Пока ТекДата < ПериодДанных.ДатаОкончания Цикл
		ПолеКалендаря.ВыделенныеДаты.Добавить(ТекДата);
		ТекДата = ТекДата + 86400;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьДанныеПланировщикаКлиент()
	
	ОбновитьДанныеПланировщикаИЗадачиНаВесьДень();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтборПоКалендарюИПоРазрешеннымИсточникам()
	УстановитьОтборПоКалендарю();
	УстановитьОтборПоРазрешеннымИсточникам();
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДоступныхКалендарей()
	
	УдаляемыеЭлементы = Новый Массив;
	
	Для Каждого ГруппаЭлементов Из Элементы.ДоступныеКалендари.ПодчиненныеЭлементы Цикл
		УдаляемыеЭлементы.Добавить(ГруппаЭлементов);
	КонецЦикла;
	
	Для Каждого УдаляемыйЭлемент Из УдаляемыеЭлементы Цикл
		Элементы.Удалить(УдаляемыйЭлемент);
	КонецЦикла;
	
	Для Каждого СтрокаКалендаря Из ДоступныеКалендари Цикл
		
		Индекс = ДоступныеКалендари.Индекс(СтрокаКалендаря);
		
		Если СтрокаКалендаря.Недействителен Тогда
			Продолжить;
		КонецЕсли;
		
		ГруппаКалендаря = Элементы.Добавить("ГруппаКалендарь_" + Индекс, Тип("ГруппаФормы"), Элементы.ДоступныеКалендари);
		ГруппаКалендаря.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаКалендаря.Отображение = ОтображениеОбычнойГруппы.Нет;
		ГруппаКалендаря.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
		ГруппаКалендаря.ОтображатьЗаголовок = Ложь;
		
		ФлагВыбран = Элементы.Добавить("ВыбранКалендарь_" + Индекс, Тип("ПолеФормы"), ГруппаКалендаря);
		ФлагВыбран.Вид = ВидПоляФормы.ПолеФлажка;
		ФлагВыбран.ПутьКДанным = "ДоступныеКалендари[" + Индекс + "].Выбран";
		ФлагВыбран.Заголовок = СтрокаКалендаря.Наименование;
		ФлагВыбран.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Право;
		ФлагВыбран.УстановитьДействие("ПриИзменении", "Подключаемый_ВыбранКалендарьПриИзменении");
		
		ДекорацияОтступ = Элементы.Добавить("ОтступКалендарь_" + Индекс, Тип("ДекорацияФормы"), ГруппаКалендаря);
		ДекорацияОтступ.РастягиватьПоГоризонтали = Истина;
		
		КартинкаЦвета = Элементы.Добавить("ЦветКалендарь_" + Индекс, Тип("ДекорацияФормы"), ГруппаКалендаря);
		КартинкаЦвета.Вид = ВидДекорацииФормы.Картинка;
		КартинкаЦвета.Картинка = РаботаСЦветомКлиентСервер.КартинкаЦветаПоНомеруКартинки(СтрокаКалендаря.ВариантЦвета);
		КартинкаЦвета.Гиперссылка = Истина;
		КартинкаЦвета.Ширина = 2;
		КартинкаЦвета.Высота = 1;
		КартинкаЦвета.УстановитьДействие("Нажатие", "Подключаемый_ЦветКалендарьНажатие");
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьПараметрыФильтров(Запрос)
	
	Для Каждого ЭлементОтбора Из ВРаботе.КомпоновщикНастроек.Настройки.Отбор.Элементы Цикл
		Если ЭлементОтбора.Представление = "Период" Тогда
			Продолжить;
		КонецЕсли;
		Если ТипЗнч(ЭлементОтбора.ПравоеЗначение) = Тип("Массив") И ЭлементОтбора.ПравоеЗначение.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		Если Строка(ЭлементОтбора.ЛевоеЗначение) = "Теги.Тег" Тогда
			Запрос.УстановитьПараметр("ФильтрПоТегам", ЭлементОтбора.ПравоеЗначение.Количество()=0);
			Запрос.УстановитьПараметр("Теги",ЭлементОтбора.ПравоеЗначение);
		ИначеЕсли Строка(ЭлементОтбора.ЛевоеЗначение) = "Ответственный" Тогда
			Запрос.УстановитьПараметр("Ответственный",ЭлементОтбора.ПравоеЗначение);
		КонецЕсли; 
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьЗаписьКалендаряСервер()
	
	ПрочитатьДоступныеКалендари();
	УстановитьОтборПоКалендарю();
	УстановитьОтборПоРазрешеннымИсточникам();
	ОбновитьЭлементыТекущейДоски();
	ОбновитьДанныеВсехВидовКонтактЦентра();
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция КоличествоВариантовЦветов()
	
	Возврат 24;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция УпорядоченныеВариантыЦветов()
	
	ПервыйВариантЦвета = 14;
	
	УпорядоченныеВариантыЦветов = Новый Массив;
	Для НомерЦвета = ПервыйВариантЦвета По КоличествоВариантовЦветов() Цикл
		УпорядоченныеВариантыЦветов.Добавить(НомерЦвета);
	КонецЦикла;
	Для НомерЦвета = 1 По ПервыйВариантЦвета - 1 Цикл
		УпорядоченныеВариантыЦветов.Добавить(НомерЦвета);
	КонецЦикла;
	
	Возврат УпорядоченныеВариантыЦветов;
	
КонецФункции

&НаСервере
Процедура ПрочитатьДоступныеКалендари()
	
	ДоступныеКалендари.Очистить();
	
	НастройкиДоступныхКалендарей = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить("НастройкиКалендаряСотрудника",
		"ДоступныеКалендари",
		Новый ТаблицаЗначений);
	
	Если НастройкиДоступныхКалендарей.Количество() = 0 Тогда
		ЗанятыеЦвета = Новый Массив;
	Иначе
		ЗанятыеЦвета = ОбщегоНазначения.ВыгрузитьКолонку(НастройкиДоступныхКалендарей, "ВариантЦвета", Истина);
	КонецЕсли;
	ЕстьНовыеПрисвоенныеЦвета = Ложь;
	
	ТаблицаКалендарей = Справочники.КалендариСотрудников.ДоступныеСотрудникуКалендари(,Ложь);
	
	Для Каждого СтрокаТаблицы Из ТаблицаКалендарей Цикл
		
		НоваяСтрока = ДоступныеКалендари.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы, "Календарь,Наименование, Недействителен");
		НоваяСтрока.Личный = СтрокаТаблицы.КоличествоСотрудников = 0;
		
		НайденнаяСтрока = НастройкиДоступныхКалендарей.Найти(СтрокаТаблицы.Календарь);
		Если НайденнаяСтрока <> Неопределено Тогда
			ЗаполнитьЗначенияСвойств(НоваяСтрока, НайденнаяСтрока, "ВариантЦвета,Выбран");
		КонецЕсли;
		
		Если НоваяСтрока.ВариантЦвета = 0 Тогда
			Для каждого ВариантЦвета Из УпорядоченныеВариантыЦветов() Цикл
				Если ЗанятыеЦвета.Найти(ВариантЦвета) = Неопределено Тогда
					НоваяСтрока.ВариантЦвета = ВариантЦвета;
					ЗанятыеЦвета.Добавить(ВариантЦвета);
					Прервать;
				КонецЕсли;
			КонецЦикла;
			ЕстьНовыеПрисвоенныеЦвета = Истина;
		КонецЕсли;
		
		Если ЗанятыеЦвета.Количество() = КоличествоВариантовЦветов() Тогда
			ЗанятыеЦвета.Очистить();
		КонецЕсли;
		
	КонецЦикла;
	
	Отбор = Новый Структура("Выбран", Истина);
	Если ДоступныеКалендари.НайтиСтроки(Отбор).Количество() = 0 Тогда
		
		Отбор.Удалить("Выбран");
		Отбор.Вставить("Календарь");
		Для Каждого СтрокаКалендаря Из ДоступныеКалендари Цикл
			Отбор.Календарь = СтрокаКалендаря.Календарь;
			СтрокаКалендаря.Выбран = ТаблицаКалендарей.НайтиСтроки(Отбор)[0].ЯвляетсяВладельцем;
		КонецЦикла;
		
	КонецЕсли;
	
	Если ЕстьНовыеПрисвоенныеЦвета Тогда
		СохранитьНастройкиДоступныхКалендарей();
	КонецЕсли;
	
	ОбновитьЭлементыДоступныхКалендарей();
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьПредставлениеПериода(Форма)
	
	Если Форма.ВариантПериода = "День" Тогда
		
		Форма.ПредставлениеПериодаКалендарь = Формат(Форма.ДатаОтображения, "ДФ='дддд, д МММ'");
		Форма.Элементы.ГруппаПредставлениеПериода.Заголовок = Форма.ПредставлениеПериодаКалендарь;
	ИначеЕсли Форма.ВариантПериода = "Неделя" Тогда
		
		ПериодДанных = ПолучитьПериодДанных(Форма.ВариантПериода, Форма.ДатаОтображения);
		Форма.ПредставлениеПериодаКалендарь = СтрШаблон(
			"%1 - %2",
			Формат(ПериодДанных.ДатаНачала, "ДФ='д МММ'"),
			Формат(ПериодДанных.ДатаОкончания, "ДФ='д МММ гггг'")
		);
		Форма.Элементы.ГруппаПредставлениеПериода.Заголовок = Форма.ПредставлениеПериодаКалендарь;
	ИначеЕсли Форма.ВариантПериода = "Месяц" Тогда
		
		Форма.ПредставлениеПериодаКалендарь = ПредставлениеПериода(НачалоМесяца(Форма.ДатаОтображения), КонецМесяца(Форма.ДатаОтображения));
		Форма.Элементы.ГруппаПредставлениеПериода.Заголовок = Форма.ПредставлениеПериодаКалендарь;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область МеткиОтборов

&НаСервере
Процедура УстановитьМеткуИОтборСписка(ИмяПоляОтбораСписка, ГруппаРодительМетки, ВыбранноеЗначение, ПредставлениеЗначения="")
	
	Если ПредставлениеЗначения="" Тогда
		ПредставлениеЗначения=Строка(ВыбранноеЗначение);
	КонецЕсли;
	
	РаботаСОтборами.ПрикрепитьМеткуОтбора(ЭтотОбъект, ИмяПоляОтбораСписка, ГруппаРодительМетки, ВыбранноеЗначение, ПредставлениеЗначения,
	,,,"ФильтрыНастройкиИДопИнфо","ОтборТеги,ОтборОтветственный,ОтборЗавершенные");
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ВРаботе, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиПросрочены, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаСегодня, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаЗавтра, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиБезСрока, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиПозже, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаНеделе, ИмяПоляОтбораСписка,,Истина);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиЗавершены, ИмяПоляОтбораСписка,,Истина);
	
	Для Каждого Колонка Из КолонкиТекущейДоски Цикл
		Индекс = КолонкиТекущейДоски.Индекс(Колонка);
		РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЭтотОбъект["СписокДел_"+Строка(Индекс)], ИмяПоляОтбораСписка,,Истина);
	КонецЦикла;
	
	УстановитьЗаголовокГруппыОтборов();
	УстановитьОтображениеОтветственного();
	УправлениеФормой();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеОтветственного()
	
	Для Каждого Отбор Из ВРаботе.КомпоновщикНастроек.Настройки.Отбор.Элементы Цикл
		Если ТипЗнч(Отбор) = Тип("ГруппаЭлементовОтбораКомпоновкиДанных") ИЛИ Строка(Отбор.ЛевоеЗначение) <> "Ответственный" Тогда
			Продолжить;
		КонецЕсли;
		
		ОтборПоОтветственному = ТипЗнч(Отбор.ПравоеЗначение) = Тип("СписокЗначений") И Отбор.ПравоеЗначение.Количество() = 1;
		
		Элементы.ВРаботеОтветственный.Видимость = НЕ ОтборПоОтветственному;
		Элементы.ВРаботеФильтрОтветственный.Видимость = ОтборПоОтветственному;
	КонецЦикла;
КонецПроцедуры

//@skip-warning
&НаКлиенте
Процедура Подключаемый_МеткаОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	МеткаИД = Сред(Элемент.Имя, СтрДлина("Метка_")+1);
	УдалитьМеткуОтбора(МеткаИД);
	
КонецПроцедуры

&НаСервере
Процедура УдалитьМеткуОтбора(МеткаИД)
	
	СтрокаМеток = ДанныеМеток[Число(МеткаИД)];
	ИмяПоляОтбора = СтрокаМеток.ИмяПоляОтбора;
	РаботаСОтборами.УдалитьМеткуОтбораСервер(ЭтотОбъект, ВРаботе, МеткаИД,,,,"ФильтрыНастройкиИДопИнфо","ОтборТеги,ОтборОтветственный,ОтборЗавершенные");
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиПросрочены, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаЗавтра, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиБезСрока, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиПозже, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаНеделе, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиНаСегодня, ИмяПоляОтбора);
	РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЗадачиЗавершены, ИмяПоляОтбора);
	
	Для Каждого Колонка Из КолонкиТекущейДоски Цикл
		Индекс = КолонкиТекущейДоски.Индекс(Колонка);
		РаботаСОтборами.УстановитьОтборСписка(ЭтотОбъект, ЭтотОбъект["СписокДел_"+Строка(Индекс)], ИмяПоляОтбора);
	КонецЦикла;
	
	УправлениеФормой();	
	УстановитьЗаголовокГруппыОтборов();
	УстановитьОтображениеОтветственного();
	
КонецПроцедуры

#КонецОбласти

#Область ОбменСGoogle

&НаСервере
Процедура НастроитьВидимостьГруппыСинхронизировать()
	
	ОтключенныеОбластиДоступа = РегистрыСведений.СеансовыеДанныеGoogle.ОтключенныеОбластиДоступа(Пользователи.ТекущийПользователь());
	
	Элементы.ГруппаСинхронизировать.Видимость = ОтключенныеОбластиДоступа.Найти(Перечисления.ОбластиДоступаGoogle.Календарь) = Неопределено И ВидыКонтактЦентра = 2;
	
КонецПроцедуры

&НаКлиенте
Процедура СинхронизироватьНаКлиенте()
	
	Элементы.ГруппаСинхронизировать.ТекущаяСтраница = Элементы.ГруппаПрогрессСинхронизации;
	ПодключитьОбработчикОжидания("ПродолжитьСинхронизироватьНаКлиенте", 0.1, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ПродолжитьСинхронизироватьНаКлиенте()
	
	Задание = ЗаданиеСинхронизироватьНаСервере();
	
	Если ОбменСGoogleКлиентСервер.НеЗаполненТокенДоступа(СеансовыеДанные) Тогда
		НачатьАвторизацию();
	КонецЕсли;
	
	Если Задание = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ОбработатьЗавершениеСинхронизации", ЭтотОбъект);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(Задание, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

&НаКлиенте
Процедура НачатьАвторизацию()
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьРезультатЗапросаТокена", ЭтотОбъект);
	ОткрытьФорму(
	"РегистрСведений.СеансовыеДанныеGoogle.Форма.ЗапросТокена",
	Новый Структура("ОписанияОбластейДоступа", ОбменСGoogleКлиентСервер.ОписанияОбластейДоступаКалендарь()),
	ЭтаФорма,,,,
	ОписаниеОповещения);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьРезультатЗапросаТокена(Результат, Параметры) Экспорт
	
	СеансовыеДанные = Результат;
	
	Если ОбменСGoogleКлиентСервер.НеЗаполненТокенДоступа(СеансовыеДанные) Тогда
		Элементы.ГруппаСинхронизировать.ТекущаяСтраница = Элементы.ГруппаКомандаСинхронизировать;
		Возврат;
	КонецЕсли;
	
	СинхронизироватьНаКлиенте();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьЗавершениеСинхронизации(Результат, Параметры) Экспорт
	
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	Если Не Результат.Свойство("Статус") Тогда
		Возврат;
	КонецЕсли;
	
	Элементы.ГруппаСинхронизировать.ТекущаяСтраница = Элементы.ГруппаКомандаСинхронизировать;
	
	Если Результат.Статус = "Выполнено" Тогда
		
		ОповеститьОбИзменении(Тип("СправочникСсылка.ЗаписиКалендаряСотрудника"));
		ОповеститьОбИзменении(Тип("СправочникСсылка.КалендариСотрудников"));
		ОбработатьЗаписьКалендаряСервер();
		
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		
		ОбщегоНазначенияКлиент.СообщитьПользователю(Результат.ПодробноеПредставлениеОшибки);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЗаданиеСинхронизироватьНаСервере()
	
	// Здесь у функции есть побочный эффект - инициализация сеансовых данных.
	// Так сделано для экономии серверного вызова.
	ОбменСGoogle.ИнициализироватьУзелПланаОбменаДляКалендаряGoogle();
	ОбменСGoogle.ИнициализироватьСеансовыеДанные(
	СеансовыеДанные,
	Пользователи.ТекущийПользователь(),
	Перечисления.ОбластиДоступаGoogle.Календарь);
	
	Если ОбменСGoogleКлиентСервер.НеЗаполненТокенДоступа(СеансовыеДанные) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификатор);
	ПараметрыВыполнения.ОжидатьЗавершение = 0;
	
	Результат = ДлительныеОперации.ВыполнитьВФоне(
	"ОбменСGoogle.СинхронизироватьGoogleCalendar",
	СеансовыеДанные,
	ПараметрыВыполнения);
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция СтрокаДаты(Начало, Окончание, Список)
	
	СекундВДне = 86400;
	ДеньНачала  = Формат(Начало, "ДФ=дд.ММ.гг");
	ВремяНачала = Формат(Начало, "ДФ=Ч:мм");
	ВремяОкончания = Формат(Окончание, "ДФ=Ч:мм");
	ДеньОкончания = Формат(Окончание, "ДФ=дд.ММ.гг");
	
	ЗадачаБезВремени = Час(Начало) = 0 И Час(Окончание) = 0 И Минута(Начало) = 0 И Минута(Окончание) = 0;
	Если ЗначениеЗаполнено(Окончание) Тогда
		Продолжительность = НачалоДня(Окончание) - НачалоДня(Начало);
	Иначе
		Продолжительность = 0;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(ДеньНачала) И НЕ ЗначениеЗаполнено(ДеньОкончания) Тогда
		Возврат "";
	КонецЕсли;
	
	Если НачалоДня(Начало) = НачалоДня(ТекущаяДатаСеанса()) И Список = "ВРаботе" Тогда
		ДеньНачала = НСтр("ru = 'сегодня'");
	ИначеЕсли НачалоДня(Начало) = НачалоДня(ТекущаяДатаСеанса() + СекундВДне) И Список = "ВРаботе" Тогда
		ДеньНачала = НСтр("ru = 'завтра'");
	КонецЕсли;
	
	Если ЗадачаБезВремени И Продолжительность = 0 Тогда
		Если Список <> "ЗадачиНаСегодня" И Список <> "ЗадачиНаЗавтра" Тогда
			Возврат СтрШаблон(НСтр("ru ='%1, весь день'"), ДеньНачала);
		Иначе
			Возврат НСтр("ru ='весь день'");
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗадачаБезВремени И Продолжительность = 0 И ЗначениеЗаполнено(Окончание) Тогда
		Если Список <> "ЗадачиНаСегодня" И Список <> "ЗадачиНаЗавтра" Тогда
			Возврат СтрШаблон(НСтр("ru = '%1 %2 - %3'"),ДеньНачала, ВремяНачала, ВремяОкончания);
		Иначе
			Возврат СтрШаблон(НСтр("ru = '%1 - %2'"), ВремяНачала, ВремяОкончания);
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗадачаБезВремени И Продолжительность = 0 И НЕ ЗначениеЗаполнено(Окончание) Тогда
		Если Список <> "ЗадачиНаСегодня" И Список <> "ЗадачиНаЗавтра" Тогда
			Возврат СтрШаблон(НСтр("ru = '%1 %2'"),ДеньНачала, ВремяНачала);
		Иначе
			Возврат СтрШаблон(НСтр("ru = '%1'"), ВремяНачала);
		КонецЕсли;
	КонецЕсли;

	Если ЗадачаБезВремени И Продолжительность > 0 Тогда
		Возврат СтрШаблон(НСтр("ru ='%1 - %2'"), ДеньНачала, ДеньОкончания);
	КонецЕсли;
		
	Если НЕ ЗадачаБезВремени И Продолжительность > 0 Тогда
		Возврат СтрШаблон(НСтр("ru ='%1 %2 - %3 %4'"), ДеньНачала, ВремяНачала, ВремяОкончания, ДеньОкончания);
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

&НаСервереБезКонтекста
Функция КартинкаПоТипуЗадачи(Задача)
	
	Если ТипЗнч(Задача) = Тип("ДокументСсылка.Событие") И Задача.ТипСобытия = Перечисления.ТипыСобытий.ЛичнаяВстреча Тогда
		Возврат 0;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.Событие") И Задача.ТипСобытия =  Перечисления.ТипыСобытий.ТелефонныйЗвонок Тогда
		Возврат 1;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.Событие") И Задача.ТипСобытия =  Перечисления.ТипыСобытий.Прочее Тогда
		Возврат 2;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.Событие") И Задача.ТипСобытия =  Перечисления.ТипыСобытий.Запись Тогда
		Возврат 3;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаказНаПроизводство") Тогда
		Возврат 4;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаданиеНаРаботу") ИЛИ ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		Возврат 5;
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат 6;
	КонецЕсли;
КонецФункции

&НаСервере
Процедура ЗавершитьЗадачуСервер(Задача, Список)
	ЗадачаОбъект = Задача.ПолучитьОбъект();
	ЗадачаОбъект.Выполнена = Истина;
	ЗадачаОбъект.Записать();
	Элементы[Список].Обновить();
КонецПроцедуры

&НаКлиенте
Процедура ВыборОтветственного(Результат, ДополнительныеПараметры) Экспорт
	Если НЕ ЗначениеЗаполнено(Результат) Тогда
		Возврат;
	КонецЕсли;
	Источник = ДополнительныеПараметры.Источник;
	ВыборОтветственногоСервер(Результат, Источник,ДополнительныеПараметры);
	Элементы[ДополнительныеПараметры.Список].Обновить();
	Если ТипЗнч(Источник) = Тип("Строка") Тогда
		ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),
			ПолучитьНавигационнуюСсылку(Новый ИдентификаторОбсужденияСистемыВзаимодействия(Источник))
			,СтрШаблон(НСтр("ru='%1'"),Источник)
			,БиблиотекаКартинок.Информация32);
	Иначе
		ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),ПолучитьНавигационнуюСсылку(Источник),СтрШаблон(НСтр("ru='%1'"),Источник),БиблиотекаКартинок.Информация32);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВыборОтветственногоСервер(Результат, Источник, ДополнительныеПараметры)
	
	Если ТипЗнч(Источник) = Тип("Строка") Тогда
		ВыборОтветственногоМессенджер(Источник, Результат);
		Возврат;
	КонецЕсли;
	
	Попытка
		ИсточникОбъект = Источник.ПолучитьОбъект();
		ИсточникОбъект.Заблокировать();
		Если ТипЗнч(Источник) <> Тип("ДокументСсылка.ЗаданиеНаРаботу") Тогда
			ИсточникОбъект.Ответственный = Результат;
		Иначе
			ИсточникОбъект.Сотрудник = Результат;
		КонецЕсли;
		ИсточникОбъект.Записать();
		ИсточникОбъект.Разблокировать();
		
		Если ДополнительныеПараметры.Список = "Входящее" Тогда
			КонтактЦентр.УдалитьИзВходящего(Источник);
			
			ОписаниеВходящего = КонтактЦентр.ОписаниеВходящего();
			ОписаниеВходящего.Ответственный = Результат;
			КонтактЦентр.ДобавитьВоВходящее(Источник, ОписаниеВходящего);
		КонецЕсли;
	Исключение
		ОбщегоНазначения.СообщитьПользователю(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()), Источник);
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Процедура ВыборОтветственногоМессенджер(Источник, Результат)
	Попытка
		ИдентификаторОбсуждения = Новый ИдентификаторОбсужденияСистемыВзаимодействия(Источник);
		Обсуждение = СистемаВзаимодействия.ПолучитьОбсуждение(ИдентификаторОбсуждения);
		ПользовательСотрудника = РегистрыСведений.СотрудникиПользователя.ПолучитьПользователяПоСотруднику(Результат);
		Обсуждение.Участники.Удалить(СистемаВзаимодействия.ИдентификаторТекущегоПользователя());
		ОбсужденияУНФ.ДобавитьПользователяВОбсуждение(Обсуждение, ПользовательСотрудника);
		ОписаниеВходящего = РегистрыСведений.КонтактЦентрВходящее.ДанныеВходящегоПоИсточнику(Источник);
		КонтактЦентр.УдалитьИзВходящего(Источник);
		КонтактЦентр.ДобавитьВоВходящее(ИдентификаторОбсуждения, ОписаниеВходящего);
	Исключение
		ОбщегоНазначения.СообщитьПользователю(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	Элементы.Входящее.Обновить();
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуЗадачи(ПараметрыПеретаскивания, Список = Неопределено, Создание = Ложь)
	
	ЗначенияЗаполнения = Новый Структура;
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("СозданиеЗадачиКонтактЦентр", Истина);
	
	Если ПараметрыПеретаскивания.Свойство("ЗаписьКалендаря") И ЗначениеЗаполнено(ПараметрыПеретаскивания.ЗаписьКалендаря)
		И ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("СправочникСсылка.ЗаписиКалендаряПодготовкиОтчетности") Тогда
		
		ДанныеФормыЗадачи = ПолучитьДанныеФормыЗадачи(ПараметрыПеретаскивания.Значение);
		Если Не ПустаяСтрока(ДанныеФормыЗадачи.ИмяФормы) Тогда
			ОткрытьФорму(ДанныеФормыЗадачи.ИмяФормы, ДанныеФормыЗадачи.ПараметрыФормы);
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если ПараметрыПеретаскивания.Список = "Входящее" Тогда
		ЗначенияЗаполнения.Вставить("Основание", ПараметрыПеретаскивания.Значение);
		Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Строка") Тогда
			ИдентификаторСообщения = Новый ИдентификаторОбсужденияСистемыВзаимодействия(ПараметрыПеретаскивания.Значение);
			ЗначенияЗаполнения.Вставить("Основание", ПолучитьНавигационнуюСсылку(ИдентификаторСообщения));
			ЗначенияЗаполнения.Вставить("ОснованиеПредставление", ПараметрыПеретаскивания.Описание);
		КонецЕсли;	
	КонецЕсли;
	
	Если ПараметрыПеретаскивания.Список <> "Входящее" И НЕ Создание Тогда
		ПараметрыФормы.Вставить("Ключ", ПараметрыПеретаскивания.Значение);
	КонецЕсли;
	Если Список <> Неопределено Тогда
		ЗначенияЗаполнения.Вставить("ДатаНачала", ДатаНачалаСервер(Список));
	КонецЕсли;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", ЗначенияЗаполнения);
	
	Если Создание Тогда
		ИмяФормыЗадачи = "Документ.ЗадачаСотрудника.Форма.ФормаДокумента";
	Иначе
		ИмяФормыЗадачи = ИмяФормыЗадачиПоТипу(ПараметрыПеретаскивания.Значение, ПараметрыПеретаскивания.Список);
	КонецЕсли;
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	
	ОткрытьФорму(ИмяФормыЗадачи,ПараметрыФормы,ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ИзменитьДатуВОбъекте(ПараметрыИсточника, Список, СтрокаДаты)
	
	Начало = ДатаПоСтроке(СтрокаДаты);
	
	Если СтрокаДаты = "БезСрока" Тогда
		Конец = Начало;
	Иначе
		Конец = Начало + 1800;
	КонецЕсли;
	
	Если СтрокаДаты <> "БезСрока" И СтрокаДаты <> "Сегодня" 
		И ПараметрыИсточника.СписокДляОбновления <> "ЗадачиБезСрока" Тогда
		
		Если ЗначениеЗаполнено(ПараметрыИсточника.ЗаписьКалендаря) Тогда
			Источник = ПараметрыИсточника.ЗаписьКалендаря;
			ДатаНачала    = Источник.Начало;
			ДатаОкончания = Источник.Окончание;
		Иначе
			Источник = ПараметрыИсточника.Значение;
			ДатаНачала    = Источник.ДатаНачала;
			ДатаОкончания = Источник.ДатаОкончания;
		КонецЕсли;
		
		
		Если ЗначениеЗаполнено(ДатаОкончания) Тогда
			Продолжительность = ДатаОкончания - ДатаНачала;
		КонецЕсли;
		
		Начало = Дата(Год(Начало),Месяц(Начало),День(Начало),Час(ДатаНачала),Минута(ДатаНачала),Секунда(ДатаНачала));
		Если ЗначениеЗаполнено(ДатаОкончания) Тогда
			Конец = Начало + Продолжительность;
		КонецЕсли;
		
	КонецЕсли;
	
	ОбрабатываемыеЭлементы = Новый Массив;
	
	ОбрабатываемыйЭлемент = Новый Структура;
	ОбрабатываемыйЭлемент.Вставить("ЗаписьКалендаря",		ПараметрыИсточника.ЗаписьКалендаря);
	ОбрабатываемыйЭлемент.Вставить("Источник",				ПараметрыИсточника.Значение);
	ОбрабатываемыйЭлемент.Вставить("НомерСтрокиИсточника",	ПараметрыИсточника.НомерСтрокиИсточника);
	ОбрабатываемыйЭлемент.Вставить("Начало",				Начало);
	ОбрабатываемыйЭлемент.Вставить("Конец",					Конец);
	
	ОбрабатываемыеЭлементы.Добавить(ОбрабатываемыйЭлемент);	
	Справочники.ЗаписиКалендаряСотрудника.СохранитьИзмененияЗаписейКалендарей(ОбрабатываемыеЭлементы);
	
	Элементы[ПараметрыИсточника.СписокДляОбновления].Обновить();
	Элементы[Список].Обновить();
	
КонецПроцедуры

&НаСервере
Функция ДатаНачалаСервер(Список)
	
	СекундВДне = 3600*24;
	Сегодня = НачалоДня(ТекущаяДатаСеанса());
	Завтра = НачалоДня(ТекущаяДатаСеанса() + СекундВДне);
	НаНеделе = Завтра + СекундВДне;
	Позже = КонецНедели(Сегодня) + 1;
	
	Если Список = "ЗадачиНаСегодня" Тогда
		Возврат Сегодня;
	ИначеЕсли Список = "ЗадачиНаЗавтра" Тогда
		Возврат Завтра;
	ИначеЕсли Список = "ЗадачиБезСрока" Тогда
		Возврат Неопределено;
	ИначеЕсли Список = "ЗадачиНаНеделе" Тогда
		Возврат НаНеделе;
	ИначеЕсли Список = "ЗадачиПозже" Тогда
		Возврат Позже;
	КонецЕсли;
	
КонецФункции

&НаСервере
Процедура УдалитьСтрокуВходящегоИзРегистра(Строка,Ответственный)
	КонтактЦентр.УдалитьИзВходящего(Строка,Ответственный);
	Элементы.Входящее.Обновить();
	УправлениеФормой();
КонецПроцедуры

&НаСервере
Функция ИмяФормыЗадачиПоТипу(Задача, Список = Неопределено)
	
	Если Список = "Входящее" Тогда
		Возврат "Документ.ЗадачаСотрудника.Форма.ФормаДокумента";
	КонецЕсли;
	
	Если ТипЗнч(Задача) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
		Возврат "Документ.ЗадачаСотрудника.Форма.ФормаДокумента";
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.Событие") Тогда
		Возврат "Документ.Событие.ФормаОбъекта";
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаданиеНаРаботу") Тогда
		Возврат "Документ.ЗаданиеНаРаботу.Форма.ФормаДокумента";
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
		Возврат "Документ.ЗаказПокупателя.ФормаОбъекта";
	ИначеЕсли ТипЗнч(Задача) = Тип("ДокументСсылка.ЗаказНаПроизводство") Тогда
		Возврат "Документ.ЗаказНаПроизводство.ФормаОбъекта";
	КонецЕсли;

КонецФункции

&НаСервере
Процедура УстановитьСостояние(ПараметрыСписка)
	
	Если ПараметрыСписка.Состояние = "Завершено" Тогда
		СостояниеСобытия = Справочники.СостоянияСобытий.Завершено;
	Иначе
		СостояниеСобытия = Справочники.СостоянияСобытий.Отменено;
	КонецЕсли;
	
	Попытка
		ИсточникОбъект = ПараметрыСписка.Источник.ПолучитьОбъект();
		ИсточникОбъект.Заблокировать();
		ИсточникОбъект.Состояние = СостояниеСобытия;
		ИсточникОбъект.Записать();
		ИсточникОбъект.Разблокировать();
	Исключение
		ОбщегоНазначения.СообщитьПользователю(КраткоеПредставлениеОшибки(ИнформацияОбОшибке()), ИсточникОбъект);
		Возврат;
	КонецПопытки;
	Элементы[ПараметрыСписка.Список].Обновить();
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЗадачаПросрочена(Начало, Окончание)
	
	Если ЗначениеЗаполнено(Окончание) Тогда
		Если Окончание < ТекущаяДатаСеанса() Тогда
			Если Окончание <> НачалоДня(ТекущаяДатаСеанса()) Тогда
				Возврат 0;
			Иначе
				Возврат 1;
			КонецЕсли;
		Иначе
			Возврат 1;
		КонецЕсли;
	Иначе
		Если Начало < ТекущаяДатаСеанса() Тогда
			Если Начало <> НачалоДня(ТекущаяДатаСеанса()) Тогда
				Возврат 0;
			Иначе
				Возврат 1;
			КонецЕсли;
		Иначе
			Возврат 1;
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

&НаСервере
Процедура УстановитьОтборПоКалендарю()
	
	ВыбранныеКалендари = Новый Массив;
	Для Каждого Календарь Из ДоступныеКалендари Цикл
		Если НЕ Календарь.Выбран Тогда 
			Продолжить;
		КонецЕсли;
		ВыбранныеКалендари.Добавить(Календарь.Календарь);
	КонецЦикла;
	
	Для Каждого Список Из СпискиФормы() Цикл
		Список.Параметры.УстановитьЗначениеПараметра("ВыбранныеКалендари",ВыбранныеКалендари);
	КонецЦикла;
	
	Для Каждого Колонка Из КолонкиТекущейДоски Цикл
		Индекс = КолонкиТекущейДоски.Индекс(Колонка);
		ЭтотОбъект["СписокДел_"+Строка(Индекс)].Параметры.УстановитьЗначениеПараметра("Календарь",ТекущаяДоска);
	КонецЦикла;

КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиОтборов()
	
	РаботаСОтборами.СохранитьНастройкиОтборов(ЭтотОбъект,,,,,,,"ПраваяПанель");
	ХранилищеСистемныхНастроек.Сохранить("ВариантПредставления", "ВариантПредставления_КонтактЦентр",ВидыКонтактЦентра);
	ХранилищеСистемныхНастроек.Сохранить("ТекущаяДоска", "ТекущаяДоска_КонтактЦентр",ТекущаяДоска);
	СохранитьНастройки();
	
КонецПроцедуры

#Область Доски

&НаСервере
Процедура ОбновитьКолонкуЗаписиКалендаря(ПараметрыПеретаскивания, ИмяСписка)
	
	Попытка	
		Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			ЗаписьОбъект = ПараметрыПеретаскивания.Значение.ПолучитьОбъект();
		Иначе
			ЗаписьОбъект = ПараметрыПеретаскивания.ЗаписьКалендаря.ПолучитьОбъект();
		КонецЕсли;
		НачатьТранзакцию();
		ЗаписьОбъект.Заблокировать();
		ЗаписьОбъект.КолонкаКалендаря = ПараметрыПеретаскивания.Колонка;
		ЗаписьОбъект.Записать();
		ЗаписьОбъект.Разблокировать();
		
		Справочники.КолонкиКалендарейСотрудников.ПриИзмененииКолонкиЗаписи(ЗаписьОбъект.Ссылка, 
			ПараметрыПеретаскивания.Колонка);
		ЗафиксироватьТранзакцию();
		
		Элементы[ИмяСписка].Обновить();
		Элементы[ПараметрыПеретаскивания.СписокДляОбновления].Обновить();
		
		ТекущийЭлемент = Элементы[ИмяСписка];
		Элементы[ИмяСписка].ТекущаяСтрока = ПараметрыПеретаскивания.Значение.Значение;
	Исключение
			
	КонецПопытки
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДосок()
	
	Если ОбщегоНазначения.ЭтоМобильныйКлиент() Тогда
		Возврат;
	КонецЕсли;

	УдаляемыеЭлементы = Новый Массив;

	Для ИндексГруппы = 0 По Элементы.ЛичныеДоски_Список.ПодчиненныеЭлементы.Количество()-1 Цикл
		УдаляемыеЭлементы.Добавить(Элементы.ЛичныеДоски_Список.ПодчиненныеЭлементы[ИндексГруппы]);
	КонецЦикла;
	
	Для ИндексГруппы = 0 По Элементы.КомандныеДоски_Список.ПодчиненныеЭлементы.Количество()-1 Цикл
		УдаляемыеЭлементы.Добавить(Элементы.КомандныеДоски_Список.ПодчиненныеЭлементы[ИндексГруппы]);
	КонецЦикла;
	
	Для Каждого УдаляемыйЭлемент Из УдаляемыеЭлементы Цикл
		Элементы.Удалить(УдаляемыйЭлемент);
	КонецЦикла;
	
	ЛичныеКалендари = ДоступныеКалендари.НайтиСтроки(Новый Структура("Личный", Истина));
	ДобавитьЭлементыДосокКалендаря(ЛичныеКалендари, "ЛичнаяДоска_", Элементы.ЛичныеДоски_Список);
	
	КомандныеКалендари = ДоступныеКалендари.НайтиСтроки(Новый Структура("Личный", Ложь));
	ДобавитьЭлементыДосокКалендаря(КомандныеКалендари, "КоманднаяДоска_", Элементы.КомандныеДоски_Список);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДосокПослеВыбора();
	УстановитьОтборПоКалендарю();
	ОбновитьЭлементыДосок();
	ОбновитьЭлементыТекущейДоски();
	УправлениеФормой();
КонецПроцедуры

&НаСервере
Процедура ДобавитьЭлементыДосокКалендаря(Календари,ПрефиксКалендаря,ГруппаДобавления)
	
	ИндексТекущегоЭлемента = 0;
	ИндексСтроки = 0;
	ИндексКалендаря = 0;
	
	Для Каждого Календарь Из Календари Цикл
		
		ИндексКалендаря = ДоступныеКалендари.Индекс(Календарь);
		
		Если (Календарь.Недействителен И НЕ Элементы.ФормаПоказыватьНедействительные.Пометка
			И Календарь.Календарь <> ТекущаяДоска) ИЛИ Календарь.Наименование = "Календарь налогов" Тогда
			Продолжить;
		КонецЕсли;
		
		ОстатокОтДеления = ИндексТекущегоЭлемента % 4;
		Если ОстатокОтДеления = 0 Тогда
			ГруппаСтроки = Элементы.Добавить("Строка"+ПрефиксКалендаря+Строка(ИндексСтроки),Тип("ГруппаФормы"),ГруппаДобавления);
			ГруппаСтроки.Вид = Элементы.ГруппаСтрокаПример.Вид;
			ГруппаСтроки.Группировка = Элементы.ГруппаСтрокаПример.Группировка;
			ГруппаСтроки.ОтображатьЗаголовок = Элементы.ГруппаСтрокаПример.ОтображатьЗаголовок;
			ИндексСтроки = ИндексСтроки + 1;
		Иначе
			ГруппаСтроки = Элементы.Найти("Строка"+ПрефиксКалендаря+Строка(ИндексСтроки-1));
		КонецЕсли;

		ГруппаДоски = Элементы.Добавить("Группа"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ГруппаФормы"),ГруппаСтроки);
		ГруппаДоски.Вид = Элементы.ГруппаДоскаПример.Вид;
		ГруппаДоски.Группировка = Элементы.ГруппаДоскаПример.Группировка;
		Если Календарь.Календарь = ТекущаяДоска Тогда
			ГруппаДоски.ЦветФона = Новый Цвет(251,237,158);
		Иначе
			ГруппаДоски.ЦветФона = Элементы.ГруппаДоскаПример.ЦветФона;
		КонецЕсли;
		
		ГруппаДоски.ОтображатьЗаголовок = Элементы.ГруппаДоскаПример.ОтображатьЗаголовок;
		ГруппаДоски.Ширина = Элементы.ГруппаДоскаПример.Ширина;
				
		ГруппаКалендаря = Элементы.Добавить(ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ГруппаФормы"),ГруппаДоски);
		ГруппаКалендаря.Вид = Элементы.ДоскаПримерНаименование.Вид;
		ГруппаКалендаря.Группировка = Элементы.ДоскаПримерНаименование.Группировка;
		ГруппаКалендаря.ЦветФона = Элементы.ДоскаПримерНаименование.ЦветФона;
		ГруппаКалендаря.ОтображатьЗаголовок = Элементы.ДоскаПримерНаименование.ОтображатьЗаголовок;
		ГруппаКалендаря.Ширина = Элементы.ДоскаПримерНаименование.Ширина;
		
		ДекорацияКартинкаМеню = Элементы.Добавить("Картинка"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ДекорацияФормы"),ГруппаДоски);
		
		Если НЕ Календарь.Недействителен Тогда
			ДекорацияКартинкаМеню.Вид = ВидДекорацииФормы.Картинка;
			ДекорацияКартинкаМеню.Картинка = РаботаСЦветомКлиентСервер.КартинкаЦветаПоНомеруКартинки(Календарь.ВариантЦвета);
			ДекорацияКартинкаМеню.Гиперссылка = Истина;
			ДекорацияКартинкаМеню.УстановитьДействие("Нажатие", "Подключаемый_ЦветКалендарьНажатие");
		Иначе
			ДекорацияКартинкаМеню.Вид = ВидДекорацииФормы.Надпись;
			ДекорацияКартинкаМеню.Заголовок = "";
		КонецЕсли;
		
		ДекорацияКартинкаМеню.Ширина = Элементы.ДоскаПримерЦвет.Ширина;
		ДекорацияКартинкаМеню.Высота = Элементы.ДоскаПримерЦвет.Высота;
		ДекорацияКартинкаМеню.ГоризонтальноеПоложениеВГруппе = Элементы.ДоскаПримерЦвет.ГоризонтальноеПоложениеВГруппе;
		ДекорацияКартинкаМеню.ВертикальноеПоложениеВГруппе = Элементы.ДоскаПримерЦвет.ВертикальноеПоложениеВГруппе;
		
		ДекорацияНаименование = Элементы.Добавить("ДекорацияЗаголовок"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ДекорацияФормы"),ГруппаКалендаря);
		ДекорацияНаименование.Вид=ВидДекорацииФормы.Картинка;
		ДекорацияНаименование.АвтоМаксимальнаяШирина = Элементы.ДоскаПримерНазвание.АвтоМаксимальнаяШирина;
		ДекорацияНаименование.МаксимальнаяШирина = Элементы.ДоскаПримерНазвание.МаксимальнаяШирина;
		ДекорацияНаименование.Ширина = Элементы.ДоскаПримерНазвание.Ширина;
		ДекорацияНаименование.Высота = Элементы.ДоскаПримерНазвание.Высота;
		ДекорацияНаименование.РастягиватьПоГоризонтали = Элементы.ДоскаПримерНазвание.РастягиватьПоГоризонтали;
		ДекорацияНаименование.Заголовок = Календарь.Наименование;
		ДекорацияНаименование.ТекстНевыбраннойКартинки = Календарь.Наименование;
		ДекорацияНаименование.Гиперссылка = Элементы.ДоскаПримерНазвание.Гиперссылка;
		Если Календарь.Недействителен Тогда
			ДекорацияНаименование.ЦветТекста  = ЦветаСтиля.ЦветРамки;
		Иначе
			ДекорацияНаименование.ЦветТекста  = Элементы.ДоскаПримерНазвание.ЦветТекста;
		КонецЕсли;
		ДекорацияНаименование.УстановитьДействие("Нажатие", "Подключаемый_ЗаголовокДоскиНажатие");
		
		ИндексТекущегоЭлемента = ИндексТекущегоЭлемента + 1;
		
	КонецЦикла;
			
	ДобавитьЭлементСозданияДоски(ИндексТекущегоЭлемента,ИндексКалендаря, ПрефиксКалендаря, ИндексСтроки, ГруппаДобавления);
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьЭлементСозданияДоски(ИндексТекущегоЭлемента,ИндексКалендаря, ПрефиксКалендаря, 
	ИндексСтроки, ГруппаДобавления)
	
	ОстатокОтДеления = ИндексТекущегоЭлемента % 4;
	Если ОстатокОтДеления = 0 Тогда
		ГруппаСтроки = Элементы.Добавить("Строка"+ПрефиксКалендаря+Строка(ИндексСтроки),Тип("ГруппаФормы"),ГруппаДобавления);
		ГруппаСтроки.Вид = Элементы.ГруппаСтрокаПример.Вид;
		ГруппаСтроки.Группировка = Элементы.ГруппаСтрокаПример.Группировка;
		ГруппаСтроки.ОтображатьЗаголовок = Элементы.ГруппаСтрокаПример.ОтображатьЗаголовок;
		ИндексСтроки = ИндексСтроки + 1;
	Иначе
		ГруппаСтроки = Элементы.Найти("Строка"+ПрефиксКалендаря+Строка(ИндексСтроки-1));
	КонецЕсли;
	
	ИндексКалендаря = ИндексКалендаря + 1;
	
	ГруппаДоски = Элементы.Добавить("Группа"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ГруппаФормы"),ГруппаСтроки);
	ГруппаДоски.Вид = Элементы.ГруппаДоскаПример.Вид;
	ГруппаДоски.Группировка = Элементы.ГруппаДоскаПример.Группировка;
	ГруппаДоски.ЦветФона = Элементы.ГруппаДоскаПример.ЦветФона;
	
	ГруппаДоски.ОтображатьЗаголовок = Элементы.ГруппаДоскаПример.ОтображатьЗаголовок;
	ГруппаДоски.Ширина = Элементы.ГруппаДоскаПример.Ширина;
	
	ГруппаКалендаря = Элементы.Добавить(ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ГруппаФормы"),ГруппаДоски);
	ГруппаКалендаря.Вид = Элементы.ДоскаПримерНаименование.Вид;
	ГруппаКалендаря.Группировка = Элементы.ДоскаПримерНаименование.Группировка;
	ГруппаКалендаря.ЦветФона = Элементы.ДоскаПримерНаименование.ЦветФона;
	ГруппаКалендаря.ОтображатьЗаголовок = Элементы.ДоскаПримерНаименование.ОтображатьЗаголовок;
	ГруппаКалендаря.Ширина = Элементы.ДоскаПримерНаименование.Ширина;
	
	ДекорацияКартинкаМеню = Элементы.Добавить("Картинка"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ДекорацияФормы"),ГруппаДоски);
	ДекорацияКартинкаМеню.Вид = ВидДекорацииФормы.Картинка;
	ДекорацияКартинкаМеню.Ширина = Элементы.ДоскаПримерЦвет.Ширина;
	ДекорацияКартинкаМеню.Высота = Элементы.ДоскаПримерЦвет.Высота;
	ДекорацияКартинкаМеню.ГоризонтальноеПоложениеВГруппе = Элементы.ДоскаПримерЦвет.ГоризонтальноеПоложениеВГруппе;
	ДекорацияКартинкаМеню.ВертикальноеПоложениеВГруппе = Элементы.ДоскаПримерЦвет.ВертикальноеПоложениеВГруппе;
	ДекорацияКартинкаМеню.Гиперссылка = Элементы.ДоскаПримерЦвет.Гиперссылка;
	
	ДекорацияНаименование = Элементы.Добавить("ДекорацияЗаголовок"+ПрефиксКалендаря+Строка(ИндексКалендаря),Тип("ДекорацияФормы"),ГруппаКалендаря);
	ДекорацияНаименование.Вид=ВидДекорацииФормы.Картинка;
	ДекорацияНаименование.АвтоМаксимальнаяШирина = Элементы.ДоскаПримерНазвание.АвтоМаксимальнаяШирина;
	ДекорацияНаименование.МаксимальнаяШирина = Элементы.ДоскаПримерНазвание.МаксимальнаяШирина;
	ДекорацияНаименование.Картинка = БиблиотекаКартинок.ПлюсТорговыеПредложения;
	ДекорацияНаименование.Ширина = Элементы.ДоскаПримерНазвание.Ширина;
	ДекорацияНаименование.Высота = Элементы.ДоскаПримерНазвание.Высота;
	ДекорацияНаименование.РастягиватьПоГоризонтали = Элементы.ДоскаПримерНазвание.РастягиватьПоГоризонтали;
	ДекорацияНаименование.Заголовок = НСтр("ru = 'Создание доски'");
	ДекорацияНаименование.Гиперссылка = Элементы.ДоскаПримерНазвание.Гиперссылка;
	ДекорацияНаименование.УстановитьДействие("Нажатие", "Подключаемый_СозданиеДоскиНажатие");
	
КонецПроцедуры

&НаКлиенте
Функция ИндексЭлемента(ИмяЭлемента)
	
	Возврат Число(Прав(ИмяЭлемента, СтрДлина(ИмяЭлемента) - СтрНайти(ИмяЭлемента, "_")));
	
КонецФункции

&НаСервере
Процедура ОбновитьЭлементыТекущейДоски()
	
	Если ОбщегоНазначения.ЭтоМобильныйКлиент() Тогда
		Возврат;
	КонецЕсли;

	УдалитьПрограммноСозданныеЭлементы();
	
	КолонкиКалендаряСотрудника = Справочники.КолонкиКалендарейСотрудников.КолонкиКалендаряВладельца(ТекущаяДоска);	
	
	Если КолонкиКалендаряСотрудника.Количество() = 0 Тогда
		Справочники.КолонкиКалендарейСотрудников.ПроверитьСоздатьПервуюКолонкуКалендаря(ТекущаяДоска);
		КолонкиКалендаряСотрудника = Справочники.КолонкиКалендарейСотрудников.КолонкиКалендаряВладельца(ТекущаяДоска);
	КонецЕсли;

	РазрешенныеИсточники = ОбщегоНазначения.ВыгрузитьКолонку(РазрешенныеИсточники(Истина),"Источник");

	Для Каждого ДанныеКолонкиДоски Из КолонкиКалендаряСотрудника Цикл
		
		ИндексКолонки = КолонкиКалендаряСотрудника.Индекс(ДанныеКолонкиДоски);
		ДобавитьЗаголовокКолонки(ДанныеКолонкиДоски, ИндексКолонки);
		Если ИндексКолонки = 0 ИЛИ ТекущаяДоска.Недействителен Тогда
			ЦветФона = Новый Цвет(245, 245, 245);
		Иначе
			ЦветФона = Новый Цвет(233, 242, 204);
		КонецЕсли;
		ГруппаСписка = Элементы.Добавить("ГруппаСписка_"+Строка(ИндексКолонки),Тип("ГруппаФормы"),Элементы.ДоскаСписки);
		ГруппаСписка.Вид = Элементы.ДоскаСписки.Вид;
		ГруппаСписка.Группировка = Элементы.ДоскаСписки.Группировка;
		ГруппаСписка.ЦветФона = ЦветФона;
		
		ГруппаСписка.ОтображатьЗаголовок = Элементы.ДоскаСписки.ОтображатьЗаголовок;
		
		ИмяСписка = "СписокДел_"+Строка(ИндексКолонки);
		
		ТипыРеквизита = Новый Массив;
		ТипыРеквизита.Добавить(Тип("ДинамическийСписок"));
		ОписаниеТиповДляРеквизита = Новый ОписаниеТипов(ТипыРеквизита); 
		ДинамическийСписок = Новый РеквизитФормы(ИмяСписка, ОписаниеТиповДляРеквизита,,"",ЛОЖЬ);
		ДобавляемыеРеквизиты = Новый Массив;
		ДобавляемыеРеквизиты.Добавить(ДинамическийСписок);
		ИзменитьРеквизиты(ДобавляемыеРеквизиты);
		
		РеквизитДинамическийСписок = ЭтаФорма["СписокДел_"+Строка(ИндексКолонки)];
		
		ТаблицаФормы = Элементы.Добавить("СписокДел_"+Строка(ИндексКолонки),Тип("ТаблицаФормы"),ГруппаСписка);
		ТаблицаФормы.ПутьКДанным = ИмяСписка;
		ТаблицаФормы.ПоложениеЗаголовка = Элементы.ЗадачиНаСегодня.ПоложениеЗаголовка;
		ТаблицаФормы.ПоложениеКоманднойПанели = Элементы.ЗадачиНаСегодня.ПоложениеКоманднойПанели;
		ТаблицаФормы.РежимВыделения = Элементы.ЗадачиНаСегодня.РежимВыделения;
		ТаблицаФормы.РежимВыделенияСтроки = Элементы.ЗадачиНаСегодня.РежимВыделенияСтроки;
		ТаблицаФормы.Шапка = Элементы.ЗадачиНаСегодня.Шапка;
		ТаблицаФормы.КартинкаСтрок = Элементы.ЗадачиНаСегодня.КартинкаСтрок;
		ТаблицаФормы.ГоризонтальныеЛинии = Элементы.ЗадачиНаСегодня.ГоризонтальныеЛинии;		
		ТаблицаФормы.Ширина = Элементы.ЗадачиНаСегодня.Ширина;
		ТаблицаФормы.РастягиватьПоГоризонтали = Элементы.ЗадачиНаСегодня.РастягиватьПоГоризонтали;
		ТаблицаФормы.ЦветФона = Новый Цвет(255,255,255);
		ТаблицаФормы.РазрешитьНачалоПеретаскивания = Истина;
		ТаблицаФормы.РазрешитьПеретаскивание = Истина;
		
		Если ИндексКолонки = 0 Тогда
			ТаблицаФормы.ЦветРамки = Новый Цвет(245, 245, 245);
		Иначе
			ТаблицаФормы.ЦветРамки = Элементы.ЗадачиНаСегодня.ЦветРамки;
		КонецЕсли;
		
		СтруктураСвойствДинамическогоСписка = ОбщегоНазначения.СтруктураСвойствДинамическогоСписка();
		СтруктураСвойствДинамическогоСписка.ТекстЗапроса =  КонтактЦентр.ТекстЗапросаДелКолонкиКалендаря();
		СтруктураСвойствДинамическогоСписка.ДинамическоеСчитываниеДанных = Истина;
		ОбщегоНазначения.УстановитьСвойстваДинамическогоСписка(ТаблицаФормы,СтруктураСвойствДинамическогоСписка);
		
		РеквизитДинамическийСписок.Параметры.УстановитьЗначениеПараметра("КолонкаКалендаря",ДанныеКолонкиДоски.Ссылка);
		РеквизитДинамическийСписок.Параметры.УстановитьЗначениеПараметра("Календарь",ТекущаяДоска);
		РеквизитДинамическийСписок.Параметры.УстановитьЗначениеПараметра("РазрешенныеИсточники",РазрешенныеИсточники);
		
		УстановитьОбязательностьИспользованияПолей(РеквизитДинамическийСписок);
		
		РеквизитДинамическийСписок.ВидКлюча = ВидКлючаДинамическогоСписка.Авто;
		ПоляКлючаМассив = Новый Массив;
		ПоляКлючаМассив.Добавить("Ссылка");
		ПоляКлючаМассив.Добавить("ЗаписьКалендаря");
		ПоляКлюча = Новый ФиксированныйМассив(ПоляКлючаМассив);	
		РеквизитДинамическийСписок.ПоляКлюча = ПоляКлюча;

		РеквизитДинамическийСписок.Порядок.Элементы.Очистить();
		НовыйПорядок = РеквизитДинамическийСписок.Порядок.Элементы.Добавить(Тип("ЭлементПорядкаКомпоновкиДанных"));
		НовыйПорядок.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Авто;
		НовыйПорядок.ТипУпорядочивания = НаправлениеСортировкиКомпоновкиДанных.Возр;
		НовыйПорядок.Поле = Новый ПолеКомпоновкиДанных("Начало");
		НовыйПорядок.Использование = Истина;
		
		ДобавитьКомандыКонтекстногоМеню(ИндексКолонки, ТаблицаФормы);
		
		ТаблицаФормы.ПутьКДаннымКартинкиСтроки = ИмяСписка+".Картинка";
		ТаблицаФормы.УстановитьДействие("ПриАктивизацииЯчейки", "Подключаемый_ПриАктивизацииЯчейкиСписка");
		ТаблицаФормы.УстановитьДействие("Выбор", "Подключаемый_Выбор");
		ТаблицаФормы.УстановитьДействие("ПриПолученииДанныхНаСервере", "Подключаемый_ПриПолученииДанныхНаСервере");
		ТаблицаФормы.УстановитьДействие("НачалоПеретаскивания", "Подключаемый_НачалоПеретаскивания");
		ТаблицаФормы.УстановитьДействие("ПроверкаПеретаскивания", "Подключаемый_ПроверкаПеретаскивания");
		ТаблицаФормы.УстановитьДействие("Перетаскивание", "Подключаемый_Перетаскивание");
		
		ДобавитьПоляКолонкиДоски(ТаблицаФормы, ИмяСписка, ГруппаСписка.ЦветФона);
		УстановитьУсловноеОформлениеСписка(ИмяСписка);
		
	КонецЦикла;
	
	КолонкиТекущейДоски.Очистить();
	Для Каждого КолонкаКалендаря Из КолонкиКалендаряСотрудника Цикл
		НоваяСтрока = КолонкиТекущейДоски.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, КолонкаКалендаря);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УдалитьПрограммноСозданныеЭлементы()
	
	УдаляемыеЭлементы = Новый Массив;
	УдаляемыеРеквизиты = Новый Массив;
	УдаляемыеКоманды = Новый Массив;
	
	Для ИндексГруппы = 0 По Элементы.ДоскаЗаголовки.ПодчиненныеЭлементы.Количество()-1 Цикл
		Если Элементы.ДоскаЗаголовки.ПодчиненныеЭлементы[ИндексГруппы].Имя = "ДобавитьКолонкуКалендаря"
			ИЛИ Элементы.ДоскаЗаголовки.ПодчиненныеЭлементы[ИндексГруппы].Имя = "ДекорацияОтступ" Тогда
			Продолжить;
		КонецЕсли;
		УдаляемыеЭлементы.Добавить(Элементы.ДоскаЗаголовки.ПодчиненныеЭлементы[ИндексГруппы]);
		УдаляемыеКоманды.Добавить(Команды.Найти("КомандаСоздатьДело_"+ИндексГруппы));
		УдаляемыеКоманды.Добавить(Команды.Найти("КонтекстноеМенюИзменитьДелоСписка_"+ИндексГруппы));
	КонецЦикла;
	
	Для ИндексГруппы = 0 По Элементы.ДоскаСписки.ПодчиненныеЭлементы.Количество()-1 Цикл
		УдаляемыеЭлементы.Добавить(Элементы.ДоскаСписки.ПодчиненныеЭлементы[ИндексГруппы]);
		УдаляемыеРеквизиты.Добавить("СписокДел_"+Строка(ИндексГруппы));
	КонецЦикла;
	
	Для Каждого УдаляемыйЭлемент Из УдаляемыеЭлементы Цикл
		Элементы.Удалить(УдаляемыйЭлемент);
	КонецЦикла;
	
	Для Каждого УдаляемаяКоманда Из УдаляемыеКоманды Цикл
		Команды.Удалить(УдаляемаяКоманда);
	КонецЦикла;
	
	ИзменитьРеквизиты(,УдаляемыеРеквизиты);
КонецПроцедуры

&НаСервере
Процедура ДобавитьКомандыКонтекстногоМеню(ИндексКолонки, ТаблицаФормы)
	
	ГруппаКнопок = Элементы.Добавить("ГруппаКомандСписка_"+Строка(ИндексКолонки),Тип("ГруппаФормы"),ТаблицаФормы.КонтекстноеМеню);
	ГруппаКнопок.Вид = ВидГруппыФормы.ГруппаКнопок;
		
	КнопкаИзменить = Элементы.Добавить("КнопкаИзменитьДелоСписка_" + Строка(ИндексКолонки), Тип("КнопкаФормы"),ГруппаКнопок);
	КомандаИзменить = ЭтаФорма.Команды.Добавить("КонтекстноеМенюИзменитьДелоСписка_" + Строка(ИндексКолонки));
	КомандаИзменить.Действие = "Подключаемый_КолонкаКонтекстноеМенюИзменить";
	КомандаИзменить.Подсказка = НСтр("ru = 'Изменить'");
	КомандаИзменить.Заголовок = НСтр("ru = 'Изменить'");
	
	КнопкаИзменить.ИмяКоманды = КомандаИзменить.Имя;
	КнопкаИзменить.Картинка = БиблиотекаКартинок.Изменить;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОбязательностьИспользованияПолей(РеквизитДинамическийСписок)
	
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Ссылка", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Теги", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Состояние", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Содержание", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Ответственный", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Основание", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Начало", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Окончание", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Наименование", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Картинка", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("Календарь", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("ДатаОбъединенная", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("КартинкаКалендаря", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("ЗадачаПросрочена", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("ДатаСоздания", Истина);
	РеквизитДинамическийСписок.УстановитьОбязательноеИспользование("ЗаписьКалендаря", Истина);
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьЗаголовокКолонки(Колонка, ИндексКолонки)
	
	ГруппаЗаголовка = Элементы.Добавить("ГруппаЗаголовокЗадачиДоски_"+Строка(ИндексКолонки),Тип("ГруппаФормы"),Элементы.ДоскаЗаголовки);
	ГруппаЗаголовка.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	ГруппаЗаголовка.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
	ГруппаЗаголовка.ОтображатьЗаголовок = Ложь;
	ГруппаЗаголовка.Объединенная = Истина;
	
	ДекорацияНаименование = Элементы.Добавить("ДекорацияЗаголовокЗадачи_"+ИндексКолонки,Тип("ДекорацияФормы"), ГруппаЗаголовка);
	ДекорацияНаименование.Вид = ВидДекорацииФормы.Надпись;
	ДекорацияНаименование.Заголовок = Колонка.Наименование;
	ДекорацияНаименование.Шрифт = ШрифтыСтиля.ТекущиеДелаЗаголовокРазделаШрифт;
	ДекорацияНаименование.Высота = 1;
	ДекорацияНаименование = Элементы.Добавить("ДекорацияОтступЗадачи_"+ИндексКолонки,Тип("ДекорацияФормы"), ГруппаЗаголовка);
	ДекорацияНаименование.Вид = ВидДекорацииФормы.Надпись;
	ДекорацияНаименование.Заголовок = "";
	ДекорацияНаименование.РастягиватьПоГоризонтали = Ложь;
	ДекорацияНаименование.АвтоМаксимальнаяШирина = Ложь;
	ДлинаОтступа = 22 - СтрДлина(Колонка.Наименование) - 2;
	Если ДлинаОтступа< 0 Тогда
		ДекорацияНаименование.Ширина = 0;
		ДекорацияНаименование.АвтоМаксимальнаяШирина = 0;
	Иначе
		ДекорацияНаименование.Ширина = ДлинаОтступа;
		ДекорацияНаименование.АвтоМаксимальнаяШирина = ДлинаОтступа;
	КонецЕсли;
	
	КнопкаСоздатьДело = Элементы.Добавить("КнопкаСоздатьДело_" + ИндексКолонки, Тип("КнопкаФормы"),ГруппаЗаголовка);
	КомандаСоздатьДело = ЭтаФорма.Команды.Добавить("КомандаСоздатьДело_" + ИндексКолонки);
	КомандаСоздатьДело.Действие = "Подключаемый_СоздатьДелоВКолонке";
	КомандаСоздатьДело.Подсказка = НСтр("ru = 'Создать'");
	
	КнопкаСоздатьДело.ИмяКоманды = КомандаСоздатьДело.Имя;
	КнопкаСоздатьДело.Ширина = 3;
	КнопкаСоздатьДело.Высота = 1;
	КнопкаСоздатьДело.Картинка = БиблиотекаКартинок.СоздатьЭлементСписка;
	КнопкаСоздатьДело.Отображение = ОтображениеКнопки.Картинка;
	КнопкаСоздатьДело.ОтображениеФигуры = ОтображениеФигурыКнопки.Нет;
	
	Элементы.Переместить(Элементы.ДобавитьКолонкуКалендаря, Элементы.ДоскаЗаголовки);
	Элементы.Переместить(Элементы.ДекорацияОтступ, Элементы.ДоскаЗаголовки);
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьПоляКолонкиДоски(ТаблицаФормы, ИмяСписка, ЦветОтступа)
	
	ГруппаКарточка = Элементы.Добавить(ИмяСписка + "Карточка", Тип("ГруппаФормы"), ТаблицаФормы);
	ГруппаКарточка.Вид = Элементы.ЗадачиНаСегодняГруппаКарточка.Вид;
	ГруппаКарточка.Группировка = Элементы.ЗадачиНаСегодняГруппаКарточка.Группировка;
	
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "Наименование", Тип("ПолеФормы"), ГруппаКарточка);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Наименование'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Наименование";
	НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняДатаОбъединенная.Ширина;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);

	ГруппаДата = Элементы.Добавить(ИмяСписка + "ГруппаДата", Тип("ГруппаФормы"), ГруппаКарточка);
	ГруппаДата.Вид = Элементы.ЗадачиНаСегодняГруппаДата.Вид;
	ГруппаДата.Группировка = Элементы.ЗадачиНаСегодняГруппаДата.Группировка;
	
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "ДатаОбъединенная", Тип("ПолеФормы"), ГруппаДата);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Дата'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".ДатаОбъединенная";
	НоваяКолонкаТаблицы.Ширина = 4;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);
		
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "Основание", Тип("ПолеФормы"), ГруппаКарточка);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Основание'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Основание";
	НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняОснование.Ширина;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);
	
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "Содержание", Тип("ПолеФормы"), ГруппаКарточка);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Содержание'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Содержание";
	НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняОснование.Ширина;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);
	
	ГруппаСостояние = Элементы.Добавить(ИмяСписка + "ГруппаСостояние", Тип("ГруппаФормы"), ГруппаКарточка);
	ГруппаСостояние.Вид = Элементы.ЗадачиНаСегодняГруппаДата.Вид;
	ГруппаСостояние.Группировка = Элементы.ЗадачиНаСегодняГруппаДата.Группировка;
	
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "Состояние", Тип("ПолеФормы"), ГруппаСостояние);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Состояние'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".СостояниеИсточника";
	НоваяКолонкаТаблицы.Ширина = 6;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);

	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "ОтступОтветственный", Тип("ПолеФормы"), ГруппаСостояние);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'ОтступОтветственный'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Отступ";
	НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняОтступОтветственный.Ширина;
	НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);
	
	СтрокаКалендаря = ДоступныеКалендари.НайтиСтроки(Новый Структура("Календарь",ТекущаяДоска));
	
	Если СтрокаКалендаря.Количество() <> 0 И НЕ СтрокаКалендаря[0].Личный Тогда
		ГруппаДата = Элементы.Добавить(ИмяСписка + "ГруппаОтветственный", Тип("ГруппаФормы"), ГруппаКарточка);
		ГруппаДата.Вид = Элементы.ЗадачиНаСегодняГруппаОтветственный.Вид;
		ГруппаДата.Группировка = Элементы.ЗадачиНаСегодняГруппаОтветственный.Группировка;
		
		НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "Ответственный", Тип("ПолеФормы"), ГруппаДата);
		НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'Ответственный'");
		НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Ответственный";
		НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняОтветственный.Ширина;
		НоваяКолонкаТаблицы.ЦветФона = Новый Цвет(255,255,255);
		
	КонецЕсли;
	
	НоваяКолонкаТаблицы = Элементы.Добавить(ИмяСписка + "ОтступКарточки", Тип("ПолеФормы"), ГруппаКарточка);
	НоваяКолонкаТаблицы.Заголовок = НСтр("ru = 'ОтступКарточки'");
	НоваяКолонкаТаблицы.ПутьКДанным = ИмяСписка + ".Отступ";
	НоваяКолонкаТаблицы.Ширина = Элементы.ЗадачиНаСегодняОтступКарточки.Ширина;
	НоваяКолонкаТаблицы.Шрифт =  Элементы.ЗадачиНаСегодняОтступКарточки.Шрифт;
	НоваяКолонкаТаблицы.ЦветФона = ЦветОтступа;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеСписка(ИмяСписка)
	
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".Содержание", "", ВидСравненияКомпоновкиДанных.НеЗаполнено);
	РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы[ИмяСписка+"Содержание"].Имя);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Видимость", Ложь);
	
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".Основание", "", ВидСравненияКомпоновкиДанных.НеЗаполнено);
	РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы[ИмяСписка+"Основание"].Имя);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Видимость", Ложь);
	
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".ЗадачаПросрочена", 0, ВидСравненияКомпоновкиДанных.Равно);
	РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы[ИмяСписка+"ДатаОбъединенная"].Имя);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", Новый Цвет(174, 50, 38));
		
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".ЗадачаПросрочена", 0, ВидСравненияКомпоновкиДанных.Равно);
	РаботаСФормой.ДобавитьОформляемоеПоле(НовоеУсловноеОформление, Элементы[ИмяСписка+"ДатаОбъединенная"].Имя);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "Шрифт", ШрифтыСтиля.ШрифтПравойПанелиОтборов);
	
	МассивОформляемыхПолей = Новый Массив;
	МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"ДатаОбъединенная"].Имя);
	МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"Наименование"].Имя);
	МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"Состояние"].Имя);
	МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"Содержание"].Имя);
	МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"Основание"].Имя);
	
	Если Элементы.Найти(ИмяСписка+"Ответственный") <> Неопределено Тогда
		МассивОформляемыхПолей.Добавить(Элементы[ИмяСписка+"Ответственный"].Имя);
	КонецЕсли;
	
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".Состояние", "Выполнена", ВидСравненияКомпоновкиДанных.Содержит);	
	РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, МассивОформляемыхПолей);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветРамки);
	
	НовоеУсловноеОформление = УсловноеОформление.Элементы.Добавить();
	РаботаСФормой.ДобавитьЭлементОтбораКомпоновкиДанных(НовоеУсловноеОформление.Отбор, ИмяСписка+".Состояние", Истина, ВидСравненияКомпоновкиДанных.Равно);
	РаботаСФормой.ДобавитьОформляемыеПоля(НовоеУсловноеОформление, МассивОформляемыхПолей);
	РаботаСФормой.ДобавитьЭлементУсловногоОформления(НовоеУсловноеОформление, "ЦветТекста", ЦветаСтиля.ЦветРамки);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ЗаголовокДоскиНажатие(Элемент)
	
	ИндексДоски = ИндексЭлемента(Элемент.Имя);
	ТекущаяДоска = ДоступныеКалендари.Получить(ИндексДоски).Календарь;
	 
	ВидыКонтактЦентра = 4;
	ОбновитьЭлементыДосокПослеВыбора();
	УправлениеФормой();
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПриАктивизацииЯчейкиСписка(Элемент)
	
	Элемент.ВыделенныеСтроки.Очистить();
	Индекс = ИндексЭлемента(Элемент.Имя);
	
	Для Каждого ЭлементКонтекстногоМеню Из Элемент.КонтекстноеМеню.ПодчиненныеЭлементы Цикл
		Если ЭлементКонтекстногоМеню.Имя = "ГруппаКомандСписка_" + Строка(Индекс) Тогда
			Продолжить;
		КонецЕсли;
		ЭлементКонтекстногоМеню.Видимость = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_Выбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ПараметрыФормы = Новый Структура();
	ПараметрыФормы.Вставить("СозданиеЗадачиКонтактЦентр", Истина);
	ПараметрыФормы.Вставить("Ключ", ВыбраннаяСтрока.Ссылка);
	ПараметрыФормы.Вставить("РежимВыбора",Истина);
	ОткрытьФорму(ИмяФормыЗадачиПоТипу(ВыбраннаяСтрока.Ссылка),ПараметрыФормы,ЭтотОбъект);
КонецПроцедуры

&НаСервереБезКонтекста
Процедура Подключаемый_ПриПолученииДанныхНаСервере(ИмяЭлемента, Настройки, Строки)
	
	УстановитьПривилегированныйРежим(Истина);
	Для Каждого КлючИЗначение Из Строки Цикл
		КлючИЗначение.Значение.Данные.Картинка = КартинкаПоТипуЗадачи(КлючИЗначение.Значение.Данные.Ссылка);
		КлючИЗначение.Значение.Данные.ДатаОбъединенная = СтрокаДаты(КлючИЗначение.Значение.Данные.Начало, КлючИЗначение.Значение.Данные.Окончание, "ВРаботе");
		КлючИЗначение.Значение.Данные.ЗадачаПросрочена = ЗадачаПросрочена(КлючИЗначение.Значение.Данные.Начало, КлючИЗначение.Значение.Данные.Окончание);
		Если ТипЗнч(КлючИЗначение.Значение.Данные.Ссылка) = Тип("ДокументСсылка.ЗадачаСотрудника") Тогда
			КлючИЗначение.Значение.Данные.Содержание = СтрокаТегов(КлючИЗначение.Значение.Данные.Ссылка.Теги);
		КонецЕсли;
	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_СоздатьДелоВКолонке(Команда)
	
	ИндексЭлемента = ИндексЭлемента(Команда.Имя);
	СтрокаДаты = "Сегодня";
	ДатаНачала = ДатаПоСтроке(СтрокаДаты);
	
	ЗначенияЗаполнения = Новый Структура;
	Если Истина Тогда
		ЗначенияЗаполнения.Вставить("Начало", ДатаНачала);
		ЗначенияЗаполнения.Вставить("Окончание", ДатаНачала + 1800);
	КонецЕсли;
	ЗначенияЗаполнения.Вставить("Календарь", ТекущаяДоска);
	ЗначенияЗаполнения.Вставить("КолонкаКалендаря", КолонкиТекущейДоски[ИндексЭлемента].Ссылка);
	
	СоздатьДело(ЗначенияЗаполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_НачалоПеретаскивания(Элемент, ПараметрыПеретаскивания, Выполнение)
	
	Индекс = ИндексЭлемента(Элемент.Имя);
	КолонкаКалендаря = КолонкиТекущейДоски[Индекс].Ссылка;
	
	Если НЕ ЗначениеЗаполнено(Элемент.ТекущаяСтрока) 
		ИЛИ ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	СтруктураПеретаскивания = Новый Структура;
	СтруктураПеретаскивания.Вставить("Значение", ПараметрыПеретаскивания.Значение.Ссылка);
	СтруктураПеретаскивания.Вставить("ЗаписьКалендаря", ПараметрыПеретаскивания.Значение.ЗаписьКалендаря);
	СтруктураПеретаскивания.Вставить("СписокДляОбновления", Элемент.Имя);
	ПараметрыПеретаскивания.Значение = СтруктураПеретаскивания;
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_Перетаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	
	СтандартнаяОбработка = Ложь;
	Индекс = ИндексЭлемента(Элемент.Имя);
	КолонкаКалендаря = КолонкиТекущейДоски[Индекс].Ссылка;
	
	Если ПараметрыПеретаскивания.Значение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПараметрыПеретаскивания.Значение.Вставить("Колонка",КолонкаКалендаря);
	ОбновитьКолонкуЗаписиКалендаря(ПараметрыПеретаскивания.Значение, Элемент.Имя);
	
	Для Каждого СписокКолонки Из КолонкиТекущейДоски Цикл
		Индекс = КолонкиТекущейДоски.Индекс(СписокКолонки);
		Элементы["СписокДел_"+Индекс].ВыделенныеСтроки.Очистить();
	КонецЦикла;

	ТекущийЭлемент = Элемент;
	Элемент.ТекущаяСтрока = Новый КлючСтрокиДинамическогоСписка("ЗаписьКалендаря, Ссылка",
		ПараметрыПеретаскивания.Значение.ЗаписьКалендаря,
		ПараметрыПеретаскивания.Значение.Значение);
		
	ПоказатьОповещениеПользователя(НСтр("ru='Изменение:'"),
				ПолучитьНавигационнуюСсылку(ПараметрыПеретаскивания.Значение.Значение),
				СтрШаблон(НСтр("ru='%1'"),ПараметрыПеретаскивания.Значение.Значение),
				БиблиотекаКартинок.Информация32);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_СозданиеДоскиНажатие(Элемент)
	ПараметрыКалендаря = Новый Структура;
	ПараметрыКалендаря.Вставить("РежимВыбора", Истина);
	ОткрытьФорму("Справочник.КалендариСотрудников.Форма.ФормаЭлемента",ПараметрыКалендаря,ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КолонкаКонтекстноеМенюИзменить(Команда)
	
	ИндексЭлемента = ИндексЭлемента(Команда.Имя);
	СписокДел = Элементы["СписокДел_"+Строка(ИндексЭлемента)];
	Если НЕ ЗначениеЗаполнено(СписокДел.ТекущаяСтрока) Тогда
		Возврат;
	КонецЕсли;
	ПараметрыЗадачи = Новый Структура;
	ПараметрыЗадачи.Вставить("Значение",СписокДел.ТекущаяСтрока.Ссылка);
	ПараметрыЗадачи.Вставить("Список","СписокДел_"+Строка(ИндексЭлемента));
	ОткрытьФормуЗадачи(ПараметрыЗадачи);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказыватьНедействительные(Команда)
	Элементы.ФормаПоказыватьНедействительные.Пометка = Не Элементы.ФормаПоказыватьНедействительные.Пометка;
	ОбновитьЭлементыДосок();	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
