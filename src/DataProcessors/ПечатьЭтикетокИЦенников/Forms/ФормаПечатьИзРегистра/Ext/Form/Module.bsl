#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗаполнитьТаблицуПакетовЗагрузки();
	
КонецПроцедуры

&НаКлиенте
Процедура ПакетыПриАктивизацииСтроки(Элемент)
	УстановитьОтборПоПакетуЗагрузки();
КонецПроцедуры

&НаКлиенте
Процедура ПакетыЗагрузкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ЗаполнитьТаблицуТоваровПоПакету(Элемент.ТекущиеДанные.НомерПакета);
	
	Закрыть(СтруктураТоваров);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработкаКомандФормы

&НаКлиенте
Процедура ЗаполнитьТаблицуЗначенийТоваров(Команда)
	
	ЗаполнитьТаблицуЗначенийТоваровНаСервере();
	
	Закрыть(СтруктураТоваров);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура УстановитьОтборПоПакетуЗагрузки();
	
	Если ЗначениеЗаполнено(ПакетыЗагрузки) Тогда
		ТекущиеДанные = Элементы.ПакетыЗагрузки.ТекущиеДанные;
		ОтборПоПакетуЗагрузки = Новый ФиксированнаяСтруктура("НомерПакета", ТекущиеДанные.НомерПакета);
		Элементы.Товары.ОтборСтрок = ОтборПоПакетуЗагрузки;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицуПакетовЗагрузки()
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЦенникиКПечати.ДатаПриема,
	|	Оборудование.Ссылка
	|ИЗ
	|	РегистрСведений.ЦенникиКПечати КАК ЦенникиКПечати
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПодключаемоеОборудование КАК Оборудование
	|		ПО ЦенникиКПечати.ПодключаемоеОборудование = Оборудование.Ссылка");
	
	ТаблицаПакетовЗагрузки = Запрос.Выполнить().Выгрузить();
	
	Для Каждого Строка Из ТаблицаПакетовЗагрузки Цикл
		
		НомерПакета = ТаблицаПакетовЗагрузки.Индекс(Строка) + 1;
		НовыйПакетЗагрузки = ПакетыЗагрузки.Добавить();
		НовыйПакетЗагрузки.Устройство  = Строка.Ссылка;
		НовыйПакетЗагрузки.ДатаПриема  = Строка.ДатаПриема;
		НовыйПакетЗагрузки.НомерПакета = НомерПакета;
		НовыйПакетЗагрузки.Выбран = Истина;
		ЗапросТоваров = Новый Запрос(
		"ВЫБРАТЬ
		|	КОЛИЧЕСТВО(ЦенникиКПечати.Номенклатура) КАК КоличествоНоменклатура,
		|	ЦенникиКПечати.Номенклатура КАК Номенклатура,
		|	ЦенникиКПечати.Характеристика КАК Характеристика,
		|	ЦенникиКПечати.Упаковка КАК Упаковка,
		|	ЦенникиКПечати.ИДЦенника
		|ИЗ
		|	РегистрСведений.ЦенникиКПечати КАК ЦенникиКПечати
		|ГДЕ
		|	ЦенникиКПечати.ДатаПриема = &ДатаПриема
		|	И ЦенникиКПечати.ПодключаемоеОборудование = &ПодключаемоеОборудование
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦенникиКПечати.Характеристика,
		|	ЦенникиКПечати.Упаковка,
		|	ЦенникиКПечати.Номенклатура,
		|	ЦенникиКПечати.ИДЦенника");
		
		ЗапросТоваров.УстановитьПараметр("ДатаПриема", Строка.ДатаПриема);
		ЗапросТоваров.УстановитьПараметр("ПодключаемоеОборудование", Строка.Ссылка);
		Выборка = ЗапросТоваров.Выполнить().Выбрать();
		Таблица = ЗапросТоваров.Выполнить().Выгрузить();
		
		Пока Выборка.Следующий() Цикл
	
			НовыйТовар = Товары.Добавить();
			НовыйТовар.Номенклатура = Выборка.Номенклатура;
			Если ЗначениеЗаполнено(Выборка.Характеристика) Тогда
				НовыйТовар.Характеристика = Выборка.Характеристика;
			КонецЕсли;
			Если ЗначениеЗаполнено(Выборка.Упаковка) Тогда
				НовыйТовар.УпаковкиНоменклатуры = Выборка.Упаковка;
			КонецЕсли;
			НовыйТовар.НомерПакета = НомерПакета;
			НовыйТовар.Количество  = Выборка.КоличествоНоменклатура;
			НовыйТовар.ИДЦенника   = Выборка.ИДЦенника;
		
		КонецЦикла
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере 
Процедура ЗаполнитьТаблицуЗначенийТоваровНаСервере()
	
	Для Каждого Строка Из ПакетыЗагрузки Цикл
		
		Если Строка.Выбран Тогда
			
			ЗаполнитьТаблицуТоваровПоПакету(Строка.НомерПакета);
			
		КонецЕсли;
		
	КонецЦикла
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицуТоваровПоПакету(НомерПакета)
	
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("НомерПакета",          НомерПакета);
	
	НайденныеСтроки = Товары.НайтиСтроки(ПараметрыОтбора);
	
	Индекс = 0;
	
	Для Каждого Строка Из НайденныеСтроки Цикл
		
		ОтборПоТоварам = Новый Структура;
		ОтборПоТоварам.Вставить("Номенклатура",         НайденныеСтроки[Индекс].Номенклатура);
		ОтборПоТоварам.Вставить("Характеристика",       НайденныеСтроки[Индекс].Характеристика);
		ОтборПоТоварам.Вставить("УпаковкиНоменклатуры", НайденныеСтроки[Индекс].УпаковкиНоменклатуры);
		ПометитьЗаписьКУдалению(НайденныеСтроки[Индекс].ИДЦенника);
		Строки = СтруктураТоваров.НайтиСтроки(ОтборПоТоварам);
		Если ЗначениеЗаполнено(Строки) Тогда
			Строки[0].Количество = Строки[0].Количество + НайденныеСтроки[Индекс].Количество;
		Иначе
			НоменклатураТоваров = СтруктураТоваров.Добавить();
			НоменклатураТоваров.Номенклатура         = НайденныеСтроки[Индекс].Номенклатура;
			НоменклатураТоваров.Характеристика       = НайденныеСтроки[Индекс].Характеристика;
			НоменклатураТоваров.УпаковкиНоменклатуры = НайденныеСтроки[Индекс].УпаковкиНоменклатуры;
			НоменклатураТоваров.Количество           = НайденныеСтроки[Индекс].Количество;
		КонецЕсли;
		Индекс = Индекс + 1;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ПометитьЗаписьКУдалению(ИДЦенника)
	
	ЗаписиРегистра = РегистрыСведений.ЦенникиКПечати.СоздатьНаборЗаписей();
	ЗаписиРегистра.Отбор.ИДЦенника.Установить(ИДЦенника);
	ЗаписиРегистра.Прочитать();
	
	Для Каждого Запись Из ЗаписиРегистра Цикл
		
		Запись.КУдалению = Истина;
		
	КонецЦикла;
	
	ЗаписиРегистра.Записать();
	
КонецПроцедуры

#КонецОбласти
