
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ДанныеОтборов = ПолучитьИзВременногоХранилища(Параметры.АдресДанныеОтборов);
	ПредопределенныеОтборы = ПолучитьИзВременногоХранилища(Параметры.АдресПредопределенныеОтборы);
	ДоступныеОтборыТЗ = ПолучитьИзВременногоХранилища(Параметры.АдресДоступныеОтборы);
	
	ПредопределенныеОтборыПоУмолчанию = Параметры.АдресПредопределенныеОтборыПоУмолчанию;
	ТекущиеОтборы = Параметры.АдресДанныеОтборов;
	
	Если Параметры.ИмяРеквизитаСписка = "Список" Тогда
		ИмяРеквизитаСписка = "";
	Иначе
		ИмяРеквизитаСписка = Параметры.ИмяРеквизитаСписка + "_";
	КонецЕсли;
	
	Если ДанныеОтборов = Неопределено Или ДанныеОтборов.Количество() = 0 Тогда
		Для каждого ПредопределенныйОтбор Из ПредопределенныеОтборы Цикл
			
			Если Не ПредопределенныйОтбор.Выбран Тогда
				Продолжить;
			КонецЕсли;
			
			НовыйОтбор = ВыбранныеОтборы.Добавить();
			ЗаполнитьЗначенияСвойств(НовыйОтбор, ПредопределенныйОтбор);
			Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
			ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
			Иначе
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
			КонецЕсли;
			НовыйОтбор.КартинкаПоля = 1;
			НовыйОтбор.Выбран = Истина;
			
			Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
				НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
			Иначе
				// АПК:1036-выкл проверка орфографии не требуется
				НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
				// АПК:1036-вкл
			КонецЕсли;
			
		КонецЦикла;
		
	Иначе
		
		Для каждого Отбор Из ДанныеОтборов Цикл
			
			Если Не Отбор.Выбран Тогда
				Продолжить;
			КонецЕсли;
			
			НовыйОтбор = ВыбранныеОтборы.Добавить();
			ЗаполнитьЗначенияСвойств(НовыйОтбор, Отбор);
			
			Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
			ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
			Иначе
				НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
			КонецЕсли;
			НовыйОтбор.КартинкаПоля = 1;
			НовыйОтбор.Выбран = Истина;
			
			Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
				НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
			Иначе
				// АПК:1036-выкл проверка орфографии не требуется
				НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
				// АПК:1036-вкл
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ДоступныеОтборыДерево = РеквизитФормыВЗначение("ДоступныеОтборы");
	ПреобразоватьВДеревоРекурсия(ДоступныеОтборыДерево, ДоступныеОтборыТЗ);
	ЗначениеВРеквизитФормы(ДоступныеОтборыДерево, "ДоступныеОтборы");
	
	Если ОбщегоНазначенияКлиентСервер.ЭтоМобильныйКлиент() Тогда
		Элементы.ГруппаКнопкиДобавленияИУдаленияФильтров.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ДоступныеОтборыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если Элемент.ТекущиеДанные.Выбран Или Элемент.ТекущиеДанные.Таблица Тогда
		Возврат;
	КонецЕсли;
	
	Элемент.ТекущиеДанные.Выбран = Истина;
	Элемент.ТекущиеДанные.Доступен = Ложь;
	
	НовыйОтбор = ВыбранныеОтборы.Добавить();
	ЗаполнитьЗначенияСвойств(НовыйОтбор, Элемент.ТекущиеДанные);
	
	Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
		НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
	ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
		НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
	Иначе
		НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
	КонецЕсли;
	
	Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
		НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
	Иначе
		// АПК:1036-выкл проверка орфографии не требуется
		НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
		// АПК:1036-вкл
	КонецЕсли;

	НовыйОтбор.КартинкаПоля = 1;
	НовыйОтбор.Выбран = Истина;

КонецПроцедуры

&НаКлиенте
Процедура ВыбранныеОтборыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если Поле.Имя = "ВыбранныеОтборыКартинкаРежимаВыбораГруппы" Тогда
	
		
		Если Элемент.ТекущиеДанные.КартинкаРежимаВыбораГруппы = 0 Тогда
			
			Элемент.ТекущиеДанные.ВключенРежимВыбораГрупп = Ложь;
			Элемент.ТекущиеДанные.КартинкаРежимаВыбораГруппы = 1;
			Элемент.ТекущиеДанные.Заголовок = СтрЗаменить(Элемент.ТекущиеДанные.Заголовок, " (Группа)", "");
			Элемент.ТекущиеДанные.Поле = СтрЗаменить(Элемент.ТекущиеДанные.Поле, ".Родитель", "");
			
		ИначеЕсли Элемент.ТекущиеДанные.КартинкаРежимаВыбораГруппы = 1 Тогда
			
			Элемент.ТекущиеДанные.ВключенРежимВыбораГрупп = Истина;
			Элемент.ТекущиеДанные.КартинкаРежимаВыбораГруппы = 0;
			Элемент.ТекущиеДанные.Заголовок = Элемент.ТекущиеДанные.Заголовок + НСтр("ru=' (Группа)'");
			Элемент.ТекущиеДанные.Поле = Элемент.ТекущиеДанные.Поле + ".Родитель";
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбранныеОтборыПередУдалением(Элемент, Отказ)
	
	СтрокиДляУдаления = Элемент.ВыделенныеСтроки;
	УдалитьВыбранныеОтборы(СтрокиДляУдаления);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбранныеОтборыПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)
	
	Если ПараметрыПеретаскивания.Значение.Количество()> 0 Тогда
		Если ТипЗнч(ПараметрыПеретаскивания.Значение[0]) = Тип("Число") Тогда
			 Возврат
		КонецЕсли;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	Для каждого Отбор Из ПараметрыПеретаскивания.Значение Цикл
		
		Если Отбор.Выбран Или Отбор.Таблица Тогда
			Продолжить;
		КонецЕсли;
		
		Отбор.Выбран = Истина;
		Отбор.Доступен = Ложь;
		
		Если Строка = Неопределено Тогда
			Строка = ВыбранныеОтборы.Количество();
			НовыйОтбор = ВыбранныеОтборы.Вставить(Строка);
		Иначе
			СтрокаВыбранныеОтборы = ВыбранныеОтборы.НайтиПоИдентификатору(Строка);
			НовыйОтбор = ВыбранныеОтборы.Вставить(ВыбранныеОтборы.Индекс(СтрокаВыбранныеОтборы)+1);
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(НовыйОтбор, Отбор);
		
		Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
		ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
		Иначе
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
		КонецЕсли;
		
		Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
			НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
		Иначе
			// АПК:1036-выкл проверка орфографии не требуется
			НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
			// АПК:1036-вкл
		КонецЕсли;
		
		НовыйОтбор.КартинкаПоля = 1;
		НовыйОтбор.Выбран = Истина;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗавершитьРедактирование(Команда)
	
	Закрыть(ПараметрыЗакрытия());
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьОтбор(Команда)
	
	МассивВыделенныеСтроки = Элементы.ДоступныеОтборы.ВыделенныеСтроки;
	
	Для каждого ВыделеннаяСтрокаИД Из МассивВыделенныеСтроки Цикл
	
		Строка = ДоступныеОтборы.НайтиПоИдентификатору(ВыделеннаяСтрокаИД);
		
		Если Строка.Выбран Или Строка.Таблица Тогда
			Продолжить;
		КонецЕсли;
		
		Строка.Доступен = Ложь;
		Строка.Выбран = Истина;
		
		НовыйОтбор = ВыбранныеОтборы.Добавить();
		ЗаполнитьЗначенияСвойств(НовыйОтбор, Строка);
		
		Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
		ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
		Иначе
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
		КонецЕсли;
		
		Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
			НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
		Иначе
			// АПК:1036-выкл проверка орфографии не требуется
			НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
			// АПК:1036-вкл
		КонецЕсли;
		
		НовыйОтбор.КартинкаПоля = 1;
		НовыйОтбор.Выбран = Истина;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСтандартныеНастройки(Команда)
	
	УстановитьПредопределенныеОтборы();
	
КонецПроцедуры

#КонецОбласти 

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ПреобразоватьВДеревоРекурсия(Дерево, тТаблица, Идентификатор = "", ИдентификаторПоля = 0)
	
	тПоиск = Новый Структура("РодительИдентификатор", Идентификатор);
	тМассив = тТаблица.НайтиСтроки(тПоиск);
	
	Для Каждого стр Из тМассив Цикл
		новаяСтрока = Дерево.Строки.Добавить();
		ЗаполнитьЗначенияСвойств(новаяСтрока, стр);
		
		НайденныйОтборМассив = ВыбранныеОтборы.НайтиСтроки(Новый Структура("ИмяОтбора", новаяСтрока.ИмяОтбора));
		Если НайденныйОтборМассив.Количество() > 0 Тогда
			НайденныйОтборМассив[0].ИдентификаторПоля = ИдентификаторПоля;
		КонецЕсли;
		новаяСтрока.ИдентификаторПоля = ИдентификаторПоля;
		
		ИдентификаторПоля = ИдентификаторПоля + 1;
		
		ПреобразоватьВДеревоРекурсия(новаяСтрока, тТаблица, стр.Идентификатор, ИдентификаторПоля);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПараметрыЗакрытия()

	СтруктураПараметров = Новый Структура;
	
	ВыбранныеОтборыТЗ = РеквизитФормыВЗначение("ВыбранныеОтборы");
	
	УдаленныеОтборыМассив = ПолучитьУдаленныеОтборы(ВыбранныеОтборыТЗ);
	
	АдресВыбранныеОтборы = ПоместитьВоВременноеХранилище(ВыбранныеОтборыТЗ, Новый УникальныйИдентификатор);
	АдресУдаленныеОтборы = ПоместитьВоВременноеХранилище(УдаленныеОтборыМассив, Новый УникальныйИдентификатор);
	
	СтруктураПараметров.Вставить("АдресВыбранныеОтборы", АдресВыбранныеОтборы);
	СтруктураПараметров.Вставить("АдресУдаленныеОтборы", АдресУдаленныеОтборы);
	
	Возврат СтруктураПараметров

КонецФункции

&НаСервере
Процедура УдалитьВыбранныеОтборы(Строки)
	
	Для каждого СтрокаИД Из Строки Цикл
		Строка = ВыбранныеОтборы.НайтиПоИдентификатору(СтрокаИД);
		
		СтрокаДерева = ДоступныеОтборы.НайтиПоИдентификатору(Строка.ИдентификаторПоля);
		
		Если СтрокаДерева <> Неопределено Тогда
			СтрокаДерева.Доступен = Истина;
			СтрокаДерева.Выбран = Ложь;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьПредопределенныеОтборы()
	
	ДоступныеОтборыДерево = РеквизитФормыВЗначение("ДоступныеОтборы");
	
	Для каждого ВыбранныйОтбор Из ВыбранныеОтборы Цикл
		СтрокаДерева = ДоступныеОтборы.НайтиПоИдентификатору(ВыбранныйОтбор.ИдентификаторПоля);
		Если СтрокаДерева <> Неопределено Тогда
			СтрокаДерева.Доступен = Истина;
			СтрокаДерева.Выбран = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	ВыбранныеОтборы.Очистить();
	
	ПредопределенныеОтборы = ПолучитьИзВременногоХранилища(ПредопределенныеОтборыПоУмолчанию);
	
	ЭлементыДерева = ДоступныеОтборы.ПолучитьЭлементы();
	
	Для каждого ПредопределенныйОтбор Из ПредопределенныеОтборы Цикл
		
		ВыбраннаяСтрока = ДоступныеОтборыДерево.Строки.НайтиСтроки(Новый Структура("ИмяОтбора, ЭтоПредопределенныйОтбор", ПредопределенныйОтбор.ИмяОтбора, Истина));
		
		Если ВыбраннаяСтрока.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		НовыйОтбор = ВыбранныеОтборы.Добавить();
		ЗаполнитьЗначенияСвойств(НовыйОтбор, ВыбраннаяСтрока[0]);
		
		Если НовыйОтбор.ДоступенРежимВыбораГрупп И НовыйОтбор.ВключенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 0;
		ИначеЕсли НовыйОтбор.ДоступенРежимВыбораГрупп Тогда
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 1;
		Иначе
			НовыйОтбор.КартинкаРежимаВыбораГруппы = 2;
		КонецЕсли;
		
		НовыйОтбор.КартинкаПоля = 1;
		НовыйОтбор.Выбран = Истина;
			Если НовыйОтбор.ЭтоПредопределенныйОтбор Тогда
				НовыйОтбор.ИмяЭлемента = НовыйОтбор.ИмяОтбора;
			Иначе
				// АПК:1036-выкл проверка орфографии не требуется
				НовыйОтбор.ИмяЭлемента = ИмяРеквизитаСписка + РаботаСОтборамиКлиентСервер.УбратьЗапрещенныеСимволы(НовыйОтбор.ИмяОтбора,"йцукенгшщзхъфывапролджэячсмитьбю_qwertyuiopasdfghjklzxcvbnm01234567890");
				// АПК:1036-вкл
			КонецЕсли;
		
		СтрокаДерева = ДоступныеОтборы.НайтиПоИдентификатору(НовыйОтбор.ИдентификаторПоля);
		Если СтрокаДерева <> Неопределено Тогда
			СтрокаДерева.Доступен = Ложь;
			СтрокаДерева.Выбран = Истина;
		КонецЕсли;

		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьУдаленныеОтборы(ВыбранныеОтборыТЗ)

	УдаленныеОтборыМассив = Новый Массив;
	ТекущиеОтборыТЗ = ПолучитьИзВременногоХранилища(ТекущиеОтборы);
	
	Для каждого ТекущийОтбор Из ТекущиеОтборыТЗ Цикл
		НайденныйОтборМассив = ВыбранныеОтборыТЗ.НайтиСтроки(Новый Структура("ИмяОтбора", ТекущийОтбор.ИмяОтбора));
		Если НайденныйОтборМассив.Количество() = 0 Тогда
			УдаленныеОтборыМассив.Добавить(ТекущийОтбор.ИмяОтбора);
		КонецЕсли;
	КонецЦикла;
	
	Возврат УдаленныеОтборыМассив
	
КонецФункции // ()

#КонецОбласти