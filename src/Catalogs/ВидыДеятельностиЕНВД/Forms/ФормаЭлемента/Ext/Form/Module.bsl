
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.КонтактнаяИнформация
	// УправлениеКонтактнойИнформацией.ПриСозданииНаСервере(ЭтотОбъект, Объект); // для проверки внедрения БСП
	КонтактнаяИнформацияУНФ.ПриСозданииПриЧтенииНаСервере(ЭтотОбъект, , 15);
	// Конец СтандартныеПодсистемы.КонтактнаяИнформация
	
	Если Объект.Ссылка.Пустая() И Не ЗначениеЗаполнено(Объект.Владелец) Тогда
		Объект.Владелец = Параметры.Организация;
	КонецЕсли;
	
	Элементы.ДатаОкончания.Доступность = НЕ Объект.Актуально;
	
	УстановитьВидимостьОКУН();
	СформироватьСтрокуОКУН();
	
	Если Параметры.ОшибкиЗаполнения Тогда
		ПроверкаДанных.ВывестиСообщенияОбОшибкахЗаполнения("Объект", Параметры.ПереченьОшибок);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	// СтандартныеПодсистемы.КонтактнаяИнформация
	// УправлениеКонтактнойИнформацией.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект); // для проверки внедрения БСП
	КонтактнаяИнформацияУНФ.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.КонтактнаяИнформация
	
	СформироватьСтрокуНаименования(ТекущийОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.КонтактнаяИнформация
	// УправлениеКонтактнойИнформацией.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект); // для проверки внедрения БСП
	КонтактнаяИнформацияУНФ.ПриСозданииПриЧтенииНаСервере(ЭтотОбъект, , 15);
	// Конец СтандартныеПодсистемы.КонтактнаяИнформация
	
	// СтандартныеПодсистемы.УправлениеДоступом
	Если ОбщегоНазначения.ПодсистемаСуществует("СтандартныеПодсистемы.УправлениеДоступом") Тогда
		МодульУправлениеДоступом = ОбщегоНазначения.ОбщийМодуль("УправлениеДоступом");
		МодульУправлениеДоступом.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	// СтандартныеПодсистемы.КонтактнаяИнформация
	// УправлениеКонтактнойИнформацией.ОбработкаПроверкиЗаполненияНаСервере(ЭтотОбъект, Объект, Отказ); // для проверки
	// внедрения БСП
	КонтактнаяИнформацияУНФ.ОбработкаПроверкиЗаполненияНаСервере(ЭтотОбъект, Отказ);
	// Конец СтандартныеПодсистемы.КонтактнаяИнформация
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	// СтандартныеПодсистемы.УправлениеДоступом
	УправлениеДоступом.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	Оповестить("ЗаписьВидаДеятельностиЕНВД",Новый Структура("Организация", объект.Владелец));
КонецПроцедуры

&НаКлиенте
Процедура СсылкаЗаполненияОКУННажатие(Элемент)
	
	МассивОкунов = Новый Массив;
	Для Каждого Строка Из Объект.ЗначенияОКУН Цикл
		МассивОкунов.Добавить(Строка.ОКУН);
	КонецЦикла;
	
	МассивОкуновФ = Новый ФиксированныйМассив(МассивОкунов);
	
	ОткрытьФорму(
		"Справочник.ВидыДеятельностиЕНВД.Форма.ФормаПодбораОКУН",
		Новый Структура("МассивОКУНОВ,КодПД",
			МассивОкунов,
			ПолучитьКодВидаПредпринимательскойДеятельности(Объект.ВидПредпринимательскойДеятельности)),
		ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидПредпринимательскойДеятельностиПриИзменении(Элемент)
	
	ВидДеятельностиПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура КодНалоговогоОрганаПолучателяПриИзменении(Элемент)
	Если ЗначениеЗаполнено(Объект.КодНалоговогоОрганаПолучателя) Тогда
		ВыполнитьЗаполнениеСведенийОНалоговойИнспекции();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура АктуальноПриИзменении(Элемент)
	Элементы.ДатаОкончания.Доступность = НЕ Объект.Актуально;
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	Если ИсточникВыбора.ИмяФормы = "Справочник.ВидыДеятельностиЕНВД.Форма.ФормаПодбораОКУН" Тогда
		Объект.ЗначенияОКУН.Очистить();
		Для Каждого Элемент Из ВыбранноеЗначение Цикл
			Найденные = Объект.ЗначенияОКУН.НайтиСтроки(Новый Структура("ОКУН", Элемент));
			Если Найденные.Количество() > 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Объект.ЗначенияОКУН.Добавить().ОКУН = Элемент;
			
		КонецЦикла;
		СформироватьСтрокуОКУН();
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВидДеятельностиПриИзмененииНаСервере()
	
	СформироватьСтрокуНаименования(Объект);
	УстановитьВидимостьОКУН();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьОКУН()
	
	Если Объект.ВидПредпринимательскойДеятельности.Пустая() Тогда
		Элементы.СсылкаЗаполненияОКУН.Видимость = Ложь;
	КонецЕсли;
	
	КодВида = Объект.ВидПредпринимательскойДеятельности.Код;
	
	Если КодВида = "01"
		ИЛИ КодВида = "02"
		ИЛИ КодВида = "03" Тогда
		
		Элементы.СсылкаЗаполненияОКУН.Видимость = Истина;
	Иначе
		Элементы.СсылкаЗаполненияОКУН.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры 

&НаСервере
Процедура СформироватьСтрокуОКУН()
	
	Если Объект.ЗначенияОКУН.Количество() = 0 Тогда
		Элементы.СсылкаЗаполненияОКУН.Заголовок = (НСтр("ru='<<Заполнить ОКУН>>'"));
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ОКУН.Код КАК Код
	|ИЗ
	|	Справочник.ОКУН КАК ОКУН
	|ГДЕ
	|	ОКУН.Ссылка В(&Ссылки)");
	
	Запрос.УстановитьПараметр("Ссылки", Объект.ЗначенияОКУН.Выгрузить().ВыгрузитьКолонку("ОКУН"));
	Выборка = Запрос.Выполнить().Выгрузить();
	РезСтрока = НСтр("ru='ОКУН: '");
	Если Выборка.Количество() < 4 Тогда
		Для Каждого Строка Из Выборка Цикл
			РезСтрока = РезСтрока+Строка.Код+"; ";
		КонецЦикла;
	Иначе
		РезСтрока = 
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Выбрано %1 кода ОКУН'"),
				Выборка.Количество() );
				
				
	КонецЕсли;
	
	Элементы.СсылкаЗаполненияОКУН.Заголовок = РезСтрока;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура СформироватьСтрокуНаименования(Объект)
	
	
	Если Объект.КонтактнаяИнформация.Количество()>0 Тогда
		
		Представление = УправлениеКонтактнойИнформацией.ПредставлениеКонтактнойИнформации(
			Объект.КонтактнаяИнформация[0].Значение);
			
		
	КонецЕсли;
	
	Объект.Наименование = ?(ПустаяСтрока(Представление), "", Представление + ", ") + Сред(
		Объект.ВидПредпринимательскойДеятельности, 6);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьЗаполнениеСведенийОНалоговойИнспекции()
	
	ОписаниеОшибки = "";
	ЗаполнитьСведенияОНалоговойИнспекцииПоКоду(ОписаниеОшибки);
	
	// Обработка ошибок
	Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Если ОписаниеОшибки = "НеУказаныПараметрыАутентификации" Тогда
			
			ТекстВопроса = НСтр("ru='Для автоматического создания налогового органа
				|в справочнике «Контрагенты» необходимо подключиться к Интернет-поддержке
				|пользователей. Данные по налоговому органу пригодятся при уплате налогов.
				|Подключиться сейчас?'");
				
			ПараметрыВопроса = Новый Структура("ВызовПослеПодключения", "ЗаполнитьСведенияОНалоговойИнспекцииПоКоду");
			ОписаниеОповещения = Новый ОписаниеОповещения("ПодключитьИнтернетПоддержку", ЭтотОбъект, ПараметрыВопроса);
			ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
			
		Иначе
			ПоказатьПредупреждение(, ОписаниеОшибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСведенияОНалоговойИнспекцииПоКоду(ОписаниеОшибки = "")
	
	Если НЕ ЗначениеЗаполнено(Объект.КодНалоговогоОрганаПолучателя) Тогда
		Возврат;
	КонецЕсли;
	
	РеквизитыНалоговогоОргана = ДанныеГосударственныхОрганов.РеквизитыНалоговогоОрганаПоКоду(
		Объект.КодНалоговогоОрганаПолучателя);
	
	Если ЗначениеЗаполнено(РеквизитыНалоговогоОргана.ОписаниеОшибки) Тогда
		ОписаниеОшибки = РеквизитыНалоговогоОргана.ОписаниеОшибки;
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РеквизитыНалоговогоОргана.Ссылка) Тогда
		ДанныеГосударственныхОрганов.ОбновитьДанныеГосударственногоОргана(РеквизитыНалоговогоОргана);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодключитьИнтернетПоддержку(Ответ, ДополнительныеПараметры) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		
		Оповещение = Новый ОписаниеОповещения("ПодключитьИнтернетПоддержкуЗавершение", ЭтотОбъект,
			ДополнительныеПараметры);
		ИнтернетПоддержкаПользователейКлиент.ПодключитьИнтернетПоддержкуПользователей(Оповещение, ЭтотОбъект);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПодключитьИнтернетПоддержкуЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		
		Если ДополнительныеПараметры.Свойство("ВызовПослеПодключения") Тогда
			
			Если ДополнительныеПараметры.ВызовПослеПодключения = "ЗаполнитьСведенияОНалоговойИнспекцииПоКоду" Тогда
				
				ЗаполнитьСведенияОНалоговойИнспекцииПоКоду();
				
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьКодВидаПредпринимательскойДеятельности(Деятельность)
	Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Деятельность,"Код");
КонецФункции

&НаКлиенте
Процедура Декорация8ОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ПустаяСтрока(Объект.КодНалоговогоОрганаПолучателя) Тогда
		ОбщегоНазначенияКлиент.СообщитьПользователю(
			НСтр("ru='Заполните код ИФНС и мы тогда сможем определить ссылку для поиска'"),
			,
			"Объект.КодНалоговогоОрганаПолучателя");
		Возврат;
	КонецЕсли;
	
	АдресСайтаНалоговой = "http://www.nalog.ru/rn"+Лев(Объект.КодНалоговогоОрганаПолучателя, 2)+"/";
	ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку(АдресСайтаНалоговой);
	
	
КонецПроцедуры

#Область СлужебныеПроцедурыИФункции

#Область КонтактнаяИнформацияУНФ

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияНажатие(Элемент, СтандартнаяОбработка)
	
	// Передаем в списке Значение ОКАТО и ИФНС
	Отбор = Новый Структура("ИмяРеквизита", Элемент.Имя);
	Строки = ЭтотОбъект["КонтактнаяИнформацияОписаниеДополнительныхРеквизитов"].НайтиСтроки(Отбор);
	Если Строки.Количество() > 0 Тогда
		СтрДанные = Строки[0];
		Список = СтрДанные.Значение;
	КонецЕсли;
	
	УправлениеКонтактнойИнформациейКлиент.НачалоВыбора(ЭтотОбъект, Элемент, Модифицированность, СтандартнаяОбработка);
	
	Строки = ЭтотОбъект["КонтактнаяИнформацияОписаниеДополнительныхРеквизитов"].НайтиСтроки(Отбор);
	
	Если Строки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Результат = СтруктураАдреса( Строки[0].Значение);
	// получаем город
	Город = Результат.Город;
	НазваниеРегиона = Результат.Регион;
	НаселенныйПункт = Результат.НаселенныйПункт;
	
	// по приоритету
	Если НЕ ПустаяСтрока(НаселенныйПункт) Тогда
		Город = НаселенныйПункт;
	ИначеЕсли НЕ ПустаяСтрока(Город) Тогда
		Город = Город;
	ИначеЕсли НЕ ПустаяСтрока(НазваниеРегиона) Тогда
		Город = НазваниеРегиона;
	КонецЕсли;
	
	Объект.Наименование = 
		?(ПустаяСтрока(Город),"",Город+", ")+
		Сред(Объект.ВидПредпринимательскойДеятельности, 6);
	
	ОбновитьОтображениеДанных(); 
	
КонецПроцедуры

&НаСервере
Функция СтруктураАдреса(Адрес)
	Возврат  РаботаСАдресами.СведенияОбАдресе(Адрес);
КонецФункции

&НаСервере
Процедура ДобавитьКонтактнуюИнформациюСервер(ДобавляемыйВид, УстановитьВыводВФормеВсегда = Ложь) Экспорт
	
	КонтактнаяИнформацияУНФ.ДобавитьКонтактнуюИнформацию(ЭтотОбъект, ДобавляемыйВид, УстановитьВыводВФормеВсегда);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ДействиеКИНажатие(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.ДействиеКИНажатие(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИПриИзменении(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИПриИзменении(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИНачалоВыбора(ЭтотОбъект, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИОчистка(Элемент, СтандартнаяОбработка)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИОчистка(ЭтотОбъект, Элемент, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомментарийКИПриИзменении(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.КомментарийКИПриИзменении(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияУНФВыполнитьКоманду(Команда)
	
	КонтактнаяИнформацияУНФКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
	
	Если Истина Тогда
		
		КонтактнаяИнформацияУНФКлиент.АвтоПодбор(Текст, ДанныеВыбора, СтандартнаяОбработка);
		
	Иначе
		
		// вызов оставлен для проверки внедрения БСП
		УправлениеКонтактнойИнформациейКлиент.АвтоПодборАдреса(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных,
			Ожидание, СтандартнаяОбработка);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если Истина Тогда
		
		КонтактнаяИнформацияУНФКлиент.ОбработкаВыбора(ЭтотОбъект, ВыбранноеЗначение, Элемент, СтандартнаяОбработка);
		
	Иначе
		
		// вызов оставлен для проверки внедрения БСП
		УправлениеКонтактнойИнформациейКлиент.ОбработкаВыбора(ЭтотОбъект, ВыбранноеЗначение, Элемент.Имя, СтандартнаяОбработка);
		
	КонецЕсли;
	
КонецПроцедуры

#Область ПроверкаВнедренияБСП
// СтандартныеПодсистемы.КонтактнаяИнформация
&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияПриИзменении(Элемент)
	Если 1=0 Тогда
		УправлениеКонтактнойИнформациейКлиент.ПриИзменении(ЭтотОбъект, Элемент);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	Если 1=0 Тогда
		УправлениеКонтактнойИнформациейКлиент.НачалоВыбора(ЭтотОбъект, Элемент, , СтандартнаяОбработка);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияПриНажатии(Элемент, СтандартнаяОбработка)
	Если 1=0 Тогда
		УправлениеКонтактнойИнформациейКлиент.НачалоВыбора(ЭтотОбъект, Элемент, , СтандартнаяОбработка);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияОчистка(Элемент, СтандартнаяОбработка)
	Если 1=0 Тогда
		УправлениеКонтактнойИнформациейКлиент.Очистка(ЭтотОбъект, Элемент.Имя);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияВыполнитьКоманду(Команда)
	Если 1=0 Тогда
		УправлениеКонтактнойИнформациейКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда.Имя);
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура Подключаемый_ОбновитьКонтактнуюИнформацию(Результат) Экспорт
	Если 1=0 Тогда
		УправлениеКонтактнойИнформацией.ОбновитьКонтактнуюИнформацию(ЭтотОбъект, Объект, Результат);
	КонецЕсли;
КонецПроцедуры
// Конец СтандартныеПодсистемы.КонтактнаяИнформация

#КонецОбласти

#КонецОбласти

#КонецОбласти

