
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Запись.СпособПередачиТоваров)
		ИЛИ Элементы.СпособПередачиТоваров.СписокВыбора.НайтиПоЗначению(Запись.СпособПередачиТоваров) = Неопределено Тогда
		// Заполнение по умолчанию
		Запись.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.НеПередается;
	КонецЕсли;
	
	Если Запись.СпособПередачиТоваров <> Перечисления.СпособыПередачиТоваров.НеПередается
		И ЗначениеЗаполнено(Запись.ИсходныйКлючЗаписи.ОрганизацияВладелец)
		И РегистрыСведений.НастройкаПередачиТоваровМеждуОрганизациями.ЕстьНезакрытыеРезервы(Запись.ОрганизацияВладелец, Запись.ОрганизацияПродавец) Тогда
		ТолькоПросмотр = Истина;
		КлючСохраненияПоложенияОкна = "РегистрСведений.НастройкаПередачиТоваровМеждуОрганизациями.ФормаЗаписи.ВариантСПредупреждением";
	Иначе
		Если Запись.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.НеПередается Тогда
			КлючСохраненияПоложенияОкна = "РегистрСведений.НастройкаПередачиТоваровМеждуОрганизациями.ФормаЗаписи.ВариантБезПередачи";
		КонецЕсли; 
		Элементы.ГруппаПредупрежденияРезервы.Видимость = Ложь;
	КонецЕсли;
	УправлениеЭлементамиФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Если ОписаниеОповещенияОЗакрытии <> Неопределено Тогда
		ВыполнитьОбработкуОповещения(ОписаниеОповещенияОЗакрытии, Запись);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	ОписаниеОповещенияОЗакрытии = Неопределено;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СпособПередачиТоваровПриИзменении(Элемент)
	
	СпособПередачиТоваровПриИзмененииСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ПараметрыФормы = ПолучитьПараметрыФормыВыбора(Запись.ОрганизацияВладелец, Запись.ОрганизацияПродавец, Запись.Договор);
	Если ПараметрыФормы.КонтролироватьВыборДоговора Тогда
		СтандартнаяОбработка = Ложь;
		ОткрытьФорму("Справочник.ДоговорыКонтрагентов.ФормаВыбора", ПараметрыФормы, Элемент);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область УправлениеЭлементамиФормы

&НаСервере
Процедура УправлениеЭлементамиФормы()
	
	Элементы.Валюта.Видимость = (Запись.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.ПередачаНаКомиссию)
		И ПолучитьФункциональнуюОпцию("УчетВалютныхОпераций");
	Элементы.ВидЦены.Видимость = (Запись.СпособПередачиТоваров <> Перечисления.СпособыПередачиТоваров.НеПередается);
	Элементы.Договор.Видимость = (Запись.СпособПередачиТоваров <> Перечисления.СпособыПередачиТоваров.НеПередается);
	
КонецПроцедуры

#КонецОбласти

#Область Прочее

&НаСервере
Процедура СпособПередачиТоваровПриИзмененииСервер()
	
	Если Запись.СпособПередачиТоваров <> Перечисления.СпособыПередачиТоваров.ПередачаНаКомиссию Тогда
		Запись.Валюта = Неопределено;
	КонецЕсли;
	
	Если Запись.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.НеПередается Тогда
		Запись.ВидЦены = Неопределено;
	КонецЕсли;
	
	Запись.Договор = Неопределено;
	
	УправлениеЭлементамиФормы();
	
КонецПроцедуры

&НаСервере
Процедура ДоговорПриИзмененииНаСервере()
	
	Если ЗначениеЗаполнено(Запись.Договор) Тогда
		ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Запись.Договор, "ВидЦен, ВалютаРасчетов");
		Запись.ВидЦены = ЗначенияРеквизитов.ВидЦен;
		Запись.Валюта = ЗначенияРеквизитов.ВалютаРасчетов;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорПриИзменении(Элемент)
	
	ДоговорПриИзмененииНаСервере();
	
КонецПроцедуры

&НаСервере
Функция ПолучитьПараметрыФормыВыбора(Организация, Контрагент, Договор)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("КонтролироватьВыборДоговора", Истина);
	ПараметрыФормы.Вставить("Контрагент", Контрагент);
	ПараметрыФормы.Вставить("Организация", Организация);
	ПараметрыФормы.Вставить("ТекущаяСтрока", Договор);
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	
	Возврат ПараметрыФормы;
	
КонецФункции

#КонецОбласти

#КонецОбласти
