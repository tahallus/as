
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныйПрограммныйИнтерфейс

// Обработчик обновления БЭД 1.7.1
//
// Получает из РС.СловарьНоменклатурыХарактеристикиБЭД количество различных слов используемых в словаре и заносит в статистику.
// 
// Параметры:
//  Параметры - Структура из см. ОбновлениеИнформационнойБазы.ОсновныеПараметрыОтметкиКОбработке
//
Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	Если НЕ ОбновлениеИнформационнойБазы.ОбъектОбработан(Метаданные.РегистрыСведений.СловарьСопоставленияНоменклатурыБЭД.ПолноеИмя()).Обработан Тогда
		Параметры.ОбработкаЗавершена = Ложь;
		Возврат;
	КонецЕсли;
	
	ЕстьОтработанныеЗаписи = Ложь;
	ПроизошлаОшибка        = Ложь;
	ТекстСообщения         = "";
	
	ЗаписатьНаборСловВСтатистикуСловСловаря(Перечисления.ТипОбъектаСопоставленияНоменклатурыБЭД.Номенклатура,
		ЕстьОтработанныеЗаписи, ПроизошлаОшибка, ТекстСообщения);
	ЗаписатьНаборСловВСтатистикуСловСловаря(Перечисления.ТипОбъектаСопоставленияНоменклатурыБЭД.Характеристика,
		ЕстьОтработанныеЗаписи, ПроизошлаОшибка, ТекстСообщения);
	
	Если НЕ ЕстьОтработанныеЗаписи И ПроизошлаОшибка Тогда
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
		
	Параметры.ОбработкаЗавершена = ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Параметры.Очередь,
		Метаданные.РегистрыСведений.СтатистикаСловСловаряСопоставленияНоменклатурыБЭД.ПолноеИмя());
		
КонецПроцедуры
	
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаписатьНаборСловВСтатистикуСловСловаря(Знач ТипОбъекта, ЕстьОтработанныеЗаписи, ПроизошлаОшибка, ТекстСообщения)
	
	Результат = СопоставлениеНоменклатурыКонтрагентовСлужебный.ПолучитьНесоответствияСтатистикиСловИспользованияВСловареСопоставленияНоменклатурыБЭД(ТипОбъекта);
	
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		НачатьТранзакцию();
		Попытка
			
			НаборЗаписейСтатистикиСлов = СопоставлениеНоменклатурыКонтрагентовСлужебный.ЗаполнитьНаборЗаписейСтатистикиСловВСловаре(Выборка, ТипОбъекта);
			ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписейСтатистикиСлов);
			
			ЕстьОтработанныеЗаписи = Истина;
			ЗафиксироватьТранзакцию();
			
		Исключение
			ОтменитьТранзакцию();
			
			ШаблонСообщения = НСтр("ru = 'Не удалось обработать запись по слову: %1 по причине:'");
			ТекстСообщения  = СтрШаблон(ШаблонСообщения, Выборка.Слово) + Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(), УровеньЖурналаРегистрации.Предупреждение,
				Метаданные.РегистрыСведений.СтатистикаСловСловаряСопоставленияНоменклатурыБЭД, , ТекстСообщения);
			
			ПроизошлаОшибка = Истина;
			
		КонецПопытки;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли